<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#04000a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="–¢–æ–ª—Å—Ç—è–∫ 4.0">
<meta name="format-detection" content="telephone=no">
<meta name="description" content="–¢–æ–ª—Å—Ç—è–∫ 4.0 ‚Äî —Ç—Ä–µ–Ω–∏—Ä—É–π—Å—è, —Å–±—Ä–∞—Å—ã–≤–∞–π –≤–µ—Å, –ø–æ–±–µ–∂–¥–∞–π –≤ –±–æ—è—Ö! –ì–∏–ª—å–¥–∏–∏, 30 –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, 30 –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–π.">
<!-- PWA –∏–∫–æ–Ω–∫–∏ (inline SVG –∫–∞–∫ data URI) -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%230a001a'/><text y='.9em' font-size='78' x='10'>üê∑</text></svg>">
<title>–¢–û–õ–°–¢–Ø–ö 4.0 ‚Äî –ü—É—Ç—å –∫ –ø–æ–±–µ–¥–µ!</title>
<style>
/* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã –≤–º–µ—Å—Ç–æ Google Fonts */
@font-face {
  font-family: 'Russo One';
  font-style: normal;
  font-weight: 400;
  src: local('Arial Black'), local('Impact'), local('Arial');
}
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 600;
  src: local('Roboto'), local('Arial'), local('Helvetica');
}
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 700;
  src: local('Roboto Bold'), local('Arial Bold'), local('Helvetica');
}
@font-face {
  font-family: 'Nunito';
  font-style: normal;
  font-weight: 900;
  src: local('Roboto Black'), local('Arial Black'), local('Helvetica');
}
</style>
<style>
:root{
  --pink:#ff3d7f;--purple:#9b00ff;--gold:#ffd700;--green:#00ff88;
  --cyan:#00e5ff;--orange:#ff6b00;--red:#ff2244;
  --bg:#04000a;--card:rgba(255,255,255,0.06);--border:rgba(255,255,255,0.11);
  --r:16px;
  /* –ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–µ–∫ —à—Ä–∏—Ñ—Ç–æ–≤ —Å fallback –¥–ª—è –ª—é–±–æ–≥–æ Android */
  --font:'Russo One','Arial Black','Impact',Arial,sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);color:#fff;font-family:'Nunito',sans-serif;touch-action:manipulation;
  position:fixed;top:0;left:0;right:0;bottom:0;
  -webkit-font-smoothing:antialiased;
  -webkit-text-size-adjust:100%;
  overscroll-behavior:none;
}
#gameCanvas{position:fixed;inset:0;width:100%;height:100%;z-index:0;will-change:transform;}

/* ‚ïê‚ïê‚ïê LOADING SCREEN (Brawl Stars style) ‚ïê‚ïê‚ïê */
#loadScreen{
  position:fixed;inset:0;z-index:9999;
  background:linear-gradient(135deg,#0a0018 0%,#1a0035 50%,#0a0018 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0;
}
.load-logo{font-family:var(--font);font-size:clamp(40px,12vw,80px);color:transparent;background:linear-gradient(135deg,var(--gold) 0%,var(--pink) 55%,var(--purple) 100%);-webkit-background-clip:text;background-clip:text;filter:drop-shadow(0 0 30px #ff3d7f77);letter-spacing:3px;margin-bottom:6px;}
.load-sub{font-size:13px;color:#a78bfa;letter-spacing:4px;text-transform:uppercase;margin-bottom:40px;}
.load-char{font-size:88px;animation:loadBounce 0.7s ease-in-out infinite;margin-bottom:32px;}
@keyframes loadBounce{0%,100%{transform:translateY(0) scale(1);}50%{transform:translateY(-16px) scale(1.07);}}
.load-bar-wrap{width:min(320px,82vw);background:rgba(255,255,255,0.08);border-radius:99px;height:20px;border:2px solid rgba(255,215,0,0.3);overflow:hidden;position:relative;}
.load-bar-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--purple),var(--pink),var(--gold));border-radius:99px;transition:width 0.05s linear;position:relative;}
.load-bar-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.35),transparent);animation:shimmer 1s linear infinite;}
@keyframes shimmer{0%{transform:translateX(-100%);}100%{transform:translateX(400%)}}
.load-pct{font-family:var(--font);font-size:16px;color:var(--gold);margin-top:10px;letter-spacing:2px;}
.load-tip{font-size:11px;color:#555;margin-top:18px;letter-spacing:1px;text-align:center;max-width:280px;}

/* ‚ïê‚ïê‚ïê START SCREEN ‚ïê‚ïê‚ïê */
#startScreen{
  position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0;
  background:radial-gradient(ellipse at 50% 25%, #250050 0%, #04000a 70%);
}
.start-logo{font-family:var(--font);font-size:clamp(38px,11vw,76px);color:transparent;background:linear-gradient(135deg,var(--gold) 0%,var(--pink) 50%,var(--purple) 100%);-webkit-background-clip:text;background-clip:text;filter:drop-shadow(0 0 28px #ff3d7f66);letter-spacing:2px;margin-bottom:4px;line-height:1;}
.start-ver{font-size:11px;color:#a020f0;letter-spacing:3px;text-transform:uppercase;margin-bottom:4px;}
.start-char{font-size:96px;animation:breathe 2.2s ease-in-out infinite;display:block;text-align:center;line-height:1.1;}
.start-char.hit{animation:charHit 0.3s ease-out!important;}
@keyframes charHit{0%{transform:scale(1);}20%{transform:scale(0.82) rotate(-8deg);}60%{transform:scale(1.15) rotate(5deg);}100%{transform:scale(1) rotate(0deg);}}
@keyframes breathe{0%,100%{transform:translateY(0) scale(1);}50%{transform:translateY(-14px) scale(1.05);}}
.start-weight-badge{background:linear-gradient(135deg,#1a0030,#300060);border:2px solid var(--purple);border-radius:99px;padding:8px 22px;font-size:14px;color:#c084fc;font-weight:700;margin-bottom:20px;}
.start-stats{display:flex;gap:12px;margin-bottom:24px;}
.start-stat{background:rgba(255,255,255,0.07);border:1px solid var(--border);border-radius:14px;padding:10px 16px;text-align:center;}
.start-stat b{font-family:var(--font);font-size:18px;color:var(--gold);display:block;}
.start-stat span{font-size:10px;color:#666;}
#startBtn{background:linear-gradient(135deg,var(--pink),var(--purple));border:none;border-radius:20px;padding:18px 56px;color:#fff;font-family:var(--font);font-size:20px;letter-spacing:1px;cursor:pointer;transition:all 0.2s;box-shadow:0 8px 32px #ff3d7f55;position:relative;overflow:hidden;}
#startBtn:active{transform:scale(0.95);}
#startBtn::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transform:translateX(-100%);animation:btnShine 2s ease-in-out infinite;}
@keyframes btnShine{0%,70%{transform:translateX(-100%);}100%{transform:translateX(300%);}}

/* ‚ïê‚ïê‚ïê UI WRAPPER ‚ïê‚ïê‚ïê */
/* pointer-events:none –Ω–∞ —Å–∞–º–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ ‚Äî –∫–ª–∏–∫–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç –Ω–∞ canvas,
   –Ω–æ –¥–æ—á–µ—Ä–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —è–≤–Ω–æ –≤–∫–ª—é—á–µ–Ω—ã –Ω–∏–∂–µ */
#ui{position:fixed;inset:0;z-index:10;pointer-events:none;display:none;}

/* –ù–µ-–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã HUD */
#topHud, #levelBadge, #locBadge, #charTag, #notif, #saveInd {
  pointer-events: none;
}
/* –í—Å–µ –∫–Ω–æ–ø–∫–∏ –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–ª–æ–∏ ‚Äî —è–≤–Ω–æ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã */
#bottomNav, #bottomNav *,
#overlay,
.panel, .panel *,
#miniGame, #miniGame *,
#fightScreen, #fightScreen *,
#pvpScreen, #pvpScreen *,
#guildScreen, #guildScreen *,
#rebirthScreen, #rebirthScreen *,
#dailyPopup, #dailyPopup *,
#timeToast, #timeToast *,
button, a, [onclick] {
  pointer-events: auto !important;
}

/* TOP HUD */
#topHud{position:absolute;top:0;left:0;right:0;display:flex;align-items:center;justify-content:space-between;padding:10px 12px 8px;gap:6px;background:linear-gradient(180deg,rgba(4,0,10,0.97) 0%,transparent 100%);pointer-events:none;}
.hud-block{display:flex;flex-direction:column;gap:3px;}
.hud-label{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:#555;}
.bar-row{display:flex;align-items:center;gap:5px;}
.bar-track{flex:1;height:9px;background:rgba(255,255,255,0.07);border-radius:99px;overflow:hidden;min-width:80px;}
.bar-fill{height:100%;border-radius:99px;transition:width 0.4s cubic-bezier(.4,0,.2,1);}
#weightFill{background:linear-gradient(90deg,#00ff88,#ffd700,#ff3d7f);}
#energyFill{background:linear-gradient(90deg,#ffd700,#ff6b00);}
.bar-val{font-family:var(--font);font-size:10px;color:var(--gold);min-width:44px;text-align:right;}
.hud-chips{display:flex;gap:4px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
.chip{background:rgba(0,0,0,0.65);border:1.5px solid var(--border);border-radius:99px;padding:4px 9px;font-size:11px;font-weight:700;display:flex;align-items:center;gap:3px;}
.chip.gold{border-color:#ffd70044;color:var(--gold);}
.chip.blue{border-color:#4488ff44;color:#82b4ff;}
.chip.red{border-color:#ff3d7f44;color:#ff7aab;}
.chip.pur{border-color:#9b00ff44;color:#c084fc;}

/* LEVEL / REBIRTH badge */
#levelBadge{position:absolute;top:66px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,rgba(155,0,255,0.25),rgba(255,61,127,0.25));border:1.5px solid rgba(155,0,255,0.4);border-radius:99px;padding:4px 14px;font-size:10px;color:#c084fc;white-space:nowrap;pointer-events:none;letter-spacing:1px;transition:opacity 0.3s;}
#levelBadge.hidden,#locBadge.hidden,#charTag.hidden{opacity:0;}

#locBadge{position:absolute;top:88px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.65);border:1px solid var(--border);border-radius:99px;padding:3px 13px;font-size:9px;color:#666;white-space:nowrap;pointer-events:none;}
#charTag{position:absolute;bottom:82px;left:50%;transform:translateX(-50%);pointer-events:none;}
.char-tag-inner{background:rgba(0,0,0,0.75);border:2px solid var(--pink);border-radius:99px;padding:4px 16px;font-size:11px;font-weight:800;color:var(--pink);}
#notif{position:absolute;top:92px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.92);border:1.5px solid var(--green);border-radius:12px;padding:8px 18px;font-size:12px;font-weight:700;color:var(--green);opacity:0;transition:opacity 0.3s;text-align:center;pointer-events:none;max-width:90vw;white-space:nowrap;z-index:50;}
#saveInd{position:absolute;bottom:76px;right:10px;font-size:9px;color:#2a2a2a;pointer-events:none;transition:color 0.4s;}
#saveInd.on{color:var(--green);}

/* ‚ïê‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê */
#bottomNav{position:absolute;bottom:0;left:0;right:0;display:flex;align-items:center;justify-content:space-around;padding:8px 10px calc(max(env(safe-area-inset-bottom, 12px), 12px) + 4px);background:linear-gradient(0deg,rgba(4,0,10,0.98) 0%,rgba(4,0,10,0.75) 60%,transparent 100%);pointer-events:all;}
.nav-btn{display:flex;flex-direction:column;align-items:center;gap:2px;background:none;border:none;cursor:pointer;color:#444;transition:all 0.2s;padding:5px 8px;border-radius:12px;min-width:48px;}
.nav-btn .nb-icon{font-size:24px;transition:transform 0.2s;}
.nav-btn .nb-label{font-size:8px;letter-spacing:1px;text-transform:uppercase;font-weight:700;}
.nav-btn.active,.nav-btn:active{color:var(--pink);}
.nav-btn.active .nb-icon,.nav-btn:active .nb-icon{transform:translateY(-3px);}

/* ‚ïê‚ïê‚ïê OVERLAY ‚ïê‚ïê‚ïê */
#overlay{position:absolute;inset:0;background:rgba(0,0,0,0.0);display:none;pointer-events:all;}
#overlay.open{display:block;}

/* ‚ïê‚ïê‚ïê PANEL ‚ïê‚ïê‚ïê */
.panel{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(145deg,#0b0018,#180030);border:1.5px solid rgba(155,0,255,0.3);border-radius:24px;padding:20px;min-width:320px;max-width:min(480px,95vw);max-height:84vh;overflow-y:auto;pointer-events:all;display:none;scrollbar-width:thin;scrollbar-color:#9b00ff44 transparent;
  -webkit-overflow-scrolling:touch;overscroll-behavior:contain;
}
.panel.open{display:block;animation:panelPop 0.3s cubic-bezier(.34,1.56,.64,1);}
@keyframes panelPop{from{transform:translate(-50%,-50%) scale(0.78);opacity:0;}to{transform:translate(-50%,-50%) scale(1);opacity:1;}}
.panel-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.panel-title{font-family:var(--font);font-size:18px;color:var(--gold);}
.close-btn{background:rgba(255,255,255,0.06);border:1.5px solid var(--border);border-radius:99px;width:32px;height:32px;color:#aaa;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;pointer-events:all;}
.close-btn:hover{background:rgba(255,61,127,0.15);border-color:var(--pink);color:var(--pink);}

/* ‚ïê‚ïê‚ïê TRAIN ‚ïê‚ïê‚ïê */
.train-item{background:var(--card);border:1.5px solid var(--border);border-radius:14px;padding:13px;margin-bottom:10px;cursor:pointer;transition:all 0.2s;pointer-events:all;display:flex;align-items:center;gap:12px;}
.train-item:hover{border-color:var(--pink);background:rgba(255,61,127,0.07);transform:translateX(4px);}
.train-icon{font-size:30px;width:42px;text-align:center;}
.train-info{flex:1;}
.train-name{font-weight:900;font-size:13px;margin-bottom:2px;}
.train-desc{font-size:10px;color:#666;margin-bottom:5px;}
.train-stats{display:flex;gap:5px;flex-wrap:wrap;}
.ts{font-size:10px;padding:2px 8px;border-radius:99px;font-weight:700;}
.ts.e{background:rgba(255,215,0,0.1);color:var(--gold);border:1px solid #ffd70033;}
.ts.w{background:rgba(0,255,136,0.1);color:var(--green);border:1px solid #00ff8833;}
.ts.c{background:rgba(255,61,127,0.1);color:var(--pink);border:1px solid #ff3d7f33;}
.ts.s{background:rgba(155,0,255,0.1);color:#c084fc;border:1px solid #9b00ff33;}

/* ‚ïê‚ïê‚ïê MINI GAME ‚ïê‚ïê‚ïê */
#miniGame{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(0deg,#0b0018 0%,#110022 100%);border-top:2px solid var(--purple);border-radius:28px 28px 0 0;padding:22px 20px 30px;pointer-events:all;display:none;transform:translateY(100%);transition:transform 0.4s cubic-bezier(.34,1.56,.64,1);}
#miniGame.open{display:block;transform:translateY(0);}
.mg-title{font-family:var(--font);font-size:19px;color:#c084fc;margin-bottom:3px;text-align:center;}
.mg-inst{font-size:12px;color:#888;text-align:center;margin-bottom:8px;letter-spacing:1px;}
.mg-bar-track{height:22px;background:rgba(255,255,255,0.06);border-radius:99px;overflow:hidden;margin:10px 0;position:relative;}
.mg-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--green),var(--gold),var(--pink));transition:width 0.12s linear;width:0%;}
.mg-bar-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.25),transparent);animation:shimmer 1s linear infinite;}
.mg-count{font-size:13px;color:var(--gold);font-weight:900;text-align:center;margin-bottom:8px;}
.mg-motiv{font-size:14px;color:#fff;text-align:center;font-weight:900;min-height:20px;margin-bottom:10px;text-shadow:0 0 10px var(--pink);}
.mg-btn-row{display:flex;gap:10px;}
.mg-action-btn{flex:1;padding:16px;border:none;border-radius:16px;color:#fff;font-family:var(--font);font-size:16px;cursor:pointer;letter-spacing:1px;transition:all 0.15s;}
.mg-action-btn:active{transform:scale(0.94);}
.mg-start-btn{background:linear-gradient(135deg,var(--pink),var(--purple));box-shadow:0 4px 20px #ff3d7f44;}
.mg-stop-btn{background:linear-gradient(135deg,#333,#555);}
.mg-result{font-size:14px;font-weight:900;text-align:center;margin-top:8px;min-height:20px;}

/* ‚ïê‚ïê‚ïê SHOP ‚ïê‚ïê‚ïê */
.tabs{display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap;}
.tab-btn{flex:1;min-width:60px;padding:7px 4px;background:var(--card);border:1.5px solid var(--border);border-radius:10px;color:#777;font-family:'Nunito',sans-serif;font-weight:700;font-size:10px;cursor:pointer;transition:all 0.2s;}
.tab-btn.active{background:rgba(155,0,255,0.2);border-color:var(--purple);color:#fff;}
.tab-content{display:none;}
.tab-content.active{display:block;}
.shop-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.shop-item{background:var(--card);border:1.5px solid var(--border);border-radius:13px;padding:11px 9px;text-align:center;cursor:pointer;transition:all 0.18s;position:relative;overflow:hidden;}
.shop-item:hover:not(.owned):not(.cantbuy){border-color:var(--gold);background:rgba(255,215,0,0.06);}
.shop-item:active:not(.cantbuy){transform:scale(0.94);}
.shop-item.owned{border-color:#00ff8844;}
.shop-item.cantbuy{opacity:0.35;cursor:not-allowed;}
.si{font-size:28px;margin-bottom:4px;}.sn{font-size:11px;font-weight:800;margin-bottom:2px;}.sp{font-size:12px;color:var(--gold);font-weight:700;}.se{font-size:9px;color:#555;margin-top:2px;}
.badge-owned{position:absolute;top:4px;right:4px;background:var(--green);color:#000;font-size:8px;font-weight:900;border-radius:5px;padding:2px 5px;}
.badge-eq{position:absolute;top:4px;left:4px;background:var(--pink);color:#fff;font-size:8px;font-weight:900;border-radius:5px;padding:2px 5px;}

/* ‚ïê‚ïê‚ïê FIGHT SCREEN ‚ïê‚ïê‚ïê */
#fightScreen{position:fixed;inset:0;z-index:100;display:none;flex-direction:column;background:linear-gradient(180deg,#020006 0%,#08001a 40%,#0e0025 100%);pointer-events:all !important;touch-action:manipulation;will-change:transform;transform:translateZ(0);}
#fightScreen.open{display:flex !important;}
.fight-hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 14px 0;}
.fight-title-txt{font-family:var(--font);font-size:13px;color:var(--gold);letter-spacing:2px;}
.fhud{display:flex;align-items:center;gap:8px;padding:8px 14px;}
.fhud-side{flex:1;}
.fhud-name{font-weight:900;font-size:11px;margin-bottom:3px;}
.fhud-track{height:10px;background:rgba(255,255,255,0.07);border-radius:99px;overflow:hidden;}
.fhud-fp{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--green),#00c853);transition:width 0.3s;}
.fhud-fe{height:100%;border-radius:99px;background:linear-gradient(90deg,#ff5722,var(--pink));transition:width 0.3s;}
.fhud-hp{font-size:9px;color:#444;margin-top:2px;}
.vs-chip{font-family:var(--font);font-size:18px;color:var(--gold);text-shadow:0 0 14px #ffd70077;flex-shrink:0;}
#ringArena{flex:1;position:relative;overflow:hidden;max-height:42vh;}
#ringCanvas{width:100%;height:100%;display:block;}
#fightLog{background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.05);border-radius:11px;padding:7px 11px;margin:0 12px;max-height:72px;overflow-y:auto;font-size:10px;color:#bbb;line-height:1.7;}
#fightBtns{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;padding:7px 12px 3px;}
.fight-btn{border:none;border-radius:13px;padding:9px 4px;color:#fff;font-family:'Nunito',sans-serif;font-weight:900;font-size:10px;cursor:pointer;transition:all 0.16s;}
.fight-btn:active{transform:scale(0.91);}
.fight-btn:disabled{opacity:0.4;cursor:not-allowed;}
.fb-p{background:linear-gradient(135deg,#7c3aed,#4f46e5);}
.fb-k{background:linear-gradient(135deg,#dc2626,#9f1239);}
.fb-sp{background:linear-gradient(135deg,var(--pink),#f43f5e);animation:glw1 1.5s ease-in-out infinite;}
@keyframes glw1{0%,100%{box-shadow:0 0 7px #ff3d7f44;}50%{box-shadow:0 0 20px #ff3d7faa;}}
.fb-def{background:linear-gradient(135deg,#0891b2,#0e7490);}
.fb-hl{background:linear-gradient(135deg,#16a34a,#15803d);}
.fb-sk{background:linear-gradient(135deg,#ff6b9d,#a855f7,#3b82f6);animation:glw2 2s ease-in-out infinite;}
@keyframes glw2{0%,100%{box-shadow:0 0 8px #a855f744;}50%{box-shadow:0 0 22px #a855f7aa;}}
#fightEscape{display:block;text-align:center;background:none;border:none;color:#333;font-size:11px;cursor:pointer;padding:4px 0 calc(max(env(safe-area-inset-bottom,8px),8px));font-family:'Nunito',sans-serif;}

/* ‚ïê‚ïê‚ïê PVP SCREEN ‚ïê‚ïê‚ïê */
#pvpScreen{position:fixed;inset:0;z-index:150;display:none;flex-direction:column;align-items:center;background:linear-gradient(180deg,#000510 0%,#001030 100%);pointer-events:all !important;touch-action:manipulation;}
#pvpScreen.open{display:flex !important;animation:fadeIn 0.4s;}
.pvp-title{font-family:var(--font);font-size:22px;color:var(--cyan);text-shadow:0 0 20px #00e5ff66;margin:20px 0 4px;letter-spacing:3px;}
.pvp-matchmaking{display:flex;flex-direction:column;align-items:center;gap:16px;flex:1;justify-content:center;}
.pvp-vs-row{display:flex;align-items:center;gap:28px;}
.pvp-player-card{background:rgba(255,255,255,0.06);border:2px solid rgba(0,229,255,0.3);border-radius:20px;padding:20px;text-align:center;min-width:120px;}
.pvp-player-icon{font-size:52px;margin-bottom:8px;}
.pvp-player-name{font-family:var(--font);font-size:13px;color:var(--cyan);}
.pvp-player-rating{font-size:11px;color:#ffd700;margin-top:3px;}
.pvp-vs-badge{font-family:var(--font);font-size:28px;color:var(--gold);text-shadow:0 0 20px #ffd70088;}
.pvp-search-ring{width:80px;height:80px;border:3px solid var(--cyan);border-top:3px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin:8px auto;}
@keyframes spin{to{transform:rotate(360deg);}}
.pvp-search-txt{font-size:13px;color:#666;letter-spacing:2px;}
.pvp-rating-badge{background:linear-gradient(135deg,rgba(0,229,255,0.15),rgba(0,100,200,0.15));border:2px solid rgba(0,229,255,0.3);border-radius:16px;padding:12px 24px;text-align:center;}
.pvp-rating-num{font-family:var(--font);font-size:28px;color:var(--cyan);}
.pvp-rating-lbl{font-size:11px;color:#555;margin-top:2px;}
.pvp-btn{background:linear-gradient(135deg,#0066ff,#00aaff);border:none;border-radius:16px;padding:14px 40px;color:#fff;font-family:var(--font);font-size:16px;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 20px rgba(0,170,255,0.4);}
.pvp-btn:active{transform:scale(0.95);}
.pvp-cancel{background:none;border:1px solid #333;border-radius:12px;padding:10px 28px;color:#555;font-family:'Nunito',sans-serif;font-weight:700;font-size:13px;cursor:pointer;margin-top:8px;}
.pvp-leaderboard{width:100%;padding:0 16px;max-height:220px;overflow-y:auto;}
.pvp-lb-row{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--border);border-radius:11px;padding:9px 12px;margin-bottom:7px;}
.pvp-lb-rank{font-family:var(--font);font-size:16px;color:var(--gold);min-width:28px;}
.pvp-lb-icon{font-size:22px;}
.pvp-lb-info{flex:1;}
.pvp-lb-name{font-weight:800;font-size:12px;}
.pvp-lb-rating{font-size:10px;color:var(--cyan);}
.pvp-lb-me{border-color:var(--cyan)!important;background:rgba(0,229,255,0.07)!important;}
#pvpClose{position:absolute;top:14px;right:14px;background:rgba(255,255,255,0.06);border:1.5px solid var(--border);border-radius:99px;width:34px;height:34px;color:#aaa;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;pointer-events:all;}

/* ‚ïê‚ïê‚ïê GUILD SCREEN ‚ïê‚ïê‚ïê */
#guildScreen{position:fixed;inset:0;z-index:140;display:none;flex-direction:column;background:linear-gradient(180deg,#000a00 0%,#001500 100%);pointer-events:all !important;touch-action:manipulation;}
#guildScreen.open{display:flex !important;animation:fadeIn 0.4s;}
.guild-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;}
.guild-title{font-family:var(--font);font-size:18px;color:var(--green);}
.guild-card{background:linear-gradient(135deg,rgba(0,255,136,0.08),rgba(0,100,50,0.08));border:2px solid rgba(0,255,136,0.25);border-radius:20px;margin:0 14px 14px;padding:16px;}
.guild-name{font-family:var(--font);font-size:20px;color:var(--green);}
.guild-icon{font-size:44px;margin-bottom:8px;}
.guild-desc{font-size:11px;color:#555;margin-top:4px;}
.guild-stats{display:flex;gap:12px;margin-top:12px;}
.guild-stat{flex:1;background:rgba(0,0,0,0.4);border-radius:10px;padding:8px;text-align:center;}
.guild-stat-val{font-family:var(--font);font-size:16px;color:var(--green);}
.guild-stat-lbl{font-size:9px;color:#444;}
.guild-members{padding:0 14px;overflow-y:auto;flex:1;}
.guild-member{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--border);border-radius:11px;padding:10px 12px;margin-bottom:7px;}
.gm-icon{font-size:26px;}
.gm-info{flex:1;}
.gm-name{font-weight:800;font-size:12px;}
.gm-stats{font-size:10px;color:#555;margin-top:2px;}
.gm-rank{font-family:var(--font);font-size:11px;color:var(--gold);}
.guild-actions{display:flex;gap:8px;padding:10px 14px;}
.guild-btn{flex:1;padding:11px;border:none;border-radius:12px;color:#fff;font-family:'Nunito',sans-serif;font-weight:900;font-size:12px;cursor:pointer;}
.gb-green{background:linear-gradient(135deg,#16a34a,#15803d);}
.gb-red{background:linear-gradient(135deg,#dc2626,#9f1239);}
#guildClose{position:absolute;top:14px;right:14px;background:rgba(255,255,255,0.06);border:1.5px solid var(--border);border-radius:99px;width:34px;height:34px;color:#aaa;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;pointer-events:all;}

/* ‚ïê‚ïê‚ïê RING SKINS PANEL ‚ïê‚ïê‚ïê */
.ring-skins-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.ring-skin-card{background:var(--card);border:2px solid var(--border);border-radius:14px;padding:14px 10px;text-align:center;cursor:pointer;transition:all 0.2s;position:relative;}
.ring-skin-card.active{border-color:var(--gold);background:rgba(255,215,0,0.06);}
.ring-skin-card.locked{opacity:0.35;cursor:not-allowed;}
.ring-skin-card:active:not(.locked){transform:scale(0.95);}
.rs-preview{font-size:36px;margin-bottom:6px;}
.rs-name{font-weight:900;font-size:12px;margin-bottom:3px;}
.rs-cost{font-size:11px;color:var(--gold);}
.rs-active-badge{position:absolute;top:5px;right:5px;background:var(--gold);color:#000;font-size:8px;font-weight:900;border-radius:5px;padding:2px 5px;}

/* ‚ïê‚ïê‚ïê ACHIEVEMENTS ‚ïê‚ïê‚ïê */
.ach-grid{display:flex;flex-direction:column;gap:9px;}
.ach-card{background:var(--card);border:1.5px solid var(--border);border-radius:13px;padding:12px;display:flex;align-items:center;gap:12px;position:relative;overflow:hidden;}
.ach-card.done{border-color:#ffd70055;background:rgba(255,215,0,0.06);}
.ach-card.done::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,215,0,0.05),transparent);animation:achShine 3s ease-in-out infinite;}
@keyframes achShine{0%,100%{transform:translateX(-100%);}50%{transform:translateX(200%);}}
.ach-icon{font-size:32px;width:40px;text-align:center;}
.ach-info{flex:1;}
.ach-name{font-weight:900;font-size:12px;margin-bottom:2px;}
.ach-desc{font-size:10px;color:#555;}
.ach-prog{font-size:10px;color:var(--gold);margin-top:4px;}
.ach-badge{background:var(--gold);color:#000;font-size:9px;font-weight:900;border-radius:6px;padding:3px 7px;white-space:nowrap;}
.ach-bar-wrap{height:5px;background:rgba(255,255,255,0.07);border-radius:99px;overflow:hidden;margin-top:5px;}
.ach-bar-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--pink));border-radius:99px;transition:width 0.4s;}

/* ‚ïê‚ïê‚ïê REBIRTH SCREEN ‚ïê‚ïê‚ïê */
#rebirthScreen{position:fixed;inset:0;z-index:250;background:radial-gradient(ellipse at center,#1e0048,#04000a);display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:20px;pointer-events:all !important;touch-action:manipulation;}
#rebirthScreen.open{display:flex !important;animation:fadeIn 0.5s;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.rb-emoji{font-size:62px;animation:breathe 0.8s ease-in-out infinite;}
.rb-title{font-family:var(--font);font-size:clamp(16px,5vw,26px);color:var(--gold);text-align:center;text-shadow:0 0 28px #ffd70077;}
.rb-sub{font-size:13px;color:#a78bfa;text-align:center;}
.rb-badge{background:linear-gradient(135deg,var(--gold),#ff8f00);color:#000;border-radius:99px;padding:5px 18px;font-weight:900;font-size:13px;}
.char-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;max-width:520px;width:100%;}
.char-card{background:rgba(255,255,255,0.06);border:2px solid var(--border);border-radius:13px;padding:11px 7px;text-align:center;cursor:pointer;transition:all 0.2s;pointer-events:all;}
.char-card:hover{border-color:var(--gold);background:rgba(255,215,0,0.08);transform:translateY(-3px);}
.char-card:active{transform:scale(0.93);}
.cc-icon{font-size:26px;margin-bottom:3px;}
.cc-name{font-size:10px;font-weight:900;}
.cc-bonus{font-size:8px;color:#a78bfa;margin-top:2px;}
.char-grid-wide{grid-template-columns:repeat(4,1fr);}

/* ‚ïê‚ïê‚ïê DAILY POPUP ‚ïê‚ïê‚ïê */
#dailyPopup{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.82);display:none;align-items:center;justify-content:center;backdrop-filter:blur(7px);}
#dailyPopup.open{display:flex;animation:fadeIn 0.4s;}
#dailyCard{background:linear-gradient(145deg,#0e0020,#1e0045);border:2px solid var(--gold);border-radius:28px;padding:26px 22px;text-align:center;min-width:300px;max-width:90vw;box-shadow:0 0 60px #ffd70022;}
.daily-title{font-family:var(--font);font-size:19px;color:var(--gold);margin-bottom:4px;}
.daily-sub{font-size:12px;color:#a78bfa;margin-bottom:14px;}
.daily-streak-row{display:flex;gap:5px;justify-content:center;margin-bottom:14px;flex-wrap:wrap;}
.ds-day{width:38px;height:38px;border-radius:10px;background:rgba(255,255,255,0.05);border:2px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:13px;transition:all 0.2s;}
.ds-day.claimed{background:rgba(255,215,0,0.1);border-color:var(--gold);}
.ds-day.today{background:rgba(255,61,127,0.17);border-color:var(--pink);transform:scale(1.12);box-shadow:0 0 14px #ff3d7f44;}
.ds-day .ds-n{font-size:8px;color:#444;margin-top:1px;}.ds-day.claimed .ds-n,.ds-day.today .ds-n{color:var(--gold);}
.daily-rew-box{background:rgba(255,255,255,0.05);border-radius:14px;padding:14px;margin-bottom:14px;}
.drb-icon{font-size:42px;margin-bottom:5px;animation:breathe 1.5s ease-in-out infinite;}
.drb-label{font-family:var(--font);font-size:15px;color:var(--gold);}
.drb-desc{font-size:11px;color:#666;margin-top:3px;}
.claim-btn{background:linear-gradient(135deg,var(--pink),var(--purple));border:none;border-radius:15px;padding:13px 38px;color:#fff;font-family:var(--font);font-size:15px;cursor:pointer;transition:all 0.2s;box-shadow:0 4px 22px #ff3d7f33;}
.claim-btn:disabled{opacity:0.5;cursor:not-allowed;}
.skip-btn{display:block;margin:8px auto 0;background:none;border:none;color:#333;font-size:11px;cursor:pointer;}

/* ‚ïê‚ïê‚ïê TIME TOAST ‚ïê‚ïê‚ïê */
#timeToast{position:fixed;bottom:96px;left:50%;transform:translateX(-50%) scale(0.9);background:linear-gradient(135deg,#050f2a,#0f1d50);border:2px solid #4488ff;border-radius:18px;padding:14px 20px;text-align:center;min-width:220px;display:none;z-index:190;box-shadow:0 0 36px #4488ff33;}
#timeToast.open{display:block;animation:toastPop 0.4s cubic-bezier(.34,1.56,.64,1);}
@keyframes toastPop{from{opacity:0;transform:translateX(-50%) scale(0.6);}to{opacity:1;transform:translateX(-50%) scale(1);}}
.tt-icon{font-size:32px;margin-bottom:4px;}.tt-title{font-family:var(--font);font-size:13px;color:#60a5fa;margin-bottom:3px;}.tt-rew{font-size:12px;color:var(--gold);font-weight:700;margin-bottom:10px;}
.collect-btn{background:linear-gradient(135deg,#3b82f6,#2563eb);border:none;border-radius:11px;padding:9px 26px;color:#fff;font-family:var(--font);font-size:12px;cursor:pointer;}

/* –≠–∫–æ–Ω–æ–º–∏—è –±–∞—Ç–∞—Ä–µ–∏: –∞–Ω–∏–º–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ —É –≤–∏–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
#startScreen:not([style*="flex"]) *,
.panel:not(.open) *,
#fightScreen:not(.open):not([style*="flex"]) *,
#rebirthScreen:not(.open) *,
#dailyPopup:not(.open) * {
  animation-play-state: paused !important;
}

/* ‚ïê‚ïê‚ïê MISC ‚ïê‚ïê‚ïê */
.sep{height:1px;background:rgba(255,255,255,0.07);margin:12px 0;}
@media(max-height:680px){#ringArena{max-height:34vh;}#fightLog{max-height:50px;}.fight-btn{padding:7px 3px;font-size:9px;}}
.stat-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;}
.stat-card{background:rgba(255,255,255,0.05);border-radius:11px;padding:9px;text-align:center;}
.stat-icon{font-size:18px;margin-bottom:2px;}.stat-val{font-family:var(--font);font-size:15px;color:var(--gold);}.stat-nm{font-size:9px;color:#444;}
.prog-bg{height:9px;background:rgba(255,255,255,0.06);border-radius:99px;overflow:hidden;margin:5px 0;}
.prog-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--green),#00c853);transition:width 0.4s;}
.loc-item{background:var(--card);border:1.5px solid var(--border);border-radius:13px;padding:11px;margin-bottom:7px;cursor:pointer;transition:all 0.2s;}
.loc-item.current{border-color:var(--gold);}.loc-item.locked{opacity:0.3;cursor:not-allowed;}
.loc-row{display:flex;align-items:center;gap:10px;}
.loc-icon-big{font-size:26px;}.loc-name{font-weight:900;font-size:12px;}.loc-desc{font-size:10px;color:#555;margin-top:2px;}.loc-gyms{font-size:9px;color:#a78bfa;margin-top:2px;}.loc-status{font-size:9px;margin-top:2px;}

/* –≠–∫–æ–Ω–æ–º–∏—è –±–∞—Ç–∞—Ä–µ–∏: –∞–Ω–∏–º–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ —É –≤–∏–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
#startScreen:not(.visible) .start-char,
#loadScreen[style*="display:none"] *,
.panel:not(.open) *,
#fightScreen:not(.open) *,
#rebirthScreen:not(.open) *,
#dailyPopup:not(.open) * {
  animation-play-state: paused !important;
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê LOADING SCREEN ‚ïê‚ïê‚ïê -->
<div id="loadScreen">
  <div class="load-logo">–¢–û–õ–°–¢–Ø–ö</div>
  <div class="load-sub">–ü—É—Ç—å –∫ –ø–æ–±–µ–¥–µ 4.0</div>
  <div class="load-char" id="loadChar">üê∑</div>
  <div class="load-bar-wrap"><div class="load-bar-fill" id="loadBar"></div></div>
  <div class="load-pct" id="loadPct">0%</div>
  <div class="load-tip" id="loadTip">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...</div>
</div>

<!-- ‚ïê‚ïê‚ïê START SCREEN ‚ïê‚ïê‚ïê -->
<div id="startScreen" style="display:none">
  <div class="start-logo">–¢–û–õ–°–¢–Ø–ö</div>
  <div class="start-ver">–í–µ—Ä—Å–∏—è 4.0 ‚Äî RuStore Edition</div>
  <div id="startCharWrap" style="position:relative;width:140px;height:140px;margin:12px auto;cursor:pointer;user-select:none;" onclick="startCharHit()">
    <div class="start-char" id="startCharEmoji">üê∑</div>
    <div id="startHitEffect" style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:28px;pointer-events:none;opacity:0;transition:opacity 0.1s;"></div>
  </div>
  <div id="startHitCount" style="font-size:11px;color:#666;margin-bottom:4px;letter-spacing:2px;min-height:16px;"></div>
  <div class="start-weight-badge">‚öñÔ∏è –ù–∞—á–∞–ª—å–Ω—ã–π –≤–µ—Å: 230 –∫–≥</div>
  <div class="start-stats">
    <div class="start-stat"><b>30</b><span>–ü–µ—Ä–µ—Ä–æ–∂–¥.</span></div>
    <div class="start-stat"><b>20</b><span>–ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π</span></div>
    <div class="start-stat"><b>30</b><span>–°–æ–ø–µ—Ä–Ω–∏–∫–æ–≤</span></div>

  </div>
  <button id="startBtn">‚ö° –ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
</div>

<canvas id="gameCanvas"></canvas>

<!-- DAILY REWARD -->
<div id="dailyPopup">
  <div id="dailyCard">
    <div class="daily-title">üéÅ –ï–ñ–ï–î–ù–ï–í–ù–ê–Ø –ù–ê–ì–†–ê–î–ê</div>
    <div class="daily-sub" id="dailySub">–°–µ—Ä–∏—è: 1 –¥–µ–Ω—å üî•</div>
    <div class="daily-streak-row" id="dailyDays"></div>
    <div class="daily-rew-box"><div class="drb-icon" id="drbIcon">üéÅ</div><div class="drb-label" id="drbLabel">–ù–∞–≥—Ä–∞–¥–∞</div><div class="drb-desc" id="drbDesc">–ó–∞—Ö–æ–¥–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å!</div></div>
    <button class="claim-btn" id="claimBtn" onclick="claimDaily()">‚ú® –ó–ê–ë–†–ê–¢–¨!</button>
    <button class="skip-btn" onclick="closeDailyPopup()">–ü–æ–∑–∂–µ</button>
  </div>
</div>

<!-- TIME TOAST -->
<div id="timeToast">
  <div class="tt-icon" id="ttIcon">‚è∞</div>
  <div class="tt-title" id="ttTitle">–ù–∞–≥—Ä–∞–¥–∞!</div>
  <div class="tt-rew" id="ttRew">+50 –º–æ–Ω–µ—Ç</div>
  <button class="collect-btn" onclick="collectTimeReward()">üéØ –ó–∞–±—Ä–∞—Ç—å!</button>
</div>

<!-- MAIN UI -->
<div id="ui">
  <div id="topHud">
    <div class="hud-block">
      <div class="hud-label">‚öñÔ∏è –í–µ—Å</div>
      <div class="bar-row"><div class="bar-track"><div class="bar-fill" id="weightFill" style="width:100%"></div></div><div class="bar-val" id="weightVal">230–∫–≥</div></div>
    </div>
    <div class="hud-block" style="min-width:90px;">
      <div class="hud-label">‚ö° –≠–Ω–µ—Ä–≥–∏—è</div>
      <div class="bar-row"><div class="bar-track"><div class="bar-fill" id="energyFill" style="width:100%"></div></div><div class="bar-val" id="energyVal">100</div></div>
    </div>
    <div class="hud-chips">
      <div class="chip gold">üí∞<span id="coinsVal">0</span></div>
      <div class="chip blue">üí™<span id="strVal">10</span></div>
      <div class="chip red">üèÜ<span id="winsVal">0</span></div>
      <div class="chip pur">üî•<span id="rbVal">0</span></div>
    </div>
  </div>
  <div id="levelBadge">üî• –ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ <span id="rbLevelSpan">0</span>/30 ‚Ä¢ –†–∞–Ω–≥: <span id="rankNameSpan">–ù–æ–≤–∏—á–æ–∫</span></div>
  <div id="locBadge">üìç –õ–æ–∫–∞—Ü–∏—è 1</div>
  <div id="notif"></div>
  <div id="charTag"><div class="char-tag-inner" id="charNameTag">üê∑ –ë–æ—Ä–∏—Å ‚Ä¢ 230–∫–≥</div></div>
  <div id="saveInd"></div>

  <!-- BOTTOM NAV -->
  <div id="bottomNav">
    <button class="nav-btn" onclick="openPanel('trainPanel')"><div class="nb-icon">üèãÔ∏è</div><div class="nb-label">–ó–∞–ª</div></button>
    <button class="nav-btn" onclick="openPanel('shopPanel')"><div class="nb-icon">üõí</div><div class="nb-label">–ú–∞–≥–∞–∑–∏–Ω</div></button>
    <button class="nav-btn" onclick="openFight()"><div class="nb-icon">üëä</div><div class="nb-label">–ë–æ–π</div></button>
    <button class="nav-btn" onclick="openGuild()"><div class="nb-icon">‚öîÔ∏è</div><div class="nb-label">–ì–∏–ª—å–¥–∏—è</div></button>
    <button class="nav-btn" onclick="openPanel('morePanel')"><div class="nb-icon">‚ãØ</div><div class="nb-label">–ï—â—ë</div></button>
  </div>

  <div id="overlay" onclick="closeAll()"></div>

  <!-- TRAIN PANEL -->
  <div class="panel" id="trainPanel">
    <div class="panel-hdr"><div class="panel-title" id="trainTitle">üèãÔ∏è –ó–∞–ª</div><button class="close-btn" onclick="closeAll()">‚úï</button></div>
    <div id="trainList"></div>
    <button onclick="rest()" style="width:100%;padding:12px;background:linear-gradient(135deg,#0891b2,#0e7490);border:none;border-radius:12px;color:#fff;font-family:'Nunito',sans-serif;font-weight:900;font-size:13px;cursor:pointer;margin-top:6px;">üò¥ –û—Ç–¥–æ—Ö–Ω—É—Ç—å (+40 —ç–Ω–µ—Ä–≥–∏–∏)</button>
  </div>

  <!-- MINI GAME -->
  <div id="miniGame">
    <div class="mg-title" id="mgTitle">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div>
    <div class="mg-inst" id="mgInst">üëÜ –¢–∞–ø–∞–π –ø–æ —ç–∫—Ä–∞–Ω—É!</div>
    <div class="mg-bar-track"><div class="mg-bar-fill" id="mgFill"></div></div>
    <div class="mg-count" id="mgCount">0%</div>
    <div class="mg-motiv" id="mgMotiv">üí™ –î–∞–≤–∞–π!</div>
    <div class="mg-btn-row">
      <button class="mg-action-btn mg-start-btn" onclick="_mgDoTap()" style="font-size:22px;letter-spacing:2px;">üëä –¢–ê–ü!</button>
      <button class="mg-action-btn mg-stop-btn" onclick="stopTraining()" style="flex:0 0 80px;">‚èπ</button>
    </div>
    <div class="mg-result" id="mgResult"></div>
  </div>

  <!-- SHOP PANEL -->
  <div class="panel" id="shopPanel">
    <div class="panel-hdr"><div class="panel-title">üõí –ú–∞–≥–∞–∑–∏–Ω</div><button class="close-btn" onclick="closeAll()">‚úï</button></div>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('drinks')">üçπ –°–ø–æ—Ä—Ç–ø–∏—Ç</button>
      <button class="tab-btn" onclick="switchTab('clothes')">üëï –í–µ—Ä—Ö</button>
      <button class="tab-btn" onclick="switchTab('shoes')">üëü –û–±—É–≤—å</button>
      <button class="tab-btn" onclick="switchTab('acc')">üíç –ê–∫—Å–µ—Å.</button>
      <button class="tab-btn" onclick="switchTab('gear')">‚öôÔ∏è –°–Ω–∞—Ä—è–∂.</button>
      <button class="tab-btn" onclick="switchTab('ringskins')">ü•ä –†–∏–Ω–≥</button>
    </div>
    <div class="tab-content active" id="tab-drinks"><div class="shop-grid" id="drinksGrid"></div></div>
    <div class="tab-content" id="tab-clothes"><div class="shop-grid" id="clothesGrid"></div></div>
    <div class="tab-content" id="tab-shoes"><div class="shop-grid" id="shoesGrid"></div></div>
    <div class="tab-content" id="tab-acc"><div class="shop-grid" id="accGrid"></div></div>
    <div class="tab-content" id="tab-gear"><div class="shop-grid" id="gearGrid"></div></div>
    <div class="tab-content" id="tab-ringskins"><div class="ring-skins-grid" id="ringSkinsGrid"></div></div>
  </div>

  <!-- STATS PANEL -->
  <div class="panel" id="statsPanel">
    <div class="panel-hdr"><div class="panel-title">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å</div><button class="close-btn" onclick="closeAll()">‚úï</button></div>
    <div id="statsContent"></div>
  </div>

  <!-- LOC PANEL -->
  <div class="panel" id="locPanel">
    <div class="panel-hdr"><div class="panel-title">üó∫Ô∏è –ú–∏—Ä</div><button class="close-btn" onclick="closeAll()">‚úï</button></div>
    <div id="locList"></div>
  </div>

  <!-- ACHIEVEMENTS PANEL -->
  <div class="panel" id="achPanel">
    <div class="panel-hdr"><div class="panel-title">üèÖ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div><button class="close-btn" onclick="closeAll()">‚úï</button></div>
    <div class="ach-grid" id="achList"></div>
  </div>

  <!-- MORE PANEL v4.0 -->
  <div class="panel" id="morePanel">
    <div class="panel-hdr"><div class="panel-title">üìã –ú–µ–Ω—é</div><button class="close-btn" onclick="closeAll()">‚úï</button></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <button onclick="closeAll();openPanel('statsPanel')" style="padding:16px;background:var(--card);border:1.5px solid var(--border);border-radius:14px;color:#fff;font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;cursor:pointer;">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å</button>
      <button onclick="closeAll();openPanel('locPanel')" style="padding:16px;background:var(--card);border:1.5px solid var(--border);border-radius:14px;color:#fff;font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;cursor:pointer;">üó∫Ô∏è –õ–æ–∫–∞—Ü–∏–∏</button>
      <button onclick="closeAll();openPanel('achPanel')" style="padding:16px;background:var(--card);border:1.5px solid var(--border);border-radius:14px;color:#fff;font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;cursor:pointer;">üèÖ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
      <button onclick="closeAll();openPanel('shopPanel');switchTab('ringskins')" style="padding:16px;background:var(--card);border:1.5px solid var(--border);border-radius:14px;color:#fff;font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;cursor:pointer;">ü•ä –°–∫–∏–Ω—ã —Ä–∏–Ω–≥–∞</button>
      <button onclick="closeAll();openGuild()" style="padding:16px;background:linear-gradient(135deg,rgba(0,255,136,0.1),rgba(0,100,50,0.1));border:1.5px solid rgba(0,255,136,0.25);border-radius:14px;color:#00ff88;font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;cursor:pointer;">‚öîÔ∏è –ì–∏–ª—å–¥–∏—è</button>
      <button onclick="closeAll();openFood()" style="padding:16px;background:linear-gradient(135deg,rgba(255,107,0,0.15),rgba(200,50,0,0.15));border:1.5px solid rgba(255,107,0,0.3);border-radius:14px;color:var(--orange);font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;cursor:pointer;">üçî –ü–∏—Ç–∞–Ω–∏–µ</button>
      <button onclick="closeAll();openQuests()" style="padding:16px;background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(200,100,0,0.15));border:1.5px solid rgba(255,215,0,0.3);border-radius:14px;color:var(--gold);font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;cursor:pointer;">üéØ –ö–≤–µ—Å—Ç—ã</button>
      <button onclick="closeAll();openTournament()" style="padding:16px;background:linear-gradient(135deg,rgba(155,0,255,0.15),rgba(255,61,127,0.15));border:1.5px solid rgba(155,0,255,0.3);border-radius:14px;color:#c084fc;font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;cursor:pointer;">üèÜ –¢—É—Ä–Ω–∏—Ä</button>
      <button onclick="closeAll();openSettings()" style="padding:16px;background:var(--card);border:1.5px solid var(--border);border-radius:14px;color:#aaa;font-family:'Nunito',sans-serif;font-weight:800;font-size:12px;cursor:pointer;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
  </div>

  <!-- FOOD PANEL -->
  <div class="panel" id="foodPanel">
    <div class="panel-hdr"><div class="panel-title">üçî –ü–∏—Ç–∞–Ω–∏–µ</div><button class="close-btn" onclick="closeAll()">‚úï</button></div>
    <div style="font-size:11px;color:#555;margin-bottom:12px;">–ï–¥–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–µ—Å, —ç–Ω–µ—Ä–≥–∏—é –∏ —Å–∏–ª—É –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</div>
    <div id="foodList"></div>
  </div>

  <!-- QUESTS PANEL -->
  <div class="panel" id="questsPanel">
    <div class="panel-hdr"><div class="panel-title">üéØ –ö–≤–µ—Å—Ç—ã</div><button class="close-btn" onclick="closeAll()">‚úï</button></div>
    <div style="font-size:11px;color:#555;margin-bottom:12px;">–í—ã–ø–æ–ª–Ω—è–π –∑–∞–¥–∞–Ω–∏—è –∏ –ø–æ–ª—É—á–∞–π –º–æ–Ω–µ—Ç—ã!</div>
    <div id="questsList"></div>
  </div>

  <!-- TOURNAMENT PANEL -->
  <div class="panel" id="tournamentPanel">
    <div class="panel-hdr"><div class="panel-title">üèÜ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –¢—É—Ä–Ω–∏—Ä</div><button class="close-btn" onclick="closeAll()">‚úï</button></div>
    <div id="tournamentContent"></div>
  </div>

  <!-- SETTINGS PANEL -->
  <div class="panel" id="settingsPanel">
    <div class="panel-hdr"><div class="panel-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div><button class="close-btn" onclick="closeAll()">‚úï</button></div>
    <div id="settingsContent"></div>
  </div>

  <!-- FIGHT SCREEN -->
  <div id="fightScreen">
    <div class="fight-hdr">
      <div class="fight-title-txt">‚öîÔ∏è –ü–û–ï–î–ò–ù–û–ö</div>
      <div style="font-size:10px;color:#444;" id="fightLocName">–ê—Ä–µ–Ω–∞</div>
    </div>
    <div class="fhud">
      <div class="fhud-side"><div class="fhud-name" id="pName">üê∑ –ë–æ—Ä–∏—Å</div><div class="fhud-track"><div class="fhud-fp" id="pHpBar" style="width:100%"></div></div><div class="fhud-hp" id="pHpTxt">HP 100</div></div>
      <div class="vs-chip">VS</div>
      <div class="fhud-side" style="text-align:right;"><div class="fhud-name" id="eName">üíÄ –í—Ä–∞–≥</div><div class="fhud-track"><div class="fhud-fe" id="eHpBar" style="width:100%"></div></div><div class="fhud-hp" id="eHpTxt">HP 100</div></div>
    </div>
    <div id="ringArena"><canvas id="ringCanvas"></canvas></div>
    <div id="fightLog"></div>
    <div id="fightBtns"></div>
    <button id="fightEscape" onclick="closeFight()">‚Ü© –°–±–µ–∂–∞—Ç—å</button>
  </div>

  <!-- PVP SCREEN -->
  <div id="pvpScreen">
    <button id="pvpClose" onclick="closePVP()">‚úï</button>
    <div class="pvp-title">üåê –ê–†–ï–ù–ê –í–´–ó–û–í–û–í</div>
    <div style="padding:0 16px;width:100%;">
      <div class="pvp-rating-badge" style="margin-bottom:14px;">
        <div class="pvp-rating-num" id="pvpRatingNum">1200</div>
        <div class="pvp-rating-lbl">–¢–≤–æ–π —Ä–µ–π—Ç–∏–Ω–≥</div>
        <div style="font-size:11px;color:#a78bfa;margin-top:3px;" id="pvpRankName">ü•â –ë—Ä–æ–Ω–∑–∞</div>
      </div>
    </div>
    <div id="pvpContent" style="flex:1;display:flex;flex-direction:column;align-items:flex-start;width:100%;padding:0 16px;overflow-y:auto;">
      <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è —á–µ—Ä–µ–∑ renderPVPScreen() -->
    </div>
    <!-- Matchmaking overlay -->
    <div id="pvpSearching" style="display:none;position:absolute;inset:0;background:rgba(0,5,16,0.95);display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px;">
      <div class="pvp-vs-row">
        <div class="pvp-player-card">
          <div class="pvp-player-icon" id="pvpMyIcon">üê∑</div>
          <div class="pvp-player-name" id="pvpMyName">–¢—ã</div>
          <div class="pvp-player-rating" id="pvpMyRat">‚≠ê 1200</div>
        </div>
        <div class="pvp-vs-badge">VS</div>
        <div class="pvp-player-card" id="pvpEnemyCard">
          <div class="pvp-player-icon">‚ùì</div>
          <div class="pvp-player-name">–ü–æ–∏—Å–∫...</div>
          <div class="pvp-player-rating">‚≠ê ???</div>
        </div>
      </div>
      <div class="pvp-search-ring" id="pvpSearchRing"></div>
      <div class="pvp-search-txt" id="pvpSearchTxt">–ü–û–ò–°–ö –°–û–ü–ï–†–ù–ò–ö–ê...</div>
      <button class="pvp-cancel" onclick="cancelPVPSearch()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- GUILD SCREEN -->
  <div id="guildScreen">
    <button id="guildClose" onclick="closeGuild()">‚úï</button>
    <div class="guild-hdr"><div class="guild-title">‚öîÔ∏è –ì–ò–õ–¨–î–ò–Ø</div></div>
    <div id="guildContent" style="flex:1;overflow-y:auto;"></div>
  </div>

  <!-- REBIRTH SCREEN -->
  <div id="rebirthScreen">
    <div class="rb-emoji">üåü</div>
    <div class="rb-title">üî• –ü–ï–†–ï–†–û–ñ–î–ï–ù–ò–ï!</div>
    <div class="rb-sub" id="rbSub">–í—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</div>
    <div class="rb-badge" id="rbBadge">–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ #1</div>
    <div class="char-grid char-grid-wide" id="charGrid"></div>
  </div>
</div>

<script>
// –¢–û–õ–°–¢–Ø–ö 4.0 ‚Äî –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –≤–µ—Ä—Å–∏—è (–±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOADING (–º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç ‚Äî –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LOAD_TIPS=['–¢—Ä–µ–Ω–∏—Ä—É–π—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å!','–ü—Ä–æ—Ç–µ–∏–Ω –¥–∞—ë—Ç +5 —Å–∏–ª—ã','–í–µ—Ä—Ç—É—à–∫–∞ –Ω–∞–Ω–æ—Å–∏—Ç x1.8 —É—Ä–æ–Ω–∞','–í—Å—Ç—É–ø–∞–π –≤ –≥–∏–ª—å–¥–∏—é!','–°–∫–∏–Ω—ã —Ä–∏–Ω–≥–∞ –¥–∞—é—Ç +—É—Ä–æ–Ω','30 –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–π ‚Äî —Å—Ç–∞–Ω—å –ª–µ–≥–µ–Ω–¥–æ–π!','–ë–µ–π —Ç–æ–ª—Å—Ç—è–∫–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ ‚Äî —ç—Ç–æ –≤–µ—Å–µ–ª–æ!','–ü–æ–±–µ–∂–¥–∞–π –≤—Ä–∞–≥–æ–≤ –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –º–æ–Ω–µ—Ç—ã!'];
let loadProgress=0;

function _runLoader(){
  const lb=document.getElementById('loadBar');
  const lp=document.getElementById('loadPct');
  const lt=document.getElementById('loadTip');
  
  // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤—ã ‚Äî –∂–¥—ë–º
  if(!lb||!lp){
    requestAnimationFrame(_runLoader);
    return;
  }
  
  // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å
  lb.style.width='2%';
  lp.textContent='2%';
  
  function _step(){
    loadProgress += Math.random()*9+4;
    if(loadProgress>100) loadProgress=100;
    
    lb.style.width=loadProgress+'%';
    lp.textContent=Math.floor(loadProgress)+'%';
    if(lt) lt.textContent=LOAD_TIPS[Math.floor(Math.random()*LOAD_TIPS.length)];
    
    if(loadProgress<100){
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å file:// –∏ content://
      setTimeout(_step, 60);
    } else {
      setTimeout(()=>{
        const ls=document.getElementById('loadScreen');
        const ss=document.getElementById('startScreen');
        if(ls){
          ls.style.transition='opacity 0.5s';
          ls.style.opacity='0';
          setTimeout(()=>{
            ls.style.display='none';
            if(ss) ss.style.display='flex';
          },500);
        }
      },300);
    }
  }
  
  setTimeout(_step, 80);
}

// –ó–∞–ø—É—Å–∫: —Å—Ä–∞–∑—É –∏–ª–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded', _runLoader);
} else {
  _runLoader();
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SOUND SYSTEM (Web Audio API)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _ac = null;
function getACtx(){
  if(!_ac){ 
    try{ _ac=new(window.AudioContext||window.webkitAudioContext)(); }catch(e){}
  }
  if(_ac && _ac.state==='suspended') _ac.resume();
  return _ac;
}
function beep(freq,vol,type,dur){
  try{
    const ac=getACtx();if(!ac)return;
    const o=ac.createOscillator(),g=ac.createGain();
    o.type=type||'sine';o.frequency.value=freq;
    g.gain.setValueAtTime(vol||0.1,ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+(dur||0.15));
    o.connect(g);g.connect(ac.destination);
    o.start();o.stop(ac.currentTime+(dur||0.15));
  }catch(e){}
}
const SND={
  click:()=>beep(440,0.05,'sine',0.08),
  tap:()=>beep(220,0.08,'sawtooth',0.06),
  punch:()=>{beep(180,0.14,'sawtooth',0.1);setTimeout(()=>beep(100,0.1,'sawtooth',0.08),40);},
  kick:()=>{beep(140,0.16,'sawtooth',0.12);setTimeout(()=>beep(80,0.12,'sawtooth',0.1),50);},
  special:()=>{beep(350,0.15,'sawtooth',0.1);setTimeout(()=>beep(500,0.12,'sine',0.15),80);setTimeout(()=>beep(700,0.08,'sine',0.1),180);},
  spinKick:()=>{beep(200,0.18,'sawtooth',0.08);setTimeout(()=>beep(300,0.15,'sawtooth',0.12),60);setTimeout(()=>beep(450,0.12,'sine',0.1),130);},
  hit:()=>beep(120,0.1,'sawtooth',0.1),
  defend:()=>{beep(300,0.1,'square',0.08);setTimeout(()=>beep(200,0.08,'square',0.06),60);},
  heal:()=>{beep(440,0.08,'sine',0.1);setTimeout(()=>beep(550,0.08,'sine',0.12),80);setTimeout(()=>beep(660,0.06,'sine',0.15),180);},
  trainDone:()=>{beep(440,0.1,'sine',0.15);setTimeout(()=>beep(550,0.1,'sine',0.1),150);setTimeout(()=>beep(660,0.12,'sine',0.2),280);setTimeout(()=>beep(880,0.1,'sine',0.25),430);},
  buy:()=>{beep(440,0.07,'sine',0.1);setTimeout(()=>beep(660,0.07,'sine',0.1),100);},
  equip:()=>{beep(523,0.08,'sine',0.1);setTimeout(()=>beep(659,0.07,'sine',0.1),90);setTimeout(()=>beep(784,0.06,'sine',0.15),180);},
  coin:()=>beep(880,0.06,'sine',0.08),
  levelUp:()=>{[440,550,660,880,1100].forEach((f,i)=>setTimeout(()=>beep(f,0.1,'sine',0.12),i*80));},
  win:()=>{[440,550,660,880].forEach((f,i)=>setTimeout(()=>beep(f,0.1,'sine',0.15),i*120));},
  lose:()=>{[440,330,220].forEach((f,i)=>setTimeout(()=>beep(f,0.08,'sawtooth',0.2),i*150));},
  rebirth:()=>{for(let i=0;i<8;i++)setTimeout(()=>beep(220+i*80,0.1,'sine',0.15),i*100);},
  pvpFound:()=>{beep(660,0.1,'sine',0.1);setTimeout(()=>beep(880,0.12,'sine',0.15),100);setTimeout(()=>beep(1100,0.1,'sine',0.2),220);},
  daily:()=>{beep(440,0.08,'sine',0.1);setTimeout(()=>beep(660,0.1,'sine',0.15),120);},
  guild:()=>beep(330,0.08,'sine',0.12),
  eat:()=>{beep(350,0.07,'sine',0.08);setTimeout(()=>beep(440,0.06,'sine',0.1),70);},
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –§–û–ù–û–í–ê–Ø –ú–£–ó–´–ö–ê (Web Audio API ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ñ—Ñ–ª–∞–π–Ω)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _musicEnabled = true;
let _musicNodes = [];
let _musicRunning = false;
let _musicLoopTimer = null;

function startBgMusic(){
  if(_musicRunning) return; // —É–∂–µ –∏–≥—Ä–∞–µ—Ç ‚Äî –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ç–æ—Ä–æ–π
  const ac = getACtx();
  if(!ac || !_musicEnabled) return;
  _musicRunning = true;
  const BPM = 118;
  const beat = 60/BPM;
  const bassLine = [
    [55,2],[55,2],[73,2],[65,2],
    [55,2],[55,2],[65,2],[61,2],
  ];
  const melody = [
    [440,1],[0,1],[523,1],[0,1],[587,2],[0,2],
    [494,1],[0,1],[440,1],[0,1],[523,2],[0,2],
  ];
  let bassT = ac.currentTime + 0.1;
  let melT  = ac.currentTime + 0.1;
  function playNote(freq, dur, vol, type, startT){
    if(!freq || !_musicRunning) return;
    try{
      const o = ac.createOscillator();
      const g = ac.createGain();
      const mv = 0.055;
      o.type = type||'triangle';
      o.frequency.value = freq;
      g.gain.setValueAtTime(0, startT);
      g.gain.linearRampToValueAtTime(vol*mv, startT+0.02);
      g.gain.setValueAtTime(vol*mv, startT+dur-0.04);
      g.gain.linearRampToValueAtTime(0, startT+dur);
      o.connect(g); g.connect(ac.destination);
      o.start(startT); o.stop(startT+dur+0.05);
      _musicNodes.push(o);
    }catch(e){}
  }
  function scheduleLoop(){
    if(!_musicRunning) return;
    let bt = bassT;
    bassLine.forEach(([freq, beats])=>{
      playNote(freq, beats*beat*0.85, 0.9, 'sine', bt);
      bt += beats*beat;
    });
    bassT = bt;
    let mt = melT;
    melody.forEach(([freq, beats])=>{
      if(freq>0) playNote(freq, beats*beat*0.7, 0.5, 'triangle', mt);
      mt += beats*beat;
    });
    melT = mt;
    const loopDur = bassLine.reduce((s,[,b])=>s+b,0)*beat*1000;
    _musicLoopTimer = setTimeout(scheduleLoop, loopDur*0.78);
  }
  scheduleLoop();
}

function stopBgMusic(){
  _musicRunning = false;
  if(_musicLoopTimer){ clearTimeout(_musicLoopTimer); _musicLoopTimer = null; }
  _musicNodes.forEach(n=>{try{n.stop();}catch(e){}});
  _musicNodes = [];
}

window.toggleMusic = function(){
  _musicEnabled = !_musicEnabled;
  gs.musicEnabled = _musicEnabled;
  if(_musicEnabled){ startBgMusic(); }else{ stopBgMusic(); }
  if(typeof markDirty==='function') markDirty();
  if(typeof save==='function') save();
  if(typeof renderSettings==='function') renderSettings();
};



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 2D CANVAS RENDERER ‚Äî –∑–∞–º–µ–Ω—è–µ—Ç Three.js
// –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ñ—Ñ–ª–∞–π–Ω –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const cnv = document.getElementById('gameCanvas');
const ctx2d = cnv.getContext('2d');
let W = 0, H = 0;
let anim = {action:'idle', t:0};
let _tapFlash = 0;
let _particles = [];

function resizeCanvas(){
  W = cnv.width = window.innerWidth;
  H = cnv.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// –¶–≤–µ—Ç–∞ –ª–æ–∫–∞—Ü–∏–π
const LOC_COLORS = [
  {bg:'#0a001a',floor:'#1a0f2e',glow:'#ff3d7f'},
  {bg:'#001a0a',floor:'#0a1a00',glow:'#00ff88'},
  {bg:'#1a0a00',floor:'#1a0800',glow:'#ff6b00'},
  {bg:'#00101a',floor:'#001020',glow:'#00e5ff'},
  {bg:'#1a001a',floor:'#150015',glow:'#aa00ff'},
  {bg:'#0a0a1a',floor:'#080818',glow:'#4488ff'},
  {bg:'#1a0000',floor:'#180000',glow:'#ff0040'},
  {bg:'#001a1a',floor:'#001515',glow:'#00ffcc'},
  {bg:'#1a1000',floor:'#181000',glow:'#ffd700'},
  {bg:'#000a1a',floor:'#00051a',glow:'#ff44ff'},
];
let currentLocColor = LOC_COLORS[0];

function buildScene(lid){
  currentLocColor = LOC_COLORS[lid % LOC_COLORS.length] || LOC_COLORS[0];
}

// Spawn particle
function spawnP(x, y, col, n=5){
  for(let i=0;i<n;i++){
    _particles.push({
      x: x + (Math.random()-0.5)*40,
      y: y,
      vx: (Math.random()-0.5)*4,
      vy: -(1+Math.random()*5),
      life: 1,
      col: typeof col==='number' ? '#'+col.toString(16).padStart(6,'0') : col,
      r: 3+Math.random()*5
    });
  }
}

// ‚îÄ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _lerpCol(a,b,t){ // —Å–º–µ—à–∞—Ç—å –¥–≤–∞ hex-—Ü–≤–µ—Ç–∞
  const p=n=>parseInt(n.replace('#',''),16);
  const an=p(a),bn=p(b);
  const r=Math.round(((an>>16)&255)*(1-t)+((bn>>16)&255)*t);
  const g=Math.round(((an>>8)&255)*(1-t)+((bn>>8)&255)*t);
  const bl=Math.round((an&255)*(1-t)+(bn&255)*t);
  return'#'+((1<<24)|(r<<16)|(g<<8)|bl).toString(16).slice(1);
}
function _lighten(hex,a){
  if(!hex||typeof hex!=='string')hex='#4a8fe8';
  hex=hex.replace('#','');
  if(hex.length!==6)hex='4a8fe8';
  const n=parseInt(hex,16);
  if(isNaN(n))return'#4a8fe8';
  const r=Math.min(255,Math.max(0,((n>>16)&255)+Math.round(255*a)));
  const g=Math.min(255,Math.max(0,((n>>8)&255)+Math.round(255*a)));
  const b=Math.min(255,Math.max(0,(n&255)+Math.round(255*a)));
  return'#'+((1<<24)|(r<<16)|(g<<8)|b).toString(16).slice(1);
}
function _darken(hex,a){return _lighten(hex,-a);}

// Draw 2D character ‚Äî –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ë–æ—Ä–∏—Å
// fat=1 ‚Üí 230–∫–≥ —Ç–æ–ª—Å—Ç—è–∫, fat=0 ‚Üí 60–∫–≥ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω
// isFight=true ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º—ã—à—Ü—ã –ø—Ä–µ—Å—Å–∞ –≤–º–µ—Å—Ç–æ –∂–∏–≤–æ—Ç–∞
function drawChar(cx, cy, weight, clothes, shoes, acc, isHit, animState, t, isFight){
  const fat  = Math.max(0, Math.min(1, (weight-60)/170));
  const lean = 1 - fat;
  const sc   = H * 0.26;
  
  // ‚îÄ‚îÄ –ê–ù–ò–ú–ê–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const ta = t || 0;
  let offY=0, rot=0, lA=0, rA=0, lL=0, rL=0, sqX=1, sqY=1;

  if(animState==='idle'){
    offY=Math.sin(ta*2)*2.5; lA=-0.12+Math.sin(ta*2)*0.06; rA=0.12-Math.sin(ta*2)*0.06;
  }else if(animState==='boxing'||animState==='punch'){
    lA=-0.5+Math.sin(ta*8)*0.9; rA=0.5-Math.sin(ta*8)*0.9; offY=Math.sin(ta*8)*3;
  }else if(animState==='kick'){
    lL=Math.sin(ta*7)*1.0; rA=-0.3; offY=Math.sin(ta*7)*3;
  }else if(animState==='spin'){
    lA=-1.5; rA=1.5; rot=Math.sin(ta*10)*0.28; offY=-Math.abs(Math.sin(ta*5))*5;
  }else if(animState==='special'){
    lA=-1.3+Math.sin(ta*9)*0.5; rA=1.3-Math.sin(ta*9)*0.5; offY=Math.sin(ta*9)*4;
  }else if(animState==='defend'){
    lA=-1.2; rA=1.2; sqX=0.92;
  }else if(animState==='heal'){
    lA=-0.8; rA=-0.2; offY=Math.sin(ta*3)*2;
  }else if(animState==='lift'){
    lA=-1.1+Math.sin(ta*2)*0.3; rA=1.1-Math.sin(ta*2)*0.3; offY=Math.sin(ta*2)*4;
  }else if(animState==='run'){
    lL=Math.sin(ta*8)*0.65; rL=-Math.sin(ta*8)*0.65;
    lA=-0.2+Math.sin(ta*8)*0.45; rA=0.2-Math.sin(ta*8)*0.45; offY=-Math.abs(Math.sin(ta*8))*3;
  }else if(animState==='jump'){
    offY=-Math.abs(Math.sin(ta*4))*sc*0.22; sqX=1+Math.abs(Math.sin(ta*4))*0.1; sqY=1-Math.abs(Math.sin(ta*4))*0.08;
  }else if(animState==='squat'){
    offY=Math.abs(Math.sin(ta*3))*sc*0.15; lA=-0.4+Math.sin(ta*3)*0.2; rA=0.4-Math.sin(ta*3)*0.2;
  }else if(animState==='swim'){
    lA=Math.sin(ta*3)*1.2; rA=-Math.sin(ta*3)*1.2; offY=Math.sin(ta*3)*5; rot=Math.sin(ta*2)*0.06;
  }else if(animState==='bike'){
    lL=Math.sin(ta*6)*0.75; rL=-Math.sin(ta*6)*0.75; offY=Math.sin(ta*4)*2;
  }else if(animState==='yoga'){
    lA=-0.9+Math.sin(ta)*0.4; rA=0.9-Math.sin(ta)*0.4; lL=Math.sin(ta*1.5)*0.4;
  }else if(animState==='pullup'){
    lA=-1.5; rA=1.5; offY=Math.sin(ta*3)*sc*0.1;
  }else if(animState==='rowing'){
    lA=-0.3+Math.sin(ta*3)*0.75; rA=0.3-Math.sin(ta*3)*0.75; rot=Math.sin(ta*3)*0.1;
  }else if(animState==='win'){
    lA=-1.5; rA=1.5; offY=-Math.abs(Math.sin(ta*4))*sc*0.1;
  }

  // ‚îÄ‚îÄ –†–ê–ó–ú–ï–†–´ (–∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤–µ—Å–∞) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –¢–µ–ª–æ: —É —Ç–æ–ª—Å—Ç—è–∫–∞ ‚Äî –±–æ–ª—å—à–æ–π —à–∞—Ä, —É —Ö—É–¥–æ–≥–æ ‚Äî –≤—ã—Ç—è–Ω—É—Ç–æ–µ
  const bW  = sc*(0.29+fat*0.23);   // –ø–æ–ª—É—à–∏—Ä–∏–Ω–∞ —Ç–µ–ª–∞
  const bH  = sc*(0.34+fat*0.11);   // –ø–æ–ª—É–≤—ã—Å–æ—Ç–∞ —Ç–µ–ª–∞
  const hR  = sc*(0.155+fat*0.03);  // —Ä–∞–¥–∏—É—Å –≥–æ–ª–æ–≤—ã
  const armW= sc*0.105;             // —à–∏—Ä–∏–Ω–∞ —Ä—É–∫–∏-—Ü–∏–ª–∏–Ω–¥—Ä–∞
  const armH= sc*(0.28-fat*0.04);   // –¥–ª–∏–Ω–∞ —Ä—É–∫–∏
  const legW= sc*(0.11+fat*0.035);
  const legH= sc*(0.25+fat*0.03);

  const skinCol = isHit ? '#e04444' : '#f0a870';
  const hairCol = '#6b2d0f';        // —Ç—ë–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–µ –≤–æ–ª–æ—Å—ã –∫–∞–∫ –Ω–∞ –∏–∫–æ–Ω–∫–µ
  const bodyCol = (clothes && typeof clothes==='string' && clothes.startsWith('#')) ? clothes : '#4a8fe8';
  const shoeC   = (shoes  && typeof shoes==='string'  && shoes.startsWith('#'))  ? shoes  : '#f0f0f0';

  // ‚îÄ‚îÄ –¢–ï–ù–¨ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ctx2d.save();
  ctx2d.globalAlpha=0.2;
  ctx2d.fillStyle='#000';
  ctx2d.beginPath();
  ctx2d.ellipse(cx, cy+sc*0.9, bW*0.85, sc*0.065, 0, 0, Math.PI*2);
  ctx2d.fill();
  ctx2d.restore();

  // ‚îÄ‚îÄ MAIN TRANSFORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ctx2d.save();
  ctx2d.translate(cx, cy+offY);
  ctx2d.rotate(rot);

  // ‚îÄ‚îÄ –ù–û–ì–ò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  [[- 1, lL],[1, rL]].forEach(([s,lr])=>{
    ctx2d.save();
    ctx2d.translate(s*bW*0.30, bH*0.6);
    ctx2d.rotate(lr);
    // –ì–æ–ª–µ–Ω—å (—ç–ª–ª–∏–ø—Å-—Ü–∏–ª–∏–Ω–¥—Ä)
    ctx2d.fillStyle=skinCol;
    ctx2d.beginPath();
    ctx2d.ellipse(0,legH*0.38,legW*0.7,legH*0.48,0,0,Math.PI*2);
    ctx2d.fill();
    // –ö—Ä–æ—Å—Å–æ–≤–æ–∫ ‚Äî –±–µ–ª—ã–π —ç–ª–ª–∏–ø—Å –∫–∞–∫ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
    ctx2d.fillStyle=shoeC;
    ctx2d.beginPath();
    ctx2d.ellipse(s*legW*0.1,legH*0.85,legW*1.1,legW*0.55,0.12*s,0,Math.PI*2);
    ctx2d.fill();
    ctx2d.fillStyle='#aaa';
    ctx2d.beginPath();
    ctx2d.ellipse(s*legW*0.1,legH*0.92,legW*1.0,legW*0.2,0.12*s,0,Math.PI*2);
    ctx2d.fill();
    ctx2d.restore();
  });

  // ‚îÄ‚îÄ –†–£–ö–ò (—Ü–∏–ª–∏–Ω–¥—Ä—ã –∫–∞–∫ –Ω–∞ –∏–∫–æ–Ω–∫–µ, –∑–∞ —Ç–µ–ª–æ–º) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  [[-1, lA],[1, rA]].forEach(([s,ar])=>{
    ctx2d.save();
    ctx2d.translate(s*bW*0.95, -bH*0.05);
    ctx2d.rotate(ar);
    // –ü–ª–µ—á–æ
    ctx2d.fillStyle=skinCol;
    ctx2d.beginPath();
    ctx2d.ellipse(0,0,armW*0.85,armW*0.7,0,0,Math.PI*2);
    ctx2d.fill();
    // –¶–∏–ª–∏–Ω–¥—Ä —Ä—É–∫–∏ (—Å—É–∂–∞–µ—Ç—Å—è –∫–Ω–∏–∑—É –∫–∞–∫ –Ω–∞ –∏–∫–æ–Ω–∫–µ)
    const g=ctx2d.createLinearGradient(-armW*0.5,0,armW*0.5,0);
    g.addColorStop(0,_darken(skinCol,0.1));
    g.addColorStop(0.45,'#ffc69a');
    g.addColorStop(1,_darken(skinCol,0.1));
    ctx2d.fillStyle=g;
    ctx2d.beginPath();
    // —Ç—Ä–∞–ø–µ—Ü–∏—è: —à–∏—Ä–æ–∫–æ–µ —Å–≤–µ—Ä—Ö—É, —É–∑–∫–æ–µ —Å–Ω–∏–∑—É
    ctx2d.moveTo(-armW*0.52, 0);
    ctx2d.lineTo( armW*0.52, 0);
    ctx2d.lineTo( armW*0.35, armH);
    ctx2d.lineTo(-armW*0.35, armH);
    ctx2d.closePath();
    ctx2d.fill();
    // –ù–∏–∂–Ω–∏–π —Ç–æ—Ä–µ—Ü —Ü–∏–ª–∏–Ω–¥—Ä–∞
    ctx2d.fillStyle=_darken(skinCol,0.12);
    ctx2d.beginPath();
    ctx2d.ellipse(0,armH,armW*0.35,armW*0.22,0,0,Math.PI*2);
    ctx2d.fill();
    ctx2d.restore();
  });

  // ‚îÄ‚îÄ –¢–ï–õ–û ‚Äî –≥–ª–∞–≤–Ω—ã–π —à–∞—Ä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ì—Ä–∞–¥–∏–µ–Ω—Ç –∫–∞–∫ —É 3D-—à–∞—Ä–∞ –Ω–∞ –∏–∫–æ–Ω–∫–µ
  const bg=ctx2d.createRadialGradient(-bW*0.25,-bH*0.28,bW*0.04,bW*0.05,bH*0.1,bW*1.35);
  bg.addColorStop(0,_lighten(bodyCol,0.38));
  bg.addColorStop(0.45,bodyCol);
  bg.addColorStop(1,_darken(bodyCol,0.38));
  ctx2d.fillStyle=bg;
  ctx2d.beginPath();
  ctx2d.ellipse(0,0,bW*sqX,bH*sqY,0,0,Math.PI*2);
  ctx2d.fill();

  // –ñ–∏–≤–æ—Ç ‚Äî –≤—ã–ø–∏—Ä–∞–µ—Ç —É —Ç–æ–ª—Å—Ç—è–∫–∞, –∏—Å—á–µ–∑–∞–µ—Ç –ø—Ä–∏ –ø–æ—Ö—É–¥–µ–Ω–∏–∏
  const showBelly = fat > 0.08 && !isFight;
  if(showBelly){
    const bellyR = bW*(0.36+fat*0.38);
    const bellyY = bH*(0.08+fat*0.14);
    const bellyAlpha = Math.min(1, fat*1.5);
    const bg2=ctx2d.createRadialGradient(-bellyR*0.2,bellyY-bellyR*0.3,bellyR*0.05,0,bellyY,bellyR);
    bg2.addColorStop(0,_lighten(bodyCol,0.22));
    bg2.addColorStop(1,bodyCol);
    ctx2d.fillStyle=bg2;
    ctx2d.globalAlpha=bellyAlpha;
    ctx2d.beginPath();
    ctx2d.arc(0,bellyY,bellyR,0,Math.PI*2);
    ctx2d.fill();
    ctx2d.globalAlpha=1;
    // –í—Ç–æ—Ä–æ–π –∂–∏–≤–æ—Ç (–Ω–∏–∂–Ω–∏–π), —Ç–æ–∂–µ –∏–∑ –∏–∫–æ–Ω–∫–∏
    if(fat>0.45){
      ctx2d.fillStyle=bodyCol;
      ctx2d.globalAlpha=fat*0.7;
      ctx2d.beginPath();
      ctx2d.ellipse(0,bellyY+bellyR*0.72,bellyR*0.75,bellyR*0.45,0,0,Math.PI*2);
      ctx2d.fill();
      ctx2d.globalAlpha=1;
    }
  }

  // –ú—ã—à—Ü—ã –ø—Ä–µ—Å—Å–∞ ‚Äî –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø–æ—Ö—É–¥–µ–Ω–∏–∏ –∏–ª–∏ –≤ –±–æ—é
  const muscleShow = (lean>0.4 || isFight);
  if(muscleShow){
    const mAlpha=Math.min(0.65,(lean-0.2)*0.8+(isFight?0.35:0));
    ctx2d.globalAlpha=mAlpha;
    const mcol=_lighten(bodyCol,0.22);
    for(let row=0;row<3;row++){
      for(let col=0;col<2;col++){
        const mx=(col-0.5)*bW*0.36;
        const my=(row-0.85)*bH*0.30;
        ctx2d.fillStyle=mcol;
        ctx2d.beginPath();
        ctx2d.ellipse(mx,my,bW*0.13,bH*0.096,0,0,Math.PI*2);
        ctx2d.fill();
        ctx2d.strokeStyle=_darken(bodyCol,0.15);
        ctx2d.lineWidth=0.7;
        ctx2d.stroke();
      }
    }
    ctx2d.globalAlpha=1;
  }

  // ‚îÄ‚îÄ –ì–û–õ–û–í–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const headY=-(bH+hR*0.68);

  // –®–µ—è
  ctx2d.fillStyle=skinCol;
  ctx2d.beginPath();
  ctx2d.roundRect(-hR*0.26,headY+hR*0.6,hR*0.52,hR*0.6,hR*0.13);
  ctx2d.fill();

  // –ì–æ–ª–æ–≤–∞ ‚Äî —à–∞—Ä —Å 3D-–≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
  const hg=ctx2d.createRadialGradient(-hR*0.28,headY-hR*0.28,hR*0.05,0,headY,hR*1.05);
  hg.addColorStop(0,_lighten(skinCol,0.28));
  hg.addColorStop(1,skinCol);
  ctx2d.fillStyle=hg;
  ctx2d.beginPath();
  ctx2d.arc(0,headY,hR,0,Math.PI*2);
  ctx2d.fill();

  // –í–æ–ª–æ—Å—ã (—Ç—ë–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–µ, –≤–µ—Ä—Ö–Ω—è—è –ø–æ–ª—É–æ–∫—Ä—É–∂–Ω–æ—Å—Ç—å –∫–∞–∫ –Ω–∞ –∏–∫–æ–Ω–∫–µ)
  ctx2d.fillStyle=hairCol;
  ctx2d.beginPath();
  ctx2d.arc(0,headY-hR*0.12,hR*1.01,Math.PI,Math.PI*2);
  ctx2d.fill();
  // –ë–ª–∏–∫ –Ω–∞ –≤–æ–ª–æ—Å–∞—Ö
  ctx2d.fillStyle='rgba(255,255,255,0.2)';
  ctx2d.beginPath();
  ctx2d.ellipse(-hR*0.22,headY-hR*0.68,hR*0.28,hR*0.15,-0.4,0,Math.PI*2);
  ctx2d.fill();

  // –ë–µ–ª–∫–∏ –≥–ª–∞–∑
  ctx2d.fillStyle='#fff';
  ctx2d.beginPath();ctx2d.ellipse(-hR*0.33,headY-hR*0.07,hR*0.18,hR*0.14,0,0,Math.PI*2);ctx2d.fill();
  ctx2d.beginPath();ctx2d.ellipse( hR*0.33,headY-hR*0.07,hR*0.18,hR*0.14,0,0,Math.PI*2);ctx2d.fill();
  // –ó—Ä–∞—á–∫–∏
  ctx2d.fillStyle='#1a1a1a';
  ctx2d.beginPath();ctx2d.arc(-hR*0.33,headY-hR*0.07,hR*0.09,0,Math.PI*2);ctx2d.fill();
  ctx2d.beginPath();ctx2d.arc( hR*0.33,headY-hR*0.07,hR*0.09,0,Math.PI*2);ctx2d.fill();
  // –ë–ª–∏–∫–∏ –≤ –≥–ª–∞–∑–∞—Ö
  ctx2d.fillStyle='#fff';
  ctx2d.beginPath();ctx2d.arc(-hR*0.29,headY-hR*0.11,hR*0.035,0,Math.PI*2);ctx2d.fill();
  ctx2d.beginPath();ctx2d.arc( hR*0.37,headY-hR*0.11,hR*0.035,0,Math.PI*2);ctx2d.fill();

  // –†–æ–∑–æ–≤—ã–µ —â—ë–∫–∏ ‚Äî –í–°–ï–ì–î–ê –∫–∞–∫ –Ω–∞ –∏–∫–æ–Ω–∫–µ, —è—Ä—á–µ —É —Ç–æ–ª—Å—Ç—è–∫–∞
  const cheekA=0.35+fat*0.28;
  ctx2d.globalAlpha=cheekA;
  ctx2d.fillStyle='#ff8faa';
  ctx2d.beginPath();ctx2d.ellipse(-hR*0.66,headY+hR*0.13,hR*0.28,hR*0.18,0,0,Math.PI*2);ctx2d.fill();
  ctx2d.beginPath();ctx2d.ellipse( hR*0.66,headY+hR*0.13,hR*0.28,hR*0.18,0,0,Math.PI*2);ctx2d.fill();
  ctx2d.globalAlpha=1;

  // –†–æ—Ç
  ctx2d.strokeStyle=isHit?'#b03030':'#9a5040';
  ctx2d.lineWidth=hR*0.1;
  ctx2d.lineCap='round';
  ctx2d.beginPath();
  if(isHit){
    ctx2d.arc(0,headY+hR*0.38,hR*0.2,0.1,Math.PI-0.1,true); // –≥—Ä–∏–º–∞—Å–∞
  } else {
    ctx2d.arc(0,headY+hR*0.2,hR*0.2,0.25,Math.PI-0.25);     // —É–ª—ã–±–∫–∞
  }
  ctx2d.stroke();

  // ‚îÄ‚îÄ –ê–ö–°–ï–°–°–£–ê–†–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(acc==='crown'){
    ctx2d.fillStyle='#ffd700';
    ctx2d.fillRect(-hR*0.9,headY-hR*1.08,hR*1.8,hR*0.2);
    for(let i=0;i<5;i++){const sx=-hR*0.9+i*(hR*0.45);ctx2d.beginPath();ctx2d.moveTo(sx,headY-hR*1.08);ctx2d.lineTo(sx+hR*0.22,headY-hR*1.52);ctx2d.lineTo(sx+hR*0.45,headY-hR*1.08);ctx2d.fill();}
    ctx2d.fillStyle='#fff';[1,2,3].forEach(i=>{ctx2d.beginPath();ctx2d.arc(-hR*0.45+i*hR*0.45,headY-hR*1.0,hR*0.07,0,Math.PI*2);ctx2d.fill();});
  } else if(acc==='headband'||acc==='bandana'){
    ctx2d.fillStyle=acc==='headband'?'#ef4444':'#ff0000';
    ctx2d.fillRect(-hR*1.05,headY-hR*0.3,hR*2.1,hR*0.25);
  } else if(acc==='glasses'){
    ctx2d.strokeStyle='#222';ctx2d.lineWidth=hR*0.1;ctx2d.fillStyle='rgba(80,200,255,0.2)';
    ctx2d.beginPath();ctx2d.ellipse(-hR*0.33,headY-hR*0.06,hR*0.2,hR*0.14,0,0,Math.PI*2);ctx2d.fill();ctx2d.stroke();
    ctx2d.beginPath();ctx2d.ellipse( hR*0.33,headY-hR*0.06,hR*0.2,hR*0.14,0,0,Math.PI*2);ctx2d.fill();ctx2d.stroke();
    ctx2d.beginPath();ctx2d.moveTo(-hR*0.13,headY-hR*0.06);ctx2d.lineTo(hR*0.13,headY-hR*0.06);ctx2d.stroke();
  } else if(acc==='mask'){
    ctx2d.fillStyle='rgba(100,0,0,0.72)';ctx2d.beginPath();ctx2d.ellipse(0,headY+hR*0.05,hR*0.88,hR*0.62,0,0,Math.PI*2);ctx2d.fill();
    ctx2d.fillStyle='#ff2222';ctx2d.beginPath();ctx2d.arc(-hR*0.28,headY-hR*0.1,hR*0.1,0,Math.PI*2);ctx2d.fill();
    ctx2d.beginPath();ctx2d.arc(hR*0.28,headY-hR*0.1,hR*0.1,0,Math.PI*2);ctx2d.fill();
  } else if(acc==='chain'){
    ctx2d.strokeStyle='#ffd700';ctx2d.lineWidth=hR*0.13;
    ctx2d.beginPath();ctx2d.arc(0,headY+hR*0.85,hR*0.46,0.1,Math.PI-0.1);ctx2d.stroke();
    ctx2d.fillStyle='#ffd700';ctx2d.beginPath();ctx2d.arc(0,headY+hR*1.3,hR*0.13,0,Math.PI*2);ctx2d.fill();
  } else if(acc==='wings'){
    ctx2d.fillStyle='rgba(255,255,255,0.78)';
    ctx2d.beginPath();ctx2d.moveTo(-bW,-bH*0.22);ctx2d.bezierCurveTo(-bW*2.5,-bH*0.9,-bW*1.9,bH*0.3,-bW*1.05,bH*0.1);ctx2d.fill();
    ctx2d.beginPath();ctx2d.moveTo( bW,-bH*0.22);ctx2d.bezierCurveTo( bW*2.5,-bH*0.9, bW*1.9,bH*0.3, bW*1.05,bH*0.1);ctx2d.fill();
  }

  ctx2d.restore();
}

// Draw 2D fight ring
function drawRing(playerW, playerAnim, playerT, enemyIcon, enemyAnimT, pHpPct, eHpPct, enemy){
  const rc = document.getElementById('ringCanvas');
  if(!rc) return;
  const rctx = rc.getContext('2d');
  const rW = rc.offsetWidth || rc.width;
  const rH = rc.offsetHeight || rc.height;
  if(rc.width !== rW) rc.width = rW;
  if(rc.height !== rH) rc.height = rH;
  
  const pClothes = topColor ? topColor() : '#3b82f6';
  const pShoes = shoeColor ? shoeColor() : '#333';
  const pAcc = gs ? gs.activeAcc : null;
  
  // Background
  const grad = rctx.createLinearGradient(0,0,0,rH);
  grad.addColorStop(0,'#020008');
  grad.addColorStop(1,'#0e0025');
  rctx.fillStyle = grad;
  rctx.fillRect(0,0,rW,rH);
  
  // Ring floor
  rctx.fillStyle = '#0d0d2e';
  rctx.beginPath();
  rctx.ellipse(rW/2, rH*0.75, rW*0.45, rH*0.12, 0, 0, Math.PI*2);
  rctx.fill();
  
  // Ring ropes  
  const rCol = gs && gs.activeRingSkin ? (RING_SKINS.find(r=>r.id===gs.activeRingSkin)||{colors:{rope:0xff3d7f}}).colors.rope : 0xff3d7f;
  const rColStr = '#'+rCol.toString(16).padStart(6,'0');
  [0.55, 0.62, 0.69].forEach((yf, i)=>{
    rctx.strokeStyle = rColStr;
    rctx.lineWidth = 3-i;
    rctx.globalAlpha = 0.7-i*0.15;
    rctx.beginPath();
    rctx.ellipse(rW/2, rH*yf, rW*0.44, rH*0.09, 0, 0, Math.PI*2);
    rctx.stroke();
    rctx.globalAlpha = 1;
  });
  
  // Posts
  [[0.07,0.4],[0.93,0.4],[0.07,0.65],[0.93,0.65]].forEach(([xf,yf])=>{
    rctx.fillStyle = '#888';
    rctx.fillRect(rW*xf-3, rH*yf, 6, rH*0.2);
    rctx.fillStyle = '#ccc';
    rctx.beginPath();rctx.arc(rW*xf, rH*yf, 8, 0, Math.PI*2);rctx.fill();
  });

  // Player fighter (LEFT side ‚Äî facing right)
  rctx.save();
  const pCx = rW * 0.28, pCy = rH * 0.5;
  drawCharOn(rctx, pCx, pCy, rH*0.22, playerW, pClothes, pShoes, pAcc, false, playerAnim, playerT);
  rctx.restore();
  
  // Enemy fighter (RIGHT side ‚Äî mirrored, facing left)
  rctx.save();
  const eCx = rW * 0.72, eCy = rH * 0.5;
  // Enemy shake
  const eShake = enemyAnimT > 0 ? Math.sin(enemyAnimT * 30) * 5 : 0;
  rctx.translate(eCx + eShake, eCy);

  // Get boss visual data
  const bossData = enemy || {};
  const bossBodyCol = bossData.bodyCol || '#dc2626';
  const bossOutfit = bossData.outfit || '#991111';
  const bossSize = bossData.size || 1.0;
  const bossGlow = bossData.glow || null;
  const bossHat = bossData.hat || null;

  const esc = rH * 0.22 * bossSize;
  const enemyFat = Math.min(1, 0.3 + bossSize * 0.3);
  const ebw = esc*(0.28+enemyFat*0.22);
  const ebh = esc*(0.35+enemyFat*0.12);
  const ehR = esc*(0.14+enemyFat*0.04);

  // Glow aura for powerful bosses
  if(bossGlow){
    rctx.save();
    rctx.shadowColor = bossGlow;
    rctx.shadowBlur = 28 + Math.sin(pAnimT*3)*8;
    rctx.globalAlpha = 0.4;
    rctx.fillStyle = bossGlow;
    rctx.beginPath();rctx.ellipse(0,0,ebw*1.2,ebh*1.2,0,0,Math.PI*2);rctx.fill();
    rctx.restore();
  }

  // Body gradient
  const bg = rctx.createRadialGradient(-ebw*0.25,-ebh*0.28,ebw*0.04,0,0,ebw*1.3);
  bg.addColorStop(0, _lighten(bossOutfit,0.3));
  bg.addColorStop(0.5, bossOutfit);
  bg.addColorStop(1, _darken(bossOutfit,0.4));
  rctx.fillStyle = bg;
  rctx.beginPath();rctx.ellipse(0,0,ebw,ebh,0,0,Math.PI*2);rctx.fill();

  // Belly overlay
  if(enemyFat > 0.2){
    const bellyR = ebw*(0.35+enemyFat*0.35);
    const bellyY = ebh*(0.1+enemyFat*0.12);
    rctx.globalAlpha = enemyFat*1.1;
    rctx.fillStyle = bossOutfit;
    rctx.beginPath();rctx.arc(0,bellyY,bellyR,0,Math.PI*2);rctx.fill();
    rctx.globalAlpha = 1;
  }

  // Arms
  [[-1,0.8],[1,-0.8]].forEach(([s,armAngle])=>{
    rctx.save();
    rctx.translate(s*ebw*0.9,-ebh*0.05);
    rctx.rotate(armAngle * (0.4+Math.sin(pAnimT*2)*0.1));
    rctx.fillStyle = bossBodyCol;
    rctx.beginPath();
    rctx.moveTo(-ebw*0.1,0);rctx.lineTo(ebw*0.1,0);
    rctx.lineTo(ebw*0.08,esc*0.28);rctx.lineTo(-ebw*0.08,esc*0.28);rctx.closePath();rctx.fill();
    rctx.restore();
  });

  // Legs
  [[-1],[1]].forEach(([s])=>{
    rctx.save();
    rctx.translate(s*ebw*0.28,ebh*0.62);
    rctx.fillStyle = _darken(bossOutfit,0.2);
    rctx.beginPath();rctx.ellipse(0,esc*0.18,ebw*0.15,esc*0.22,0,0,Math.PI*2);rctx.fill();
    rctx.fillStyle = '#333';
    rctx.beginPath();rctx.ellipse(s*esc*0.02,esc*0.38,ebw*0.18,ebw*0.1,0,0,Math.PI*2);rctx.fill();
    rctx.restore();
  });

  // Head
  const headY = -(ebh+ehR*0.65);
  // Neck
  rctx.fillStyle = bossBodyCol;
  rctx.beginPath();rctx.roundRect(-ehR*0.28,headY+ehR*0.55,ehR*0.56,ehR*0.65,ehR*0.12);rctx.fill();
  // Head sphere
  const hg = rctx.createRadialGradient(-ehR*0.28,headY-ehR*0.28,ehR*0.05,0,headY,ehR*1.05);
  hg.addColorStop(0,_lighten(bossBodyCol,0.3));
  hg.addColorStop(1,bossBodyCol);
  rctx.fillStyle = hg;
  rctx.beginPath();rctx.arc(0,headY,ehR,0,Math.PI*2);rctx.fill();

  // Angry eyebrows
  rctx.strokeStyle = '#222';
  rctx.lineWidth = ehR*0.12;
  rctx.lineCap = 'round';
  // Left brow (slanted angry)
  rctx.beginPath();rctx.moveTo(-ehR*0.55,headY-ehR*0.28);rctx.lineTo(-ehR*0.12,headY-ehR*0.18);rctx.stroke();
  // Right brow
  rctx.beginPath();rctx.moveTo(ehR*0.55,headY-ehR*0.28);rctx.lineTo(ehR*0.12,headY-ehR*0.18);rctx.stroke();

  // Eyes (glowing angry)
  const eyeCol = bossGlow || '#ff0000';
  rctx.fillStyle = eyeCol;
  rctx.shadowColor = eyeCol; rctx.shadowBlur = 8;
  rctx.beginPath();rctx.ellipse(-ehR*0.33,headY-ehR*0.07,ehR*0.16,ehR*0.12,0,0,Math.PI*2);rctx.fill();
  rctx.beginPath();rctx.ellipse(ehR*0.33,headY-ehR*0.07,ehR*0.16,ehR*0.12,0,0,Math.PI*2);rctx.fill();
  rctx.shadowBlur = 0;
  // Pupils
  rctx.fillStyle = '#fff';
  rctx.beginPath();rctx.arc(-ehR*0.28,headY-ehR*0.08,ehR*0.05,0,Math.PI*2);rctx.fill();
  rctx.beginPath();rctx.arc(ehR*0.38,headY-ehR*0.08,ehR*0.05,0,Math.PI*2);rctx.fill();

  // Snarl / mouth
  rctx.strokeStyle = '#111';
  rctx.lineWidth = ehR*0.1;
  rctx.beginPath();rctx.arc(0,headY+ehR*0.36,ehR*0.22,0.15,Math.PI-0.15,true);rctx.stroke();
  // Fangs
  rctx.fillStyle = '#fff';
  rctx.beginPath();rctx.moveTo(-ehR*0.18,headY+ehR*0.28);rctx.lineTo(-ehR*0.12,headY+ehR*0.46);rctx.lineTo(-ehR*0.06,headY+ehR*0.28);rctx.fill();
  rctx.beginPath();rctx.moveTo(ehR*0.06,headY+ehR*0.28);rctx.lineTo(ehR*0.12,headY+ehR*0.46);rctx.lineTo(ehR*0.18,headY+ehR*0.28);rctx.fill();

  // Hat / icon label (mirrored back before text)
  rctx.scale(-1,1);
  if(bossHat){
    rctx.font = `${esc*0.3}px serif`;
    rctx.textAlign = 'center';
    rctx.fillText(bossHat, 0, headY - ehR*1.2);
  }
  // Boss name badge
  rctx.font = `bold ${esc*0.13}px Arial`;
  rctx.textAlign = 'center';
  rctx.fillStyle = bossGlow || '#ff4444';
  rctx.shadowColor = bossGlow || '#ff0000';
  rctx.shadowBlur = 6;
  const shortName = (bossData.name||'–í–†–ê–ì').replace(/^[^\s]+ /,'').substring(0,10);
  rctx.fillText(shortName, 0, headY - ehR*1.65);
  rctx.shadowBlur = 0;
  rctx.restore();
}

// Helper to draw char on a given context
// drawCharOn ‚Äî —Ä–∏—Å—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º canvas (–¥–ª—è —Ä–∏–Ω–≥–∞ –±–æ—è)
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ —Å—Ç–∏–ª—å —á—Ç–æ –∏ –≥–ª–∞–≤–Ω—ã–π drawChar
function drawCharOn(ctx, cx, cy, scale, weight, clothesCol, shoeCol, accId, isHit, animState, t){
  const fat  = Math.max(0, Math.min(1, (weight-60)/170));
  const lean = 1 - fat;
  const sc   = scale;
  const ta   = t || 0;

  let offY=0, lA=0, rA=0, lL=0, rL=0;
  if(animState==='idle'){offY=Math.sin(ta*2)*2;lA=-0.12;rA=0.12;}
  else if(animState==='punch'){lA=-0.5+Math.sin(ta*8)*0.9;rA=0.5-Math.sin(ta*8)*0.9;offY=Math.sin(ta*8)*3;}
  else if(animState==='kick'){lL=Math.sin(ta*7)*1.0;offY=Math.sin(ta*7)*2;}
  else if(animState==='spin'){lA=-1.5;rA=1.5;}
  else if(animState==='special'){lA=-1.3+Math.sin(ta*9)*0.5;rA=1.3-Math.sin(ta*9)*0.5;}
  else if(animState==='defend'){lA=-1.2;rA=1.2;}
  else if(animState==='hit'){offY=Math.sin(ta*20)*5;}
  else if(animState==='win'){lA=-1.5;rA=1.5;offY=-Math.abs(Math.sin(ta*4))*sc*0.1;}
  else if(animState==='lose'){offY=sc*0.3;}

  const bW  = sc*(0.29+fat*0.23);
  const bH  = sc*(0.34+fat*0.11);
  const hR  = sc*(0.155+fat*0.03);
  const armW= sc*0.10;
  const armH= sc*(0.28-fat*0.04);
  const legW= sc*(0.11+fat*0.035);
  const legH= sc*(0.25+fat*0.03);
  const skinCol = isHit ? '#e04444' : '#f0a870';
  const hairCol = '#6b2d0f';
  const bodyCol = (clothesCol && typeof clothesCol==='string' && clothesCol.startsWith('#')) ? clothesCol : '#4a8fe8';
  const shoeC   = (shoeCol   && typeof shoeCol==='string'   && shoeCol.startsWith('#'))   ? shoeCol   : '#f0f0f0';

  ctx.save();
  ctx.translate(cx, cy+offY);

  // –ù–æ–≥–∏
  [[-1,lL],[1,rL]].forEach(([s,lr])=>{
    ctx.save();ctx.translate(s*bW*0.30,bH*0.6);ctx.rotate(lr);
    ctx.fillStyle=skinCol;ctx.beginPath();ctx.ellipse(0,legH*0.38,legW*0.7,legH*0.48,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=shoeC;ctx.beginPath();ctx.ellipse(s*legW*0.1,legH*0.85,legW*1.1,legW*0.55,0.12*s,0,Math.PI*2);ctx.fill();
    ctx.restore();
  });

  // –†—É–∫–∏-—Ü–∏–ª–∏–Ω–¥—Ä—ã
  [[-1,lA],[1,rA]].forEach(([s,ar])=>{
    ctx.save();ctx.translate(s*bW*0.95,-bH*0.05);ctx.rotate(ar);
    ctx.fillStyle=skinCol;ctx.beginPath();ctx.ellipse(0,0,armW*0.85,armW*0.7,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=skinCol;
    ctx.beginPath();ctx.moveTo(-armW*0.52,0);ctx.lineTo(armW*0.52,0);ctx.lineTo(armW*0.35,armH);ctx.lineTo(-armW*0.35,armH);ctx.closePath();ctx.fill();
    ctx.restore();
  });

  // –¢–µ–ª–æ
  const bg=ctx.createRadialGradient(-bW*0.25,-bH*0.28,bW*0.04,bW*0.05,bH*0.1,bW*1.35);
  bg.addColorStop(0,_lighten(bodyCol,0.38));bg.addColorStop(0.45,bodyCol);bg.addColorStop(1,_darken(bodyCol,0.38));
  ctx.fillStyle=bg;ctx.beginPath();ctx.ellipse(0,0,bW,bH,0,0,Math.PI*2);ctx.fill();

  // –ñ–∏–≤–æ—Ç (–≤ –±–æ—é –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è ‚Äî isFight=true)
  if(fat>0.1){
    const bellyR=bW*(0.36+fat*0.38),bellyY=bH*(0.08+fat*0.14);
    ctx.fillStyle=bodyCol;ctx.globalAlpha=fat*1.3;
    ctx.beginPath();ctx.arc(0,bellyY,bellyR,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;
  }

  // –ú—ã—à—Ü—ã (–≤ –±–æ—é –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã)
  const mAlpha=Math.min(0.6,lean*0.5+0.35);
  ctx.globalAlpha=mAlpha;
  for(let row=0;row<3;row++) for(let col=0;col<2;col++){
    ctx.fillStyle=_lighten(bodyCol,0.22);ctx.beginPath();
    ctx.ellipse((col-0.5)*bW*0.36,(row-0.85)*bH*0.30,bW*0.13,bH*0.096,0,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;

  // –ì–æ–ª–æ–≤–∞
  const headY=-(bH+hR*0.68);
  ctx.fillStyle=skinCol;ctx.beginPath();ctx.roundRect(-hR*0.26,headY+hR*0.6,hR*0.52,hR*0.6,hR*0.13);ctx.fill();
  const hg=ctx.createRadialGradient(-hR*0.28,headY-hR*0.28,hR*0.05,0,headY,hR*1.05);
  hg.addColorStop(0,_lighten(skinCol,0.28));hg.addColorStop(1,skinCol);
  ctx.fillStyle=hg;ctx.beginPath();ctx.arc(0,headY,hR,0,Math.PI*2);ctx.fill();
  // –í–æ–ª–æ—Å—ã
  ctx.fillStyle=hairCol;ctx.beginPath();ctx.arc(0,headY-hR*0.12,hR*1.01,Math.PI,Math.PI*2);ctx.fill();
  // –ì–ª–∞–∑–∞
  ctx.fillStyle='#fff';ctx.beginPath();ctx.ellipse(-hR*0.33,headY-hR*0.07,hR*0.18,hR*0.14,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(hR*0.33,headY-hR*0.07,hR*0.18,hR*0.14,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#1a1a1a';ctx.beginPath();ctx.arc(-hR*0.33,headY-hR*0.07,hR*0.09,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(hR*0.33,headY-hR*0.07,hR*0.09,0,Math.PI*2);ctx.fill();
  // –©—ë–∫–∏
  ctx.globalAlpha=0.45+fat*0.25;ctx.fillStyle='#ff8faa';
  ctx.beginPath();ctx.ellipse(-hR*0.66,headY+hR*0.13,hR*0.28,hR*0.18,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(hR*0.66,headY+hR*0.13,hR*0.28,hR*0.18,0,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=1;
  // –†–æ—Ç
  ctx.strokeStyle=isHit?'#b03030':'#9a5040';ctx.lineWidth=hR*0.1;ctx.lineCap='round';
  ctx.beginPath();
  if(isHit){ctx.arc(0,headY+hR*0.38,hR*0.2,0.1,Math.PI-0.1,true);}
  else{ctx.arc(0,headY+hR*0.2,hR*0.2,0.25,Math.PI-0.25);}
  ctx.stroke();
  ctx.restore();
}

// Draw background scene (main canvas)
function drawBackground(){
  const lc = currentLocColor;
  // Sky gradient
  const g = ctx2d.createLinearGradient(0,0,0,H);
  g.addColorStop(0, lc.bg);
  g.addColorStop(0.6, lc.bg);
  g.addColorStop(1, lc.floor);
  ctx2d.fillStyle = g;
  ctx2d.fillRect(0,0,W,H);
  
  // Stars
  ctx2d.fillStyle = 'rgba(255,255,255,0.6)';
  for(let i=0;i<30;i++){
    const sx = ((i*137+31)%W);
    const sy = ((i*97+17)%(H*0.5));
    ctx2d.beginPath();
    ctx2d.arc(sx, sy, 0.8+Math.sin(i)*0.5, 0, Math.PI*2);
    ctx2d.fill();
  }
  
  // Floor
  ctx2d.fillStyle = lc.floor;
  ctx2d.fillRect(0, H*0.72, W, H*0.28);
  
  // Glow on floor
  const fg = ctx2d.createRadialGradient(W/2, H*0.72, 0, W/2, H*0.72, W*0.5);
  fg.addColorStop(0, lc.glow+'44');
  fg.addColorStop(1, 'transparent');
  ctx2d.fillStyle = fg;
  ctx2d.fillRect(0, H*0.6, W, H*0.4);
  
  // Grid lines on floor
  ctx2d.strokeStyle = lc.glow+'22';
  ctx2d.lineWidth = 1;
  for(let i=0;i<8;i++){
    ctx2d.beginPath();
    ctx2d.moveTo(0, H*0.72+i*H*0.04);
    ctx2d.lineTo(W, H*0.72+i*H*0.04);
    ctx2d.stroke();
  }
}

// Main render loop
let _lastT = 0;
function buildChar(weight){ /* just trigger redraw */ }

function loop(ts){
  const dt = Math.min((ts - _lastT)/1000, 0.05);
  _lastT = ts;
  anim.t = (anim.t||0) + dt;
  
  // Clear
  ctx2d.clearRect(0,0,W,H);
  
  drawBackground();
  
  // Update + draw particles
  _particles = _particles.filter(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.15;p.life-=dt*1.5;
    if(p.life<=0)return false;
    ctx2d.globalAlpha=p.life;
    ctx2d.fillStyle=p.col;
    ctx2d.beginPath();ctx2d.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);ctx2d.fill();
    ctx2d.globalAlpha=1;
    return true;
  });
  
  // Tap flash
  if(_tapFlash>0){
    ctx2d.fillStyle=`rgba(255,200,0,${_tapFlash*0.3})`;
    ctx2d.fillRect(0,0,W,H);
    _tapFlash-=dt*3;
  }
  
  // Draw character ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ UI –≤–∏–¥–∏–º (–∏–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞)
  if(gs && document.getElementById('ui').style.display==='block'){
    const cx = W/2;
    const cy = H * 0.52;
    const cWeight = gs.weight||230;
    const cClothes = topColor ? topColor() : '#3b82f6';
    const cShoes = shoeColor ? shoeColor() : '#333333';
    const cAcc = gs.activeAcc || null;
    
    // Convert hex number to CSS string
    function hexToCSS(hex){ return '#'+hex.toString(16).padStart(6,'0'); }
    
    drawChar(cx, cy, cWeight, 
      typeof cClothes==='number'?hexToCSS(cClothes):cClothes, 
      typeof cShoes==='number'?hexToCSS(cShoes):cShoes, 
      cAcc, _tapFlash>0.3, anim.action, anim.t,
      !!(fightState && !fightState.over));
  }
  
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// Tap on character in main screen OR training tap
cnv.addEventListener('click', function(e){
  if(!gs) return;
  
  // –ï—Å–ª–∏ –∏–¥—ë—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî —Ç–∞–ø –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–µ—ë
  if(mgS.active && !mgS.done){
    _mgDoTap();
    return;
  }
  
  const cx = W/2, cy = H*0.52;
  const sc = H*0.26;
  const fat = Math.max(0, Math.min(1, (gs.weight-60)/170));
  const bw = sc*(0.28+fat*0.22)*1.4;
  const bh = (sc*(0.35+fat*0.12) + sc*(0.14+fat*0.04)*2.5)*1.2;
  const tx = e.clientX - cx, ty = e.clientY - cy;
  if(Math.abs(tx) < bw && ty > -bh && ty < bh*0.7){
    _tapFlash = 0.8;
    spawnP(e.clientX, e.clientY, 0xffd700, 6);
    spawnP(e.clientX, e.clientY, 0xff3d7f, 4);
    // Reaction sound
    try{ const ac=new(window.AudioContext||window.webkitAudioContext)();const o=ac.createOscillator();const g=ac.createGain();o.connect(g);g.connect(ac.destination);o.frequency.value=150+Math.random()*100;g.gain.setValueAtTime(0.15,ac.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+0.2);o.start();o.stop(ac.currentTime+0.2); }catch(e){}
    // Show pain reaction
    notify('üò£ –ê–π! –ë–æ–ª—å–Ω–æ!');
    anim.action = 'hit_idle';
    setTimeout(()=>{ anim.action='idle'; }, 600);
  }
});
// Fix: touchstart ‚Üí —Ç–æ–ª—å–∫–æ _mgDoTap (–±–µ–∑ dispatchEvent –∫–æ—Ç–æ—Ä—ã–π –¥—É–±–ª–∏—Ä–æ–≤–∞–ª —Ç–∞–ø)
let _lastTouch = 0;
cnv.addEventListener('touchstart', function(e){
  const now = Date.now();
  if(now - _lastTouch < 80) return; // –¥–µ–±–∞—É–Ω—Å 80–º—Å
  _lastTouch = now;
  if(mgS.active && !mgS.done){
    e.preventDefault();
    _mgDoTap();
    return;
  }
  // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∞–ø–æ–≤ ‚Äî –ø—É—Å—Ç—å –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç click
},{passive:false});

// Fight ring renderer (2D)
let fightAnimId = null;
let fightState = null;
let pAnimState = 'idle', pAnimT = 0;
let eAnimState = 'idle', eAnimT = 0;
let eHitT = 0;


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRAINING MINIGAME ‚Äî AUTO PROGRESS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mgS={active:false,type:'',duration:4000,done:false,startTime:0,timer:null};
const MG_MOTIVS=['üí™ –î–ê–ô –ñ–ê–†—É!','üî• –ñ–ñ–Å–¢!','‚ö° –ë–´–°–¢–†–ï–ï!','üöÄ –í–ü–ï–†–Å–î!','üò§ –¢–ï–†–ü–ò!','üëä –ï–©–Å!','üí• –í–ó–†–´–í!','ü¶æ –ñ–ï–õ–ï–ó–û!','üèÜ –ß–ï–ú–ü–ò–û–ù!'];
let _motivTimer=null;
let _mgTaps=0; // —Å—á—ë—Ç—á–∏–∫ —Ç–∞–ø–æ–≤
let _mgMaxTaps=20; // —Å–∫–æ–ª—å–∫–æ —Ç–∞–ø–æ–≤ –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

function _updateMotiv(){
  const el=document.getElementById('mgMotiv');
  if(el) el.textContent=MG_MOTIVS[Math.floor(Math.random()*MG_MOTIVS.length)];
}

// –¢–∞–ø –ø–æ –∑–æ–Ω–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–æ—Å–∫—É
function _mgDoTap(){
  if(!mgS.active||mgS.done)return;
  _mgTaps++;
  const pct=Math.min(1,_mgTaps/_mgMaxTaps);
  const fill=document.getElementById('mgFill');
  const count=document.getElementById('mgCount');
  if(fill) fill.style.width=(pct*100)+'%';
  if(count) count.textContent=''; // –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
  // –í—Å–ø—ã—à–∫–∞ –∏ —á–∞—Å—Ç–∏—Ü—ã
  _tapFlash=0.4;
  spawnP(W/2+(Math.random()-0.5)*80, H*0.45-Math.random()*60,
    pct>0.75?0xff3d7f:pct>0.45?0xffd700:0x00ff88, 3);
  SND.tap();
  _updateMotiv();
  if(pct>=1){ _finishTraining(); }
}

function _mgTick(){
  // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∞–Ω–∏–º–∞—Ü–∏—é ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ–ø–µ—Ä—å –æ—Ç —Ç–∞–ø–æ–≤
  if(!mgS.active||mgS.done)return;
  mgS.timer=requestAnimationFrame(_mgTick);
}

function _finishTraining(){
  mgS.done=true;
  const cfg=GYM[mgS.type], mult=1+gs.locationId*0.12;
  if(!gs.infiniteEnergy) gs.energy=Math.max(0,gs.energy-cfg.e);
  gs.weight=cw(gs.weight-cfg.w*mult,gs);
  gs.coins+=Math.round(cfg.c*mult);
  gs.strength+=cfg.s;
  gs.trainCount++;
  updateHUD(); markDirty(); save();
  SND.trainDone();
  const fill=document.getElementById('mgFill'); if(fill) fill.style.width='100%';
  const count=document.getElementById('mgCount'); if(count) count.textContent='100%';
  const motiv=document.getElementById('mgMotiv'); if(motiv) motiv.textContent='üèÜ –ì–û–¢–û–í–û!';
  const inst=document.getElementById('mgInst');
  if(inst) inst.textContent='‚úÖ -'+(cfg.w*mult).toFixed(1)+'–∫–≥  +'+Math.round(cfg.c*mult)+'üí∞  +'+cfg.s+'üí™';
  for(let i=0;i<8;i++) setTimeout(()=>spawnP(W/2+(Math.random()-0.5)*80,H*0.4-Math.random()*100,Math.random()<0.5?0xffd700:0x00ff88,7),i*100);
  if(_motivTimer) clearInterval(_motivTimer);
  // Show badges again
  ['levelBadge','locBadge','charTag'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('hidden');});
  checkAchievements();
  setTimeout(()=>{
    document.getElementById('miniGame').classList.remove('open');
    document.getElementById('overlay').classList.remove('open');
    anim.action='idle';
  },1800);
}

function stopTraining(){
  if(!mgS.active)return;
  mgS.active=false; mgS.done=true;
  if(mgS.timer) cancelAnimationFrame(mgS.timer);
  if(_motivTimer) clearInterval(_motivTimer);
  ['levelBadge','locBadge','charTag'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('hidden');});
  document.getElementById('miniGame').classList.remove('open');
  document.getElementById('overlay').classList.remove('open');
  anim.action='idle';
}

function rest(){
  gs.energy=Math.min(gs.energy+40,gs.maxEnergy);
  SND.heal(); notify('üò¥ +40 —ç–Ω–µ—Ä–≥–∏–∏'); updateHUD(); markDirty(); save(); closeAll();
}

function startMG(type){
  const cfg=GYM[type];
  if(!cfg){notify('‚ùå –û—à–∏–±–∫–∞!');return;}
  if(gs.energy<cfg.e&&!gs.infiniteEnergy){notify('‚ùå –ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏! –û—Ç–¥–æ—Ö–Ω–∏.');return;}
  closeAll();
  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–ø–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (cfg.max = 1..10)
  _mgTaps=0;
  _mgMaxTaps=Math.max(6, Math.round(cfg.max*1.5));
  mgS={active:true,type,duration:0,done:false,startTime:Date.now(),timer:null};
  const title=document.getElementById('mgTitle'); if(title) title.textContent=cfg.title;
  const inst=document.getElementById('mgInst'); if(inst) inst.textContent='üëÜ –¢–∞–ø–∞–π –ø–æ —ç–∫—Ä–∞–Ω—É!';
  const count=document.getElementById('mgCount'); if(count) count.textContent='';
  const fill=document.getElementById('mgFill'); if(fill) fill.style.width='0%';
  const motiv=document.getElementById('mgMotiv'); if(motiv) motiv.textContent='üí™ –ù–∞—á–∞–ª–∏! –¢–∞–ø–∞–π!';
  document.getElementById('miniGame').classList.add('open');
  document.getElementById('overlay').classList.add('open');
  // Hide badges so animation is visible
  ['levelBadge','locBadge','charTag'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.add('hidden');});
  anim.action=cfg.anim;
  SND.tap();
  if(_motivTimer) clearInterval(_motivTimer);
  _motivTimer=setInterval(_updateMotiv, 1200);
  mgS.timer=requestAnimationFrame(_mgTick);
}



function openFight(){
  const enemies=makeEnemies(gs.rebirth);
  if(gs.wins>=enemies.length){notify('üèÜ –í—Å–µ –ø–æ–±–µ–∂–¥–µ–Ω—ã! –ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ!');openRebirth();return;}
  const enemy=enemies[gs.wins];
  const eHPMod=gs.enemyHPMod||1;
  const accB=getAccBonus();
  const pMaxHp=100+gs.gearBonus+Math.floor(gs.strength/2)+accB.hpBonus;
  fightState={
    pHp:pMaxHp,pMaxHp,
    eHp:Math.round(enemy.hp*eHPMod),
    eMaxHp:Math.round(enemy.hp*eHPMod),
    enemy,over:false,locked:false,defending:null,isPVP:false
  };
  const loc=LOCATIONS[gs.locationId];
  const ch=CHARACTERS.find(c=>c.id===gs.charId)||CHARACTERS[0];
  document.getElementById('fightLocName').textContent=loc.icon+' '+loc.name;
  document.getElementById('pName').textContent=ch.icon+' '+ch.name;
  document.getElementById('eName').textContent=enemy.name;
  updateFightHUD();
  buildFightBtns();
  document.getElementById('fightLog').innerHTML='';
  fightLog('‚öîÔ∏è '+enemy.name+' –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ä–∏–Ω–≥!');
  document.getElementById('fightScreen').style.display='flex';
  pAnimState='idle'; pAnimT=0; eAnimState='idle'; eHitT=0;
  openFightRingRenderer();
  SND.pvpFound();
}

function openFightRingRenderer(){
  const rc = document.getElementById('ringCanvas');
  if(!rc) return;
  rc.width = rc.offsetWidth || 400;
  rc.height = rc.offsetHeight || 300;
  
  let lastT = 0;
  function ringLoop(ts){
    if(!fightState || fightState.over){ 
      // Keep rendering idle state
    }
    const dt = Math.min((ts-lastT)/1000, 0.05);
    lastT = ts;
    pAnimT += dt;
    if(eHitT > 0) eHitT -= dt;
    
    drawRing(gs.weight||230, pAnimState, pAnimT, eHitT, fightState&&fightState.enemy, fightState);
    fightAnimId = requestAnimationFrame(ringLoop);
  }
  if(fightAnimId) cancelAnimationFrame(fightAnimId);
  fightAnimId = requestAnimationFrame(ringLoop);
}

function stopFightRing(){
  if(fightAnimId){ cancelAnimationFrame(fightAnimId); fightAnimId=null; }
}

function trigAnim(who, state, dur){
  if(who==='player'){ pAnimState=state; if(dur) setTimeout(()=>pAnimState='idle', dur*1000); }
  else { eAnimState=state; eHitT=dur||0.4; }
}


const LOCATIONS=[
  {id:0,name:'–î–µ—Ä–µ–≤–µ–Ω—Å–∫–∏–π —Å–∞—Ä–∞–π',icon:'üèöÔ∏è',bgC:0x1a0a2e,floorC:0x1a0f2e,neon:0xff3d7f,gyms:['bike','rope','barbell','squat'],desc:'–†–∂–∞–≤—ã–µ –≥–∞–Ω—Ç–µ–ª–∏ –∏ –ø—ã–ª—å–Ω—ã–π –ø–æ–ª'},
  {id:1,name:'–ì–æ—Ä–æ–¥—Å–∫–æ–π —Ñ–∏—Ç–Ω–µ—Å',icon:'üè¢',bgC:0x0a1a2e,floorC:0x0f1a30,neon:0x4488ff,gyms:['treadmill','pullup','boxing','rowing'],desc:'–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–ª—É–± –≤ —Ü–µ–Ω—Ç—Ä–µ'},
  {id:2,name:'–ü–ª—è–∂–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞',icon:'üèñÔ∏è',bgC:0x001a2e,floorC:0x0a1520,neon:0x00ccff,gyms:['swim','rope','squat','yoga'],desc:'–°–∏–Ω–∏–π –æ–∫–µ–∞–Ω –∏ –≥–æ—Ä—è—á–∏–π –ø–µ—Å–æ–∫'},
  {id:3,name:'–ì–æ—Ä–Ω–∞—è –≤–µ—Ä—à–∏–Ω–∞',icon:'‚õ∞Ô∏è',bgC:0x0a0a1e,floorC:0x0f0f25,neon:0xaaaaff,gyms:['pullup','barbell','treadmill','bike'],desc:'–†–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã–π –≤–æ–∑–¥—É—Ö'},
  {id:4,name:'–ü–æ–¥–∑–µ–º–Ω—ã–π –±—É–Ω–∫–µ—Ä',icon:'üèóÔ∏è',bgC:0x0d0d0d,floorC:0x111111,neon:0xffffff,gyms:['boxing','barbell','squat','pullup'],desc:'–°–µ–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–µ–Ω–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å'},
  {id:5,name:'–Ø–ø–æ–Ω—Å–∫–∏–π –¥–æ–¥–∑—ë',icon:'‚õ©Ô∏è',bgC:0x1a0808,floorC:0x1a0a0a,neon:0xff4444,gyms:['yoga','rope','boxing','swim'],desc:'–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ —Å–∞–º—É—Ä–∞–µ–≤'},
  {id:6,name:'–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–Ω—Ü–∏—è',icon:'üöÄ',bgC:0x000010,floorC:0x050510,neon:0x4466ff,gyms:['bike','rowing','treadmill','pullup'],desc:'–ù–µ–≤–µ—Å–æ–º–æ—Å—Ç—å'},
  {id:7,name:'–ê—Ä–∫—Ç–∏—á–µ—Å–∫–∞—è –±–∞–∑–∞',icon:'üßä',bgC:0x001020,floorC:0x00101e,neon:0x44ccff,gyms:['swim','treadmill','squat','barbell'],desc:'–•–æ–ª–æ–¥ –∑–∞–∫–∞–ª—è–µ—Ç'},
  {id:8,name:'–í—É–ª–∫–∞–Ω–∏—á–µ—Å–∫–∏–π –æ—Å—Ç—Ä–æ–≤',icon:'üåã',bgC:0x1a0500,floorC:0x1a0800,neon:0xff6622,gyms:['boxing','bike','yoga','rowing'],desc:'–õ–∞–≤–∞ –ø—Ä–∏–±–∞–≤–ª—è–µ—Ç —è—Ä–æ—Å—Ç–∏'},
  {id:9,name:'–û–ª–∏–º–ø–∏–π—Å–∫–∏–π —Å—Ç–∞–¥–∏–æ–Ω',icon:'üèüÔ∏è',bgC:0x0a1a00,floorC:0x0a1400,neon:0xaaff44,gyms:['treadmill','pullup','barbell','swim'],desc:'–§–∏–Ω–∞–ª—å–Ω–∞—è –∞—Ä–µ–Ω–∞ —á–µ–º–ø–∏–æ–Ω–æ–≤'},
];
const REBIRTH_RANKS=[{min:0,name:'–ù–æ–≤–∏—á–æ–∫',icon:'ü•â'},{min:3,name:'–ë–æ–µ—Ü',icon:'ü•ä'},{min:5,name:'–í–æ–∏–Ω',icon:'‚öîÔ∏è'},{min:8,name:'–ß–µ–º–ø–∏–æ–Ω',icon:'üèÜ'},{min:12,name:'–ú–∞—Å—Ç–µ—Ä',icon:'üíé'},{min:16,name:'–ì—Ä–∞–Ω–¥-–ú–∞—Å—Ç–µ—Ä',icon:'üëë'},{min:20,name:'–õ–µ–≥–µ–Ω–¥–∞',icon:'üåü'},{min:25,name:'–ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π',icon:'üíÄ'},{min:28,name:'–ë–û–ì',icon:'üêâ'},{min:30,name:'–ê–ë–°–û–õ–Æ–¢',icon:'‚ú®'}];
const CHARACTERS=[
  {id:'boris', name:'–ë–æ—Ä–∏—Å',  icon:'üê∑',col:0xffd1a3,bonus:'–°—Ç–∞–Ω–¥–∞—Ä—Ç',          fn:g=>{}},
  {id:'vasya', name:'–í–∞—Å—è',   icon:'üêª',col:0xc8956c,bonus:'+35% —Å–∏–ª–∞',          fn:g=>{g.strength=Math.floor(g.strength*1.35);}},
  {id:'fedya', name:'–§—ë–¥–æ—Ä', icon:'ü¶ä',col:0xe07b39,bonus:'+60% –º–æ–Ω–µ—Ç',          fn:g=>{g.coins=Math.floor(g.coins*1.6);}},
  {id:'kolya', name:'–ö–æ–ª—è',  icon:'üêÆ',col:0xdeb887,bonus:'+60 —ç–Ω–µ—Ä–≥–∏–∏',         fn:g=>{g.maxEnergy+=60;g.energy=g.maxEnergy;}},
  {id:'petya', name:'–ü–µ—Ç—è',  icon:'ü¶Å',col:0xcd853f,bonus:'–°–∏–ª–∞√ó1.4 +100üí∞',    fn:g=>{g.strength=Math.floor(g.strength*1.4);g.coins+=100;}},
  {id:'misha', name:'–ú–∏—à–∞',  icon:'üê∫',col:0x9a8a8a,bonus:'–£–¥–∞—Ä +25%',          fn:g=>{g.fightBonus=(g.fightBonus||0)+0.25;}},
  {id:'stepa', name:'–°—Ç—ë–ø–∞', icon:'ü¶ù',col:0x888888,bonus:'+80 —ç–Ω–µ—Ä–≥–∏–∏',        fn:g=>{g.energy=Math.min(g.energy+80,g.maxEnergy);}},
  {id:'grisha',name:'–ì—Ä–∏—à–∞', icon:'üêó',col:0xa0522d,bonus:'–ó–∞—â–∏—Ç–∞ +30%',         fn:g=>{g.defBonus=(g.defBonus||0)+0.3;}},
  {id:'dima',  name:'–î–∏–º–∞',  icon:'ü¶Ñ',col:0xffb3d9,bonus:'–í—Å—ë √ó1.5',           fn:g=>{g.strength=Math.floor(g.strength*1.5);g.coins+=150;g.maxEnergy+=30;g.energy=g.maxEnergy;}},
  {id:'maksim',name:'–ú–∞–∫—Å–∏–º',icon:'üêâ',col:0x50c878,bonus:'–í–°–Å √ó2',             fn:g=>{g.strength*=2;g.coins*=2;g.maxEnergy=Math.round(g.maxEnergy*1.5);g.energy=g.maxEnergy;}},
  {id:'ivan',  name:'–ò–≤–∞–Ω',  icon:'ü¶Ö',col:0x4169e1,bonus:'–ö—Ä–∏—Ç √ó2 (–†–±.5+)',    fn:g=>{g.critBonus=(g.critBonus||0)+1;}},
  {id:'olga',  name:'–û–ª—å–≥–∞', icon:'üå∫',col:0xff69b4,bonus:'–õ–µ—á–µ–Ω–∏–µ √ó2 (–†–±.5+)', fn:g=>{g.healBonus=(g.healBonus||0)+1;}},
  {id:'igor',  name:'–ò–≥–æ—Ä—å', icon:'ü¶à',col:0x008080,bonus:'–í–µ—Å -10–∫–≥ (–†–±.8+)',  fn:g=>{g.weight=Math.max(g.minWeight,g.weight-10);}},
  {id:'sasha', name:'–°–∞—à–∞',  icon:'üîÆ',col:0x9400d3,bonus:'–ú–∞–∫—Å–≠–Ω √ó1.5 (–†–±.10+)',fn:g=>{g.maxEnergy=Math.floor(g.maxEnergy*1.5);g.energy=g.maxEnergy;}},
  {id:'nina',  name:'–ù–∏–Ω–∞',  icon:'üåô',col:0x191970,bonus:'–ú–æ–Ω–µ—Ç—ã √ó3 (–†–±.12+)', fn:g=>{g.coins*=3;}},
  {id:'artem', name:'–ê—Ä—Ç—ë–º', icon:'‚ö°',col:0xffa500,bonus:'–°–∏–ª–∞ +50 (–†–±.15+)',   fn:g=>{g.strength+=50;}},
  {id:'lena',  name:'–õ–µ–Ω–∞',  icon:'üå∏',col:0xff1493,bonus:'–ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è (–†–±.18+)',fn:g=>{g.infiniteEnergy=true;}},
  {id:'kira',  name:'–ö–∏—Ä–∞',  icon:'üíÄ',col:0x2f2f2f,bonus:'–í—Ä–∞–≥–∏ -30% HP (–†–±.20+)',fn:g=>{g.enemyHPMod=0.7;}},
  {id:'zeus',  name:'–ó–µ–≤—Å',  icon:'‚ö°',col:0xffd700,bonus:'–í–°–Å √ó3 (–†–±.25+)',    fn:g=>{g.strength*=3;g.coins*=3;g.maxEnergy*=2;g.energy=g.maxEnergy;}},
  {id:'titan', name:'–¢–∏—Ç–∞–Ω', icon:'üåü',col:0xff4500,bonus:'–ê–ë–°–û–õ–Æ–¢ √ó5 (–†–±.28+)',fn:g=>{g.strength*=5;g.coins*=5;g.maxEnergy*=3;g.energy=g.maxEnergy;}},
];
const GYM={
  bike:     {title:'üö¥ –í–µ–ª–æ—Ç—Ä–µ–Ω–∞–∂—ë—Ä',    desc:'–ö—Ä—É—Ç–∏ –ø–µ–¥–∞–ª–∏!',        max:20,anim:'bike',   e:15,w:2.0,c:20,s:1},
  rope:     {title:'ü™¢ –°–∫–∞–∫–∞–ª–∫–∞',        desc:'–ü—Ä—ã–∂–∫–∏ ‚Äî –∂–≥–∏ –∂–∏—Ä!',    max:25,anim:'jump',   e:12,w:1.5,c:15,s:1},
  barbell:  {title:'üèãÔ∏è –®—Ç–∞–Ω–≥–∞',          desc:'–í—ã–∂–º–∏ –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π!',   max:12,anim:'lift',   e:20,w:1.0,c:35,s:4},
  treadmill:{title:'üèÉ –ë–µ–≥–æ–≤–∞—è –¥–æ—Ä–æ–∂–∫–∞', desc:'–ë–µ–≥–∏ ‚Äî –Ω–µ —Å—Ç–æ–π!',      max:28,anim:'run',    e:22,w:2.5,c:28,s:2},
  pullup:   {title:'ü§∏ –ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è',    desc:'–¢—è–Ω–∏ —Å–µ–±—è –≤–≤–µ—Ä—Ö!',     max:16,anim:'pullup', e:16,w:1.2,c:25,s:5},
  squat:    {title:'ü¶µ –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è',      desc:'–ù–∏–∂–µ! –î–æ —É–ø–æ—Ä–∞!',      max:20,anim:'squat',  e:18,w:1.8,c:22,s:4},
  swim:     {title:'üèä –ü–ª–∞–≤–∞–Ω–∏–µ',        desc:'–ì—Ä–µ–±–∏!',               max:18,anim:'swim',   e:22,w:3.0,c:30,s:3},
  boxing:   {title:'ü•ä –ë–æ–∫—Å—ë—Ä—Å–∫–∏–π –º–µ—à–æ–∫',desc:'–ë–ê–¶! –ü—Ä–æ–∫–∞—á–∞–π —É–¥–∞—Ä!', max:22,anim:'boxing', e:20,w:2.2,c:40,s:6},
  rowing:   {title:'üö£ –ì—Ä–µ–±–Ω–æ–π —Ç—Ä–µ–Ω–∞–∂—ë—Ä',desc:'–¢—è–Ω–∏ ‚Äî —Å–ø–∏–Ω–∞ –∏ —Ä—É–∫–∏!', max:16,anim:'rowing', e:18,w:2.0,c:28,s:3},
  yoga:     {title:'üßò –ô–æ–≥–∞',            desc:'–î—ã—à–∏. –†–∞—Å—Å–ª–∞–±–ª—è–π—Å—è.',  max:12,anim:'yoga',   e:8, w:1.0,c:18,s:2},
};
const DRINKS=[
  {id:'water',   name:'–í–æ–¥–∞',           icon:'üíß',price:30,   fx:'‚ö°+20',                fn:g=>{g.energy=Math.min(g.energy+20,  g.maxEnergy||100);}},
  {id:'coffee',  name:'–ö–æ—Ñ–µ',           icon:'‚òï',price:60,   fx:'‚ö°+35',                fn:g=>{g.energy=Math.min(g.energy+35,  g.maxEnergy||100);}},
  {id:'juice',   name:'–°–≤–µ–∂–∏–π —Å–æ–∫',     icon:'üçä',price:80,   fx:'‚ö°+30 ‚öñÔ∏è-0.5–∫–≥',      fn:g=>{g.energy=Math.min(g.energy+30,  g.maxEnergy||100);g.weight=cw(g.weight-0.5,g);}},
  {id:'energy',  name:'–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫',      icon:'‚ö°',price:120,  fx:'‚ö°+60',                fn:g=>{g.energy=Math.min(g.energy+60,  g.maxEnergy||100);}},
  {id:'protein', name:'–ü—Ä–æ—Ç–µ–∏–Ω',        icon:'ü•õ',price:180,  fx:'üí™+5 ‚ö°+40',           fn:g=>{g.strength+=5; g.energy=Math.min(g.energy+40,g.maxEnergy||100);}},
  {id:'bcaa',    name:'BCAA',           icon:'üü£',price:250,  fx:'üí™+7 ‚ö°+30',           fn:g=>{g.strength+=7; g.energy=Math.min(g.energy+30,g.maxEnergy||100);}},
  {id:'creatine',name:'–ö—Ä–µ–∞—Ç–∏–Ω',        icon:'üî¥',price:300,  fx:'üí™+12 ‚ö°+20',          fn:g=>{g.strength+=12;g.energy=Math.min(g.energy+20,g.maxEnergy||100);}},
  {id:'gainer',  name:'–ì–µ–π–Ω–µ—Ä',         icon:'üç´',price:350,  fx:'üí™+8 –ú–∞–∫—Å–≠–Ω+10 ‚ö°+25', fn:g=>{g.strength+=8; g.maxEnergy=(g.maxEnergy||100)+10;g.energy=Math.min(g.energy+25,g.maxEnergy);}},
  {id:'omega3',  name:'–û–º–µ–≥–∞-3',        icon:'üêü',price:200,  fx:'üí™+4 ‚öñÔ∏è-1–∫–≥ ‚ö°+15',   fn:g=>{g.strength+=4; g.weight=cw(g.weight-1,g);g.energy=Math.min(g.energy+15,g.maxEnergy||100);}},
  {id:'predwork',name:'–ü—Ä–µ–¥—Ç—Ä–µ–Ω–∏–∫',     icon:'üí•',price:400,  fx:'‚ö°+80 üí™+5',           fn:g=>{g.strength+=5; g.energy=Math.min(g.energy+80,g.maxEnergy||100);}},
  {id:'diet',    name:'–î–∏–µ—Ç-–∫–æ–∫—Ç–µ–π–ª—å',  icon:'ü•§',price:280,  fx:'‚öñÔ∏è-3–∫–≥ ‚ö°+20',        fn:g=>{g.weight=cw(g.weight-3,g);     g.energy=Math.min(g.energy+20,g.maxEnergy||100);}},
  {id:'shake',   name:'–ñ–∏—Ä–æ—Å–∂–∏–≥–∞—Ç–µ–ª—å',  icon:'üî•',price:600,  fx:'‚öñÔ∏è-6–∫–≥ ‚ö°+30',        fn:g=>{g.weight=cw(g.weight-6,g);     g.energy=Math.min(g.energy+30,g.maxEnergy||100);}},
  {id:'collagen',name:'–ö–æ–ª–ª–∞–≥–µ–Ω',       icon:'üå∏',price:450,  fx:'–ú–∞–∫—Å–≠–Ω+20 ‚ö°+25',      fn:g=>{g.maxEnergy=(g.maxEnergy||100)+20;g.energy=Math.min(g.energy+25,g.maxEnergy);}},
  {id:'dragon',  name:'–î—Ä–∞–∫–æ–Ω—å—è –∫—Ä–æ–≤—å', icon:'üêâ',price:1500, fx:'üí™+25 ‚öñÔ∏è-10–∫–≥ ‚ö°+50',  fn:g=>{g.strength+=25;g.weight=cw(g.weight-10,g);g.energy=Math.min(g.energy+50,g.maxEnergy||100);}},
  {id:'legend',  name:'–õ–µ–≥–µ–Ω–¥. –∑–µ–ª—å–µ',  icon:'‚ú®',price:3000, fx:'üí™+40 –ú–∞–∫—Å–≠–Ω+40 ‚ö°FULL',fn:g=>{g.strength+=40;g.maxEnergy=(g.maxEnergy||100)+40;g.energy=g.maxEnergy;}},
];
const CLOTHES=[
  // –¢–æ–ø—ã (–æ—Ç –¥–µ—à—ë–≤–æ–≥–æ –∫ –¥–æ—Ä–æ–≥–æ–º—É)
  {id:'shorts',       name:'–®–æ—Ä—Ç—ã',            icon:'ü©≥',price:0,    fx:'–°—Ç–∞–Ω–¥–∞—Ä—Ç',    cat:'top', col:0x3b82f6},
  {id:'tanktop',      name:'–ú–∞–π–∫–∞',            icon:'üëï',price:150,  fx:'–°–∏–ª–∞+5',      cat:'top', col:0xef4444},
  {id:'tracksuit',    name:'–°–ø–æ—Ä—Ç–∫–æ—Å—Ç—é–º',      icon:'üéΩ',price:350,  fx:'–°–∫–æ—Ä+10%',    cat:'top', col:0x22c55e},
  {id:'gi',           name:'–ö–∏–º–æ–Ω–æ',           icon:'ü•ã',price:500,  fx:'–ö—Ä–∏—Ç+10%',    cat:'top', col:0xffffff},
  {id:'champion_belt',name:'–ß–µ–º–ø.–∫–æ—Å—Ç—é–º',      icon:'üèÖ',price:800,  fx:'–ó–∞—â–∏—Ç–∞+25%',  cat:'top', col:0xffd700},
  {id:'ninja',        name:'–ö–æ—Å—Ç—é–º –Ω–∏–Ω–¥–∑—è',    icon:'ü•∑',price:1200, fx:'–ö—Ä–∏—Ç+15%',    cat:'top', col:0x1f2937},
  {id:'hero',         name:'–ö–æ—Å—Ç—é–º –≥–µ—Ä–æ—è',     icon:'ü¶∏',price:2000, fx:'–í—Å—ë+20%',     cat:'top', col:0xef4444},
  {id:'samurai',      name:'–î–æ—Å–ø–µ—Ö–∏ —Å–∞–º—É—Ä–∞—è',  icon:'‚öîÔ∏è',price:3500, fx:'–£–¥–∞—Ä+40%',    cat:'top', col:0xb91c1c},
  {id:'golden',       name:'–ó–æ–ª–æ—Ç–æ–π –∫–æ—Å—Ç—é–º',   icon:'‚ú®',price:5000, fx:'–í—Å—ë√ó1.3',     cat:'top', col:0xfbbf24},
  {id:'cyber_suit',   name:'–ö–∏–±–µ—Ä-–¥–æ—Å–ø–µ—Ö',     icon:'ü§ñ',price:7500, fx:'–°–∏–ª–∞+30%',    cat:'top', col:0x00e5ff},
  {id:'dragon_robe',  name:'–û–¥–µ—è–Ω–∏–µ –î—Ä–∞–∫–æ–Ω–∞',  icon:'üêâ',price:12000,fx:'–£–¥–∞—Ä+50%',    cat:'top', col:0xff4500},
  // –û–±—É–≤—å
  {id:'barefoot',     name:'–ë–æ—Å–∏–∫–æ–º',          icon:'ü¶∂',price:0,    fx:'–ü—Ä–∏—Ä–æ–¥–∞',     cat:'shoe',col:0xffd1a3},
  {id:'sneakers',     name:'–ö—Ä–æ—Å—Å–æ–≤–∫–∏',        icon:'üëü',price:200,  fx:'–°–∫–æ—Ä+10',     cat:'shoe',col:0xffffff},
  {id:'boots',        name:'–ë–æ—Ç–∏–Ω–∫–∏',          icon:'üë¢',price:400,  fx:'–ü–∏–Ω–æ–∫+20',    cat:'shoe',col:0x5c3317},
  {id:'ninja_boots',  name:'–ë–æ—Ç–∏–Ω–∫–∏ –Ω–∏–Ω–¥–∑—è',  icon:'ü•æ',price:1000, fx:'–ö—Ä–∏—Ç+20%',    cat:'shoe',col:0x1f2937},
  {id:'rocket',       name:'–†–µ–∞–∫—Ç–∏–≤–Ω—ã–µ',       icon:'üöÄ',price:3000, fx:'–°–∫–æ—Ä√ó5',      cat:'shoe',col:0xef4444},
  {id:'golden_boots', name:'–ó–æ–ª–æ—Ç—ã–µ –±—É—Ç—Å—ã',    icon:'‚≠ê',price:6000, fx:'–ú–æ–Ω–µ—Ç—ã+15%',  cat:'shoe',col:0xffd700},
  // –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã
  {id:'headband',     name:'–ü–æ–≤—è–∑–∫–∞',          icon:'üéóÔ∏è',price:100,  fx:'–§–æ–∫—É—Å+10',   cat:'acc', col:0xef4444},
  {id:'bandana',      name:'–ë–∞–Ω–¥–∞–Ω–∞',          icon:'ü©π',price:300,  fx:'HP+20',       cat:'acc', col:0xff0000},
  {id:'glasses',      name:'–ö—Ä—É—Ç—ã–µ –æ—á–∫–∏',      icon:'üòé',price:500,  fx:'–ö—Ä—É—Ç–æ—Å—Ç—å',    cat:'acc', col:0x111111},
  {id:'mask',         name:'–ú–∞—Å–∫–∞ –≤–æ–∏–Ω–∞',      icon:'üé≠',price:1500, fx:'–°—Ç—Ä–∞—Ö+15%',   cat:'acc', col:0x6b0000},
  {id:'chain',        name:'–ó–æ–ª–æ—Ç–∞—è —Ü–µ–ø—å',     icon:'üìø',price:2500, fx:'–ú–æ–Ω–µ—Ç—ã+20%',  cat:'acc', col:0xffd700},
  {id:'crown',        name:'–ö–æ—Ä–æ–Ω–∞ —á–µ–º–ø–∏–æ–Ω–∞',  icon:'üëë',price:8000, fx:'–ö–æ—Ä–æ–ª—å',      cat:'acc', col:0xfbbf24},
  {id:'wings',        name:'–ö—Ä—ã–ª—å—è –∞–Ω–≥–µ–ª–∞',    icon:'ü™Ω',price:15000,fx:'–í—Å—ë+25%',     cat:'acc', col:0xffffff},
];
const GEAR=[
  {id:'gloves',name:'–ë–æ–∫—Å—ë—Ä—Å–∫–∏–µ –ø–µ—Ä—á–∞—Ç–∫–∏',icon:'ü•ä',price:60, fx:'–£–¥–∞—Ä+15'},
  {id:'wraps', name:'–ë–∏–Ω—Ç—ã',              icon:'ü©π',price:30, fx:'–ó–∞—â–∏—Ç–∞+5'},
  {id:'belt',  name:'–ü–æ—è—Å —á–µ–º–ø–∏–æ–Ω–∞',      icon:'üèÖ',price:120,fx:'–ó–∞—â–∏—Ç–∞+20'},
  {id:'helmet',name:'–®–ª–µ–º',              icon:'‚õëÔ∏è',price:150,fx:'–ó–∞—â–∏—Ç–∞√ó2'},
  {id:'armor', name:'–ù–∞–≥—Ä—É–¥–Ω–∏–∫',          icon:'ü¶∫',price:200,fx:'HP+50'},
  {id:'ring',  name:'–ö–æ–ª—å—Ü–æ —Å–∏–ª—ã',        icon:'üíç',price:300,fx:'–í—Å–µ+10%'},
  {id:'amulet',name:'–ê–º—É–ª–µ—Ç —É–¥–∞—á–∏',       icon:'üçÄ',price:250,fx:'–ö—Ä–∏—Ç√ó2'},
];
const RING_SKINS=[
  {id:'classic',  name:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', icon:'ü•ä',price:0,   desc:'–°—Ç–∞–Ω–¥–∞—Ä—Ç',       colors:{floor:0x0d0d2e,rope:0xff3d7f,glow:0xff3d7f}},
  {id:'gold',     name:'–ó–æ–ª–æ—Ç–æ–π',      icon:'‚≠ê',price:300, desc:'+5% –∫ —É—Ä–æ–Ω—É',    colors:{floor:0x1a1000,rope:0xffd700,glow:0xffd700}},
  {id:'cyber',    name:'–ö–∏–±–µ—Ä',        icon:'ü§ñ',price:500, desc:'+10% –∫ —É—Ä–æ–Ω—É',   colors:{floor:0x000a1a,rope:0x00e5ff,glow:0x00e5ff}},
  {id:'fire',     name:'–û–≥–Ω–µ–Ω–Ω—ã–π',     icon:'üî•',price:700, desc:'+15% –∫ —É—Ä–æ–Ω—É',   colors:{floor:0x1a0500,rope:0xff6600,glow:0xff3300}},
  {id:'galaxy',   name:'–ì–∞–ª–∞–∫—Ç–∏–∫–∞',    icon:'üåå',price:1000,desc:'+20% –∫ —É—Ä–æ–Ω—É',   colors:{floor:0x000010,rope:0x8800ff,glow:0xaa00ff}},
  {id:'champion', name:'–ß–µ–º–ø–∏–æ–Ω',      icon:'üëë',price:2000,desc:'+25% –∫ —É—Ä–æ–Ω—É',   colors:{floor:0x0a0800,rope:0xffd700,glow:0xffd700}},
  {id:'neon',     name:'–ù–µ–æ–Ω',         icon:'üíú',price:400, desc:'+8% –∫ —É—Ä–æ–Ω—É',    colors:{floor:0x080020,rope:0xff00ff,glow:0xff00ff}},
  {id:'ice',      name:'–õ–µ–¥—è–Ω–æ–π',      icon:'üßä',price:600, desc:'+12% –∫ —É—Ä–æ–Ω—É',   colors:{floor:0x001a2a,rope:0x00ccff,glow:0x00ccff}},
  {id:'blood',    name:'–ö—Ä–æ–≤–∞–≤—ã–π',     icon:'ü©∏',price:900, desc:'+18% –∫ —É—Ä–æ–Ω—É',   colors:{floor:0x1a0000,rope:0xff0000,glow:0xff0000}},
  {id:'dragon',   name:'–î—Ä–∞–∫–æ–Ω',       icon:'üêâ',price:1500,desc:'+22% –∫ —É—Ä–æ–Ω—É',   colors:{floor:0x0a1500,rope:0xff4500,glow:0xff6600}},
];
const ACHIEVEMENTS=[
  {id:'first_train',  name:'–ü–µ—Ä–≤—ã–π —à–∞–≥',       icon:'üë£',desc:'–°–¥–µ–ª–∞–π –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É',   target:1,   stat:'trainCount',reward:50,  type:'coins'},
  {id:'train_100',    name:'–¢—Ä–µ–Ω–∞–∂—ë—Ä–Ω—ã–π –º–∞–Ω—å—è–∫',icon:'üí™',desc:'100 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',             target:100, stat:'trainCount',reward:200, type:'coins'},
  {id:'train_500',    name:'–ñ–µ–ª–µ–∑–Ω—ã–π —á–µ–ª–æ–≤–µ–∫',  icon:'üèãÔ∏è',desc:'500 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',             target:500, stat:'trainCount',reward:1000,type:'coins'},
  {id:'first_win',    name:'–ü–µ—Ä–≤–∞—è –ø–æ–±–µ–¥–∞',     icon:'ü•ä',desc:'–ü–æ–±–µ–¥–∏ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞',   target:1,   stat:'wins',      reward:100, type:'coins'},
  {id:'wins_10',      name:'–î–µ—Å—è—Ç–∫–∞',           icon:'üèÜ',desc:'10 –ø–æ–±–µ–¥',                   target:10,  stat:'wins',      reward:300, type:'coins'},
  {id:'wins_50',      name:'–ß–µ–º–ø–∏–æ–Ω',           icon:'üëë',desc:'50 –ø–æ–±–µ–¥',                   target:50,  stat:'wins',      reward:1000,type:'coins'},
  {id:'rebirth_1',    name:'–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ',      icon:'üî•',desc:'–ü–µ—Ä–≤–æ–µ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ',        target:1,   stat:'rebirth',   reward:200, type:'coins'},
  {id:'rebirth_10',   name:'–ú–∞—Å—Ç–µ—Ä –∂–∏–∑–Ω–µ–π',     icon:'üíé',desc:'10 –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–π',            target:10,  stat:'rebirth',   reward:1000,type:'coins'},
  {id:'rebirth_30',   name:'–ê–ë–°–û–õ–Æ–¢',           icon:'‚ú®',desc:'30 –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–π!',           target:30,  stat:'rebirth',   reward:9999,type:'coins'},
  {id:'weight_100',   name:'–ü–µ—Ä–≤—ã–π —à–∞–≥',        icon:'‚öñÔ∏è',desc:'–ü–æ—Ö—É–¥–µ–π –¥–æ 100 –∫–≥',          target:100, stat:'weightLoss',reward:300, type:'coins'},
  {id:'weight_60',    name:'–ò–î–ï–ê–õ–¨–ù–´–ô –í–ï–°',     icon:'üåü',desc:'–ü–æ—Ö—É–¥–µ–π –¥–æ 60 –∫–≥!',          target:170, stat:'weightLoss',reward:2000,type:'coins'},
  {id:'pvp_win',      name:'–ë–æ–µ—Ü –∞—Ä–µ–Ω—ã',        icon:'üåê',desc:'–í—ã–∏–≥—Ä–∞–π –≤—ã–∑–æ–≤ –Ω–∞ –∞—Ä–µ–Ω–µ',      target:1,   stat:'pvpWins',   reward:500, type:'coins'},
  {id:'guild_join',   name:'–ö–æ–º–∞–Ω–¥–Ω—ã–π –∏–≥—Ä–æ–∫',   icon:'‚öîÔ∏è',desc:'–í—Å—Ç—É–ø–∏ –≤ –≥–∏–ª—å–¥–∏—é',           target:1,   stat:'guildMember',reward:200,type:'coins'},
  {id:'rich',         name:'–ë–æ–≥–∞—á',             icon:'üí∞',desc:'–ù–∞–∫–æ–ø–∏ 10,000 –º–æ–Ω–µ—Ç',         target:10000,stat:'coins',   reward:1000,type:'coins'},
  {id:'strength_100', name:'–°–∏–ª–∞—á',             icon:'üí•',desc:'–°–∏–ª–∞ 100',                   target:100, stat:'strength',  reward:500, type:'coins'},
];
const GUILD_MEMBERS_PRESET=[
  {name:'–ë—Ä–∞—Ç—å—è–ë—Ä–æ—Å–∫–∏', icon:'üê∑',weight:89, strength:340,wins:88, rank:'–õ–∏–¥–µ—Ä',   online:true},
  {name:'–°—Ç–∞–ª—å–Ω–æ–π–ö—É–ª–∞–∫',icon:'ü¶Å',weight:72, strength:420,wins:145,rank:'–û—Ñ–∏—Ü–µ—Ä',  online:true},
  {name:'–ñ–∏—Ä–Ω—è–∫–ü–æ–±–µ–¥–∏—Ç',icon:'üêª',weight:120,strength:180,wins:22, rank:'–£—á–∞—Å—Ç–Ω–∏–∫',online:false},
  {name:'–ö–∞—á–∫–æ–≤–°—Ç–µ–ø–∞–Ω', icon:'üèãÔ∏è',weight:65, strength:500,wins:200,rank:'–û—Ñ–∏—Ü–µ—Ä',  online:true},
  {name:'–¢–æ–ª—Å—Ç—è–∫5000',  icon:'üêÆ',weight:180,strength:90, wins:5,  rank:'–£—á–∞—Å—Ç–Ω–∏–∫',online:false},
];
const PVP_LEADERBOARD_PRESET=[
  {name:'–¢–û–õ–°–¢–Ø–ö_–ß–ï–ú–ü', icon:'üëë',rating:2850, char:'titan'},
  {name:'–°—Ç–∞–ª—å–Ω–æ–π–ö—É–ª–∞–∫',icon:'üíÄ',rating:2540, char:'zeus'},
  {name:'–ö–∞—á–∫–æ–≤–°—Ç–µ–ø–∞–Ω', icon:'‚ö°',rating:2310, char:'artem'},
  {name:'–ñ–∏—Ä–Ω—è–∫–ü–æ–±–µ–¥–∏—Ç',icon:'üíé',rating:1980, char:'kira'},
  {name:'–ë—Ä–∞—Ç—å—è–ë—Ä–æ—Å–∫–∏', icon:'üî•',rating:1750, char:'maksim'},
  {name:'–¢–æ–ø–ë–æ–∫—Å—ë—Ä',    icon:'ü•ä',rating:1420, char:'misha'},
  {name:'–¢–æ–ª—Å—Ç—è–∫5000',  icon:'üê∑',rating:1200, char:'boris'},
  {name:'–ù–æ–≤–∏—á–æ–∫–ü–µ—Ç—è',  icon:'ü§°',rating:980,  char:'vasya'},
];
// –°–∏–º—É–ª—è—Ü–∏—è –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ RuStore (–Ω–æ–≤—ã–µ —Å–∫–∞—á–∞–≤—à–∏–µ)
const RUSTORE_PLAYERS = [
  {name:'–ò–≥–æ—Ä—å_–¢–æ–ª—Å—Ç—ã–π',  icon:'üêó',rating:1050, char:'grisha',   online:true,  timeAgo:'2 –º–∏–Ω'},
  {name:'–ú–µ–≥–∞–ë–æ–∫—Å—ë—Ä_88',  icon:'ü¶Å',rating:1180, char:'petya',    online:true,  timeAgo:'5 –º–∏–Ω'},
  {name:'–°–ø–æ—Ä—Ç–∏–∫2025',    icon:'üèãÔ∏è',rating:820,  char:'kolya',    online:false, timeAgo:'12 –º–∏–Ω'},
  {name:'–î—è–¥—è–í–æ–≤–∞_–§–∏—Ç',   icon:'üêÆ',rating:1320, char:'fedya',    online:true,  timeAgo:'1 –º–∏–Ω'},
  {name:'–ß–µ–º–ø–∏–æ–Ω–°–∞—à–∞',    icon:'ü¶ä',rating:950,  char:'dima',     online:true,  timeAgo:'8 –º–∏–Ω'},
  {name:'–ö—Ä—É—Ç–æ–π–ë–æ—Ä–µ—Ü',    icon:'üêª',rating:1090, char:'vasya',    online:false, timeAgo:'15 –º–∏–Ω'},
  {name:'–ù–æ–≤—ã–π–ò–≥—Ä–æ–∫_777', icon:'üåü',rating:720,  char:'boris',    online:true,  timeAgo:'3 –º–∏–Ω'},
  {name:'–ö–∞—á–∞–µ–º–°—è–ú–æ—â–Ω–æ',  icon:'üí™',rating:1260, char:'stepa',    online:true,  timeAgo:'7 –º–∏–Ω'},
  {name:'–¢–æ–ª—Å—Ç–æ–¥–∞–≤99',    icon:'üê∑',rating:870,  char:'boris',    online:true,  timeAgo:'4 –º–∏–Ω'},
  {name:'–°–∏–ª–∞–ñ–µ–ª–µ–∑–∞',     icon:'‚ö°',rating:1140, char:'artem',    online:false, timeAgo:'20 –º–∏–Ω'},
];
// –ê–∫—Ç–∏–≤–Ω—ã–µ –≤—ã–∑–æ–≤—ã (—Å–∏–º—É–ª—è—Ü–∏—è)
let _activeChallenges = [];
function makeEnemies(rb){
  const m=1+rb*0.5;
  return[
    {n:'üêî –ö—É—Ä–∏–Ω—ã–π –í–∞—Å—è',   hp:60, a:5, d:1, r:15, bodyCol:'#FFD700',outfit:'#ff8c00',hat:'üêî',size:0.85},
    {n:'üê∑ –ñ–∏—Ä–Ω—ã–π –ü–µ—Ç—è',   hp:80, a:8, d:2, r:20, bodyCol:'#FFB6C1',outfit:'#ff69b4',hat:'üê∑',size:1.2},
    {n:'ü§° –ö–ª–æ—É–Ω –ì—Ä–∏—à–∞',   hp:90, a:9, d:2, r:25, bodyCol:'#FF4500',outfit:'#ff0044',hat:'ü§°',size:0.95,glow:'#ff0066'},
    {n:'üß∏ –ü–ª—é—à–µ–≤—ã–π –î–∏–º–∞', hp:100,a:10,d:3, r:30, bodyCol:'#D2691E',outfit:'#8B4513',hat:'üéÄ',size:1.1},
    {n:'üêª –ú–µ–¥–≤–µ–¥—å –ú–∏—Ç—è',  hp:120,a:12,d:4, r:35, bodyCol:'#5C3317',outfit:'#3a1f0a',hat:'üêæ',size:1.3},
    {n:'ü§º –ë–æ—Ä–µ—Ü –ö–æ–ª—è',    hp:130,a:13,d:5, r:40, bodyCol:'#DC143C',outfit:'#8B0000',hat:'ü•ä',size:1.35},
    {n:'ü¶Ü –£—Ç–∫–∞ –§–µ–¥—è',     hp:110,a:14,d:3, r:38, bodyCol:'#DAA520',outfit:'#b8860b',hat:'ü¶Ü',size:0.9},
    {n:'ü•ä –ë–æ–∫—Å—ë—Ä –ò–≥–æ—Ä—å',  hp:140,a:16,d:5, r:50, bodyCol:'#2F4F4F',outfit:'#1a2f2f',hat:'ü•ä',size:1.25},
    {n:'üêÆ –ë—ã—á–æ–∫ –°—Ç—ë–ø–∞',   hp:150,a:15,d:7, r:55, bodyCol:'#8B4513',outfit:'#a0522d',hat:'ü§†',size:1.2},
    {n:'ü¶Å –õ—ë–≤–∞ –†—ã–∫–∞–ª–æ–≤',  hp:160,a:18,d:6, r:60, bodyCol:'#DAA520',outfit:'#ff8c00',hat:'üëë',size:1.15},
    {n:'ü§ñ –†–æ–±–æ—Ç –¢–µ—Ä–º-3',  hp:170,a:19,d:8, r:65, bodyCol:'#708090',outfit:'#00e5ff',hat:'‚öôÔ∏è',size:1.1,glow:'#00e5ff'},
    {n:'üßü –ó–æ–º–±–∏ –ê–Ω–¥—Ä–µ–π',  hp:180,a:20,d:6, r:70, bodyCol:'#4a7a4a',outfit:'#2d5a2d',hat:'üíÄ',size:1.05,glow:'#00ff44'},
    {n:'üëπ –û–≥—Ä –ë—É–≥–∞–π',     hp:200,a:22,d:9, r:80, bodyCol:'#8B0000',outfit:'#4a0000',hat:'üò§',size:1.4,glow:'#ff2200'},
    {n:'ü¶ä –•–∏—Ç—Ä–µ—Ü –õ–∏—Å',    hp:175,a:24,d:7, r:85, bodyCol:'#FF6347',outfit:'#cc4400',hat:'üé©',size:1.0},
    {n:'üèãÔ∏è –ö–∞—á–æ–∫ –ú–∞–∫—Å',   hp:210,a:23,d:10,r:90, bodyCol:'#2F4F4F',outfit:'#1a2f2f',hat:'ü•ä',size:1.35},
    {n:'üêâ –î—Ä–∞–∫–æ—à–∞ –°–ª–∞–π',  hp:220,a:25,d:10,r:100,bodyCol:'#006400',outfit:'#003200',hat:'üî•',size:1.3,glow:'#ff4400'},
    {n:'‚ö° –ú–æ–ª–Ω–∏—è –ü–µ—Ç—Ä–æ–≤',  hp:200,a:27,d:8, r:105,bodyCol:'#4B0082',outfit:'#2d006b',hat:'‚ö°',size:1.1,glow:'#aa00ff'},
    {n:'ü¶à –ê–∫—É–ª–∞ –†–æ–º–∞',    hp:230,a:26,d:11,r:110,bodyCol:'#1C6EA4',outfit:'#0d4a7a',hat:'üåä',size:1.2,glow:'#0088ff'},
    {n:'ü•∑ –ù–∏–Ω–¥–∑—è –ö–µ–Ω',    hp:215,a:29,d:9, r:115,bodyCol:'#1a1a1a',outfit:'#000000',hat:'üó°Ô∏è',size:1.0},
    {n:'üî• –§–∞–∫–µ–ª –í–∞–Ω—è',    hp:240,a:28,d:12,r:120,bodyCol:'#FF4500',outfit:'#cc2200',hat:'üî•',size:1.25,glow:'#ff6600'},
    {n:'üëæ –ü—Ä–∏—à–µ–ª–µ—Ü X9',   hp:260,a:30,d:13,r:130,bodyCol:'#7B68EE',outfit:'#4b38ee',hat:'üëæ',size:1.3,glow:'#8844ff'},
    {n:'ü¶ç –ì–æ—Ä–∏–ª–ª–∞ –ö–æ–Ω–≥',  hp:280,a:32,d:14,r:140,bodyCol:'#3d2b1f',outfit:'#2a1a0f',hat:'ü¶ç',size:1.6},
    {n:'üå™Ô∏è –°–º–µ—Ä—á –û–ª–µ–≥',    hp:270,a:34,d:12,r:150,bodyCol:'#808080',outfit:'#505050',hat:'üå™Ô∏è',size:1.3,glow:'#aaaaff'},
    {n:'üè¥‚Äç‚ò†Ô∏è –ü–∏—Ä–∞—Ç –î–∂–µ–∫',  hp:290,a:33,d:15,r:160,bodyCol:'#4a2f00',outfit:'#1a0f00',hat:'‚ò†Ô∏è',size:1.15},
    {n:'üíÄ –ú–µ—Ä—Ç–≤—è–∫ –ì—Ä–∞—Ñ',  hp:310,a:36,d:14,r:170,bodyCol:'#1a0a2a',outfit:'#0a0015',hat:'ü¶á',size:1.2,glow:'#8800cc'},
    {n:'ü¶Ç –°–∫–æ—Ä–ø–∏–æ–Ω –ó–µ–¥',  hp:320,a:38,d:16,r:185,bodyCol:'#8B0000',outfit:'#550000',hat:'ü¶Ç',size:1.25,glow:'#ff0000'},
    {n:'üåã –í—É–ª–∫–∞–Ω –ë–æ—Ä–∏—Å',  hp:350,a:40,d:17,r:200,bodyCol:'#8B0000',outfit:'#4a0000',hat:'üåã',size:1.5,glow:'#ff4400'},
    {n:'ü§¥ –ü—Ä–∏–Ω—Ü –¢—å–º—ã',    hp:380,a:42,d:18,r:220,bodyCol:'#1a0028',outfit:'#0d0015',hat:'üëë',size:1.4,glow:'#9900ff'},
    {n:'üßô –ú–∞–≥ –†–∞–∑—Ä—É—à–∏—Ç–µ–ª—å',hp:400,a:45,d:20,r:250,bodyCol:'#00008B',outfit:'#000055',hat:'üßô',size:1.45,glow:'#0055ff'},
    {n:'üëë –ß–ï–ú–ü–ò–û–ù –ú–ò–†–ê',  hp:500,a:50,d:25,r:500,bodyCol:'#8B0000',outfit:'#ffd700',hat:'üëë',size:1.7,glow:'#ffd700'},
  ].map(e=>({name:e.n,hp:Math.round(e.hp*m),atk:Math.round(e.a*m),def:Math.round(e.d*m),reward:Math.round(e.r*m)}));
}
const DAILY_REWARDS=[
  {icon:'üí∞',label:'+80 –º–æ–Ω–µ—Ç',  fn:g=>{g.coins+=80;}},
  {icon:'‚ö°',label:'+60 —ç–Ω–µ—Ä–≥–∏–∏',fn:g=>{g.energy=Math.min(g.energy+60,g.maxEnergy);}},
  {icon:'üí™',label:'+8 —Å–∏–ª—ã',    fn:g=>{g.strength+=8;}},
  {icon:'‚öñÔ∏è',label:'-3 –∫–≥',      fn:g=>{g.weight=cw(g.weight-3,g);}},
  {icon:'üéÅ',label:'+150 –º–æ–Ω–µ—Ç', fn:g=>{g.coins+=150;}},
  {icon:'üîã',label:'–ú–∞–∫—Å–≠–Ω+20', fn:g=>{g.maxEnergy+=20;}},
  {icon:'üëë',label:'+250üí∞+15üí™',fn:g=>{g.coins+=250;g.strength+=15;}},
];
const TIME_REWARDS=[
  {mins:2, icon:'‚è±Ô∏è',title:'2 –º–∏–Ω—É—Ç—ã!',  reward:'+30 –º–æ–Ω–µ—Ç',      fn:g=>{g.coins+=30;}},
  {mins:5, icon:'üïê',title:'5 –º–∏–Ω—É—Ç!',   reward:'+60 –º–æ–Ω–µ—Ç',      fn:g=>{g.coins+=60;}},
  {mins:10,icon:'‚ö°',title:'10 –º–∏–Ω—É—Ç!',  reward:'+3 —Å–∏–ª—ã',         fn:g=>{g.strength+=3;}},
  {mins:30,icon:'üî•',title:'–ü–æ–ª—á–∞—Å–∞!',   reward:'+200üí∞ +5üí™',    fn:g=>{g.coins+=200;g.strength+=5;}},
  {mins:60,icon:'üèÜ',title:'1 —á–∞—Å!',     reward:'+500 –º–æ–Ω–µ—Ç!',    fn:g=>{g.coins+=500;}},
  {mins:120,icon:'üíé',title:'2 —á–∞—Å–∞!',   reward:'+1000 –º–æ–Ω–µ—Ç!',   fn:g=>{g.coins+=1000;}},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE & SAVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SAVE_KEY='fatboy_v4_rustore';
let gs={
  weight:230,maxWeight:230,minWeight:60,
  energy:100,maxEnergy:100,
  coins:150,strength:15,
  wins:0,losses:0,trainCount:0,
  rebirth:0,locationId:0,charId:'boris',
  ownedClothes:['shorts','barefoot'],
  activeClothes:'shorts',activeShoes:'barefoot',activeAcc:null,
  ownedGear:[],gearBonus:0,
  activeRingSkin:'classic',ownedRingSkins:['classic'],
  lastDailyClaim:0,dailyStreak:0,
  totalPlayTime:0,lastTimeReward:0,
  sessionStart:Date.now(),
  pvpRating:1000,pvpWins:0,pvpLosses:0,
  guildName:null,guildId:null,guildMember:0,
  achDone:[],
  fightBonus:0,defBonus:0,critBonus:0,healBonus:0,
  infiniteEnergy:false,enemyHPMod:1,
  _baseTime:0,
};
let _dirty=false,_lastSave=0;
function markDirty(){_dirty=true;}
function cw(v,g){return parseFloat(Math.max(g.minWeight,Math.min(g.maxWeight||230,v)).toFixed(1));}
function getPlayTime(){return(gs._baseTime||0)+Math.floor((Date.now()-gs.sessionStart)/1000);}
function save(){
  try{
    gs.totalPlayTime=getPlayTime();
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    if(typeof gs.weight!=='number'||isNaN(gs.weight))gs.weight=230;
    if(typeof gs.strength!=='number'||isNaN(gs.strength))gs.strength=10;
    if(typeof gs.coins!=='number'||isNaN(gs.coins))gs.coins=0;
    if(typeof gs.energy!=='number'||isNaN(gs.energy))gs.energy=gs.maxEnergy||100;
    if(gs.coins<0)gs.coins=0;
    if(gs.strength<1)gs.strength=1;
    localStorage.setItem(SAVE_KEY,JSON.stringify(gs));
    _dirty=false;_lastSave=Date.now();
    const el=document.getElementById('saveInd');
    if(el){el.textContent='üíæ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ';el.classList.add('on');setTimeout(()=>el.classList.remove('on'),1500);}
  }catch(e){console.warn('Save error:',e);}
}
function load(){
  try{
    const s=localStorage.getItem(SAVE_KEY);
    if(s){
      const p=JSON.parse(s);
      // –ú–µ—Ä–∂–∏–º —Ç–æ–ª—å–∫–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–ª—è, –∑–∞—â–∏—â–∞—è –æ—Ç –±–∏—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      const safe=Object.assign({},gs);
      Object.keys(p).forEach(k=>{
        if(k in safe&&p[k]!==null&&p[k]!==undefined&&!Number.isNaN(p[k])){
          safe[k]=p[k];
        }
      });
      Object.assign(gs,safe);
      // –ü–æ—Å—Ç-–≤–∞–ª–∏–¥–∞—Ü–∏—è
      if(gs.weight<gs.minWeight||gs.weight>gs.maxWeight+50)gs.weight=230;
      if(gs.energy>gs.maxEnergy*2)gs.energy=gs.maxEnergy;
      if(gs.strength<0)gs.strength=10;
      if(gs.coins<0)gs.coins=0;
      if(!Array.isArray(gs.ownedClothes))gs.ownedClothes=['shorts','barefoot'];
      if(!Array.isArray(gs.ownedRingSkins))gs.ownedRingSkins=['classic'];
      if(!Array.isArray(gs.achDone))gs.achDone=[];
      gs._baseTime=gs.totalPlayTime||0;
      gs.sessionStart=Date.now();
    }
  }catch(e){console.warn('Load error:',e);gs.sessionStart=Date.now();}
}
setInterval(()=>{if(_dirty||Date.now()-_lastSave>30000)save();},5000);
document.addEventListener('visibilitychange',()=>{
  if(document.hidden){
    save();
    stopBgMusic();
  } else {
    if(_musicEnabled) startBgMusic();
  }
});
window.addEventListener('pagehide',()=>{save();stopBgMusic();});
window.addEventListener('beforeunload',()=>{save();stopBgMusic();});

function getRank(){
  const rb=gs.rebirth||0;
  let rank=REBIRTH_RANKS[0];
  for(const r of REBIRTH_RANKS){if(rb>=r.min)rank=r;}
  return rank;
}

// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–≤–µ—Ç –æ–¥–µ–∂–¥—ã (–≤–µ—Ä—Ö) –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
function topColor(){
  const item=CLOTHES.find(c=>c.id===gs.activeClothes&&c.cat==='top');
  if(!item||!item.col)return'#3b82f6';
  return '#'+item.col.toString(16).padStart(6,'0');
}
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–≤–µ—Ç –æ–±—É–≤–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
function shoeColor(){
  const item=CLOTHES.find(c=>c.id===gs.activeShoes&&c.cat==='shoe');
  if(!item||!item.col)return'#f0f0f0';
  return '#'+item.col.toString(16).padStart(6,'0');
}
// –ë–æ–Ω—É—Å—ã –æ—Ç —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
function getAccBonus(){
  let hpBonus=0,atkBonus=0,defBonus=0;
  const acc=CLOTHES.find(c=>c.id===gs.activeAcc);
  if(acc&&acc.id==='bandana')hpBonus+=7;   // –±—ã–ª–æ 20 ‚Üí /3
  if(acc&&acc.id==='wings')hpBonus+=8;     // –±—ã–ª–æ 25 ‚Üí /3
  if(acc&&acc.id==='headband')atkBonus+=3; // –§–æ–∫—É—Å+10 ‚Üí /3
  if(acc&&acc.id==='mask')defBonus+=5;     // –°—Ç—Ä–∞—Ö+15% ‚Üí /3
  if(acc&&acc.id==='crown'){atkBonus+=5;defBonus+=5;hpBonus+=5;} // –ö–æ—Ä–æ–ª—å /3
  if(acc&&acc.id==='chain')hpBonus+=3;     // –º–æ–Ω–µ—Ç—ã ‚Äî –Ω–µ–±–æ–ª—å—à–æ–π –±–æ–Ω—É—Å hp
  if(acc&&acc.id==='glasses')atkBonus+=2;  // –∫—Ä—É—Ç–æ—Å—Ç—å

  // –ë–æ–Ω—É—Å—ã –æ—Ç —Ç–æ–ø–∞ (–æ–¥–µ–∂–¥—ã) ‚Äî —É–º–µ–Ω—å—à–µ–Ω—ã –≤ 3 —Ä–∞–∑–∞
  const top=CLOTHES.find(c=>c.id===gs.activeClothes&&c.cat==='top');
  if(top){
    if(top.id==='tanktop')   atkBonus+=2;           // –°–∏–ª–∞+5 ‚Üí ~+2
    if(top.id==='tracksuit') atkBonus+=3;           // –°–∫–æ—Ä+10% ‚Üí ~+3
    if(top.id==='gi')        atkBonus+=3;           // –ö—Ä–∏—Ç+10% ‚Üí ~+3
    if(top.id==='champion_belt'){defBonus+=8;}      // –ó–∞—â–∏—Ç–∞+25% ‚Üí ~+8
    if(top.id==='ninja')     atkBonus+=5;           // –ö—Ä–∏—Ç+15% ‚Üí ~+5
    if(top.id==='hero')      {atkBonus+=7;defBonus+=7;hpBonus+=7;} // –í—Å—ë+20% ‚Üí /3
    if(top.id==='samurai')   atkBonus+=13;          // –£–¥–∞—Ä+40% ‚Üí ~+13
    if(top.id==='golden')    {atkBonus+=10;defBonus+=10;hpBonus+=10;} // –í—Å—ë√ó1.3 ‚Üí /3
    if(top.id==='cyber_suit')atkBonus+=10;          // –°–∏–ª–∞+30% ‚Üí /3
    if(top.id==='dragon_robe')atkBonus+=17;         // –£–¥–∞—Ä+50% ‚Üí /3
  }

  // –ë–æ–Ω—É—Å—ã –æ—Ç –æ–±—É–≤–∏ ‚Äî —É–º–µ–Ω—å—à–µ–Ω—ã –≤ 3 —Ä–∞–∑–∞
  const shoe=CLOTHES.find(c=>c.id===gs.activeShoes&&c.cat==='shoe');
  if(shoe){
    if(shoe.id==='sneakers')  atkBonus+=3;          // –°–∫–æ—Ä+10 ‚Üí +3
    if(shoe.id==='boots')     atkBonus+=7;          // –ü–∏–Ω–æ–∫+20 ‚Üí +7
    if(shoe.id==='ninja_boots')atkBonus+=7;         // –ö—Ä–∏—Ç+20% ‚Üí +7
    if(shoe.id==='rocket')    atkBonus+=5;          // –°–∫–æ—Ä√ó5 ‚Üí +5
    if(shoe.id==='golden_boots')hpBonus+=5;         // –ú–æ–Ω–µ—Ç—ã+15% ‚Üí –Ω–µ–±–æ–ª—å—à–æ–π hp –±–æ–Ω—É—Å
  }

  (gs.ownedGear||[]).forEach(gid=>{
    const g=GEAR.find(x=>x.id===gid);
    if(!g)return;
    if(g.id==='wraps')defBonus+=5;
    if(g.id==='gloves')atkBonus+=15;
    if(g.id==='belt')defBonus+=20;
    if(g.id==='helmet')defBonus+=30;
    if(g.id==='armor')hpBonus+=50;
    if(g.id==='ring'){atkBonus+=10;defBonus+=10;hpBonus+=10;}
    if(g.id==='amulet')atkBonus+=15;
  });
  return{hpBonus,atkBonus,defBonus};
}

// –û–±–Ω–æ–≤–∏—Ç—å HUD –±–æ—è
function updateFightHUD(){
  if(!fightState)return;
  const pPct=Math.max(0,fightState.pHp/fightState.pMaxHp*100);
  const ePct=Math.max(0,fightState.eHp/fightState.eMaxHp*100);
  const pFill=document.getElementById('pHpBar');
  const eFill=document.getElementById('eHpBar');
  const pHpEl=document.getElementById('pHpTxt');
  const eHpEl=document.getElementById('eHpTxt');
  if(pFill)pFill.style.width=pPct+'%';
  if(eFill)eFill.style.width=ePct+'%';
  if(pHpEl)pHpEl.textContent=Math.max(0,Math.round(fightState.pHp))+'/'+fightState.pMaxHp+' HP';
  if(eHpEl)eHpEl.textContent=Math.max(0,Math.round(fightState.eHp))+'/'+fightState.eMaxHp+' HP';
}

// –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –±–æ—è
function buildFightBtns(){
  const c=document.getElementById('fightBtns');
  if(!c)return;
  c.innerHTML=`
    <button class="fight-btn fb-punch" onclick="doFightAction('punch')">üëä –£–¥–∞—Ä</button>
    <button class="fight-btn fb-sp" onclick="doFightAction('special')">‚ö° –°–ø–µ—Ü.</button>
    <button class="fight-btn fb-def" onclick="doFightAction('defend')">üõ°Ô∏è –ë–ª–æ–∫</button>
    <button class="fight-btn fb-hl" onclick="doFightAction('heal')">üíä –ê–ø—Ç–µ—á–∫–∞</button>
    <button class="fight-btn fb-sk" onclick="doFightAction('spinKick')">üåÄ –í–µ—Ä—Ç—É—à–∫–∞</button>
    <button class="fight-btn fb-punch" onclick="doFightAction('kick')" style="background:linear-gradient(135deg,#ff6b00,#ff3d7f);">ü¶∂ –ü–∏–Ω–æ–∫</button>
  `;
}

// renderShop ‚Äî —Ä–µ–Ω–¥–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞
function renderShop(){
  switchTab('drinks');
}
function getPVPRank(rating){
  if(rating>=2500)return{name:'–ê–ë–°–û–õ–Æ–¢',icon:'‚ú®'};
  if(rating>=2000)return{name:'–ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π',icon:'üíÄ'};
  if(rating>=1700)return{name:'–õ–µ–≥–µ–Ω–¥–∞',icon:'üåü'};
  if(rating>=1400)return{name:'–ì—Ä–∞–Ω–¥-–ú–∞—Å—Ç–µ—Ä',icon:'üëë'};
  if(rating>=1200)return{name:'–ú–∞—Å—Ç–µ—Ä',icon:'üíé'};
  if(rating>=1000)return{name:'–ß–µ–º–ø–∏–æ–Ω',icon:'üèÜ'};
  if(rating>=800) return{name:'–í–æ–∏–Ω',icon:'‚öîÔ∏è'};
  return{name:'–ë–æ–µ—Ü',icon:'ü•ä'};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACHIEVEMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkAchievements(){
  ACHIEVEMENTS.forEach(ach=>{
    if(gs.achDone.includes(ach.id))return;
    let val=0;
    if(ach.stat==='trainCount')val=gs.trainCount;
    else if(ach.stat==='wins')val=gs.wins;
    else if(ach.stat==='rebirth')val=gs.rebirth;
    else if(ach.stat==='weightLoss')val=230-gs.weight;
    else if(ach.stat==='pvpWins')val=gs.pvpWins||0;
    else if(ach.stat==='guildMember')val=gs.guildMember||0;
    else if(ach.stat==='coins')val=gs.coins;
    else if(ach.stat==='strength')val=gs.strength;
    if(val>=ach.target){
      gs.achDone.push(ach.id);
      if(ach.type==='coins'){gs.coins+=ach.reward;updateHUD();}
      notify('üèÖ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: '+ach.name+'! +'+ach.reward+'üí∞');
      markDirty();save();
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAILY REWARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkDailyReward(){
  const lastDate=new Date(gs.lastDailyClaim||0),today=new Date();
  if(lastDate.toDateString()===today.toDateString())return;
  const hoursSince=(Date.now()-(gs.lastDailyClaim||0))/3600000;
  if(hoursSince>48)gs.dailyStreak=0;
  openDailyPopup();
}
function openDailyPopup(){
  const streak=gs.dailyStreak||0,idx=streak%7,r=DAILY_REWARDS[idx];
  const cont=document.getElementById('dailyDays');cont.innerHTML='';
  for(let i=0;i<7;i++){
    const d=document.createElement('div');
    d.className='ds-day'+(i<idx%7?' claimed':i===idx?' today':'');
    d.innerHTML='<span>'+DAILY_REWARDS[i].icon+'</span><span class="ds-n">–î'+(i+1)+'</span>';
    cont.appendChild(d);
  }
  document.getElementById('dailySub').textContent='–°–µ—Ä–∏—è: '+streak+' '+(streak>=7?'üèÜ':streak>=3?'üî•':'‚≠ê')+' –¥–Ω–µ–π';
  document.getElementById('drbIcon').textContent=r.icon;
  document.getElementById('drbLabel').textContent=r.label;
  document.getElementById('drbDesc').textContent='–î–µ–Ω—å '+(idx+1)+' –∏–∑ 7';
  const btn=document.getElementById('claimBtn');btn.disabled=false;btn.textContent='‚ú® –ó–ê–ë–†–ê–¢–¨!';
  document.getElementById('dailyPopup').classList.add('open');
}
function claimDaily_inner(){
  const idx=(gs.dailyStreak||0)%7,r=DAILY_REWARDS[idx];
  r.fn(gs);gs.dailyStreak=(gs.dailyStreak||0)+1;gs.lastDailyClaim=Date.now();
  buildChar(gs.weight);updateHUD();markDirty();save();
  SND.daily();
  const btn=document.getElementById('claimBtn');btn.textContent='‚úÖ –ü–æ–ª—É—á–µ–Ω–æ!';btn.disabled=true;
  notify(r.icon+' '+r.label+'!');
  setTimeout(closeDailyPopup_inner,1200);
}
// –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
window.claimDaily = claimDaily_inner;
function closeDailyPopup_inner(){document.getElementById('dailyPopup').classList.remove('open');}
window.closeDailyPopup = closeDailyPopup_inner;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TIME REWARDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pendingTR=null;
function checkTimeRewards(){
  const mins=getPlayTime()/60,rewMins=(gs.lastTimeReward||0)/60;
  for(const tr of TIME_REWARDS){
    if(tr.mins>rewMins&&tr.mins<=mins){
      gs.lastTimeReward=tr.mins*60;pendingTR=tr;
      document.getElementById('ttIcon').textContent=tr.icon;
      document.getElementById('ttTitle').textContent=tr.title;
      document.getElementById('ttRew').textContent=tr.reward;
      document.getElementById('timeToast').classList.add('open');
      break;
    }
  }
}
function collectTimeReward_inner(){
  if(!pendingTR)return;
  pendingTR.fn(gs);buildChar(gs.weight);updateHUD();markDirty();save();
  SND.coin();
  notify(pendingTR.icon+' '+pendingTR.reward+'!');
  document.getElementById('timeToast').classList.remove('open');pendingTR=null;
}
window.collectTimeReward = collectTimeReward_inner;
window.renderPVPScreen = function(t){ renderPVPScreen(t); };
window.checkQuestsProgress = function(){ if(typeof checkQuestsProgress==='function') checkQuestsProgress(); };
setInterval(checkTimeRewards,30000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 3D –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ Canvas 2D


function trigAnim(fighter,anObj,action,dur){
  anObj.action=action;anObj.t=0;
  if(dur)setTimeout(()=>{anObj.action='idle';anObj.t=0;},dur*1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PVP SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pvpSearchTimer=null;

function openPVP(){
  const ch=CHARACTERS.find(c=>c.id===gs.charId)||CHARACTERS[0];
  const rating = gs.pvpRating||1000;
  document.getElementById('pvpRatingNum').textContent=rating;
  const rank=getPVPRank(rating);
  document.getElementById('pvpRankName').textContent=rank.icon+' '+rank.name;
  document.getElementById('pvpMyIcon').textContent=ch.icon;
  document.getElementById('pvpMyName').textContent='–¢—ã';
  document.getElementById('pvpMyRat').textContent='‚≠ê '+rating;
  // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞
  const searching=document.getElementById('pvpSearching');
  searching.style.cssText='display:none;position:absolute;inset:0;background:rgba(0,5,16,0.95);flex-direction:column;align-items:center;justify-content:center;gap:16px;';
  // –í–µ—à–∞–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ touch —Å–æ–±—ã—Ç–∏–π –û–î–ò–ù –†–ê–ó –Ω–∞ pvpContent
  const cont=document.getElementById('pvpContent');
  if(cont && !cont._pvpTouchDelegated){
    cont._pvpTouchDelegated=true;
    cont.addEventListener('touchend',function(e){
      const btn=e.target.closest('button,[onclick]');
      if(!btn)return;
      e.preventDefault();
      e.stopPropagation();
      // –í—ã–∑—ã–≤–∞–µ–º onclick –Ω–∞–ø—Ä—è–º—É—é –µ—Å–ª–∏ –µ—Å—Ç—å
      const oc=btn.getAttribute('onclick');
      if(oc){ try{eval(oc);}catch(err){console.warn(err);} }
      else btn.click();
    },{passive:false});
  }
  // –†–µ–Ω–¥–µ—Ä–∏–º PVP –∫–æ–Ω—Ç–µ–Ω—Ç —Å –≤–∫–ª–∞–¥–∫–∞–º–∏
  renderPVPScreen('leaderboard');
  document.getElementById('pvpScreen').classList.add('open');
  SND.click();
  // –ß–µ—Ä–µ–∑ 10—Å —Å–∏–º—É–ª–∏—Ä—É–µ–º –≤—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤
  if(!gs._challengeSimTimer){
    gs._challengeSimTimer = setTimeout(simulateIncomingChallenge, 8000 + Math.random()*12000);
  }
}

function closePVP(){
  document.getElementById('pvpScreen').classList.remove('open');
  cancelPVPSearch();
}

let _pvpTab = 'leaderboard';
function renderPVPScreen(tab){
  if(tab) _pvpTab = tab;
  const cont = document.getElementById('pvpContent');
  if(!cont) return;
  const tabs = [
    {id:'leaderboard', label:'üèÜ –†–µ–π—Ç–∏–Ω–≥'},
    {id:'players',     label:'üåê –ò–≥—Ä–æ–∫–∏'},
    {id:'challenges',  label:'‚öîÔ∏è –í—ã–∑–æ–≤—ã' + (_activeChallenges.length > 0 ? ` (${_activeChallenges.length})` : '')},
  ];
  const tabHtml = `<div style="display:flex;gap:6px;width:100%;margin-bottom:10px;">
    ${tabs.map(t=>`<button onclick="renderPVPScreen('${t.id}')" style="flex:1;padding:8px 4px;background:${_pvpTab===t.id?'linear-gradient(135deg,rgba(0,229,255,0.2),rgba(0,100,200,0.2))':'rgba(255,255,255,0.04)'};border:1.5px solid ${_pvpTab===t.id?'rgba(0,229,255,0.5)':'rgba(255,255,255,0.08)'};border-radius:10px;color:${_pvpTab===t.id?'#00e5ff':'#555'};font-size:9px;font-weight:700;cursor:pointer;">${t.label}</button>`).join('')}
  </div>`;
  let bodyHtml = '';
  if(_pvpTab === 'leaderboard'){
    const myRating = gs.pvpRating||1000;
    const ch = CHARACTERS.find(c=>c.id===gs.charId)||CHARACTERS[0];
    const allPlayers = [...PVP_LEADERBOARD_PRESET, ...RUSTORE_PLAYERS.slice(0,4), {name:'–¢–´',icon:ch.icon,rating:myRating,isMe:true}];
    allPlayers.sort((a,b)=>b.rating-a.rating);
    bodyHtml = `<div style="font-size:11px;color:#00e5ff;font-weight:800;margin-bottom:6px;">–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤ –∞—Ä–µ–Ω—ã</div>
    <div style="max-height:300px;overflow-y:auto;">${allPlayers.slice(0,15).map((p,i)=>{
      const pr = getPVPRank(p.rating);
      const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':(''+( i+1));
      return `<div class="pvp-lb-row${p.isMe?' pvp-lb-me':''}">
        <div class="pvp-lb-rank" style="font-size:${i<3?'16':'12'}px;">${medal}</div>
        <div class="pvp-lb-icon">${p.icon}</div>
        <div class="pvp-lb-info"><div class="pvp-lb-name">${p.name}${p.isMe?' (–¢–´)':''}</div>
        <div class="pvp-lb-rating">‚≠ê ${p.rating} ‚Ä¢ ${pr.icon} ${pr.name}</div></div>
        ${!p.isMe?`<button onclick="sendChallenge('${p.name}',${p.rating},'${p.icon}')" style="background:linear-gradient(135deg,rgba(0,229,255,0.2),rgba(0,100,200,0.2));border:1px solid rgba(0,229,255,0.4);border-radius:8px;padding:4px 8px;color:#00e5ff;font-size:9px;font-weight:700;cursor:pointer;">‚öîÔ∏è</button>`:''}
      </div>`;
    }).join('')}</div>
    <button class="pvp-btn" onclick="startPVPSearch()" style="width:100%;max-width:320px;margin-top:10px;">‚öîÔ∏è –ù–ê–ô–¢–ò –°–û–ü–ï–†–ù–ò–ö–ê</button>`;
  } else if(_pvpTab === 'players'){
    bodyHtml = `<div style="font-size:11px;color:#00e5ff;font-weight:800;margin-bottom:4px;">üåê –û–Ω–ª–∞–π–Ω –∏–≥—Ä–æ–∫–∏ (—Å–∫–∞—á–∞–ª–∏ –∏–∑ RuStore)</div>
    <div style="font-size:9px;color:#444;margin-bottom:10px;">–ë—Ä–æ—Å–∞–π –≤—ã–∑–æ–≤ ‚Äî —Ä–µ–π—Ç–∏–Ω–≥ –º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ—Ç –±–æ—ë–≤!</div>
    <div style="max-height:320px;overflow-y:auto;">${RUSTORE_PLAYERS.map(p=>{
      const pr = getPVPRank(p.rating);
      const diff = p.rating - (gs.pvpRating||1000);
      const diffStr = diff > 0 ? `+${diff}` : `${diff}`;
      const diffCol = diff > 100 ? '#ff4444' : diff < -100 ? '#00ff88' : '#ffd700';
      return `<div style="background:rgba(255,255,255,0.04);border:1.5px solid ${p.online?'rgba(0,255,136,0.2)':'rgba(255,255,255,0.07)'};border-radius:12px;padding:10px;margin-bottom:7px;display:flex;align-items:center;gap:10px;">
        <div style="font-size:24px;">${p.icon}</div>
        <div style="flex:1;">
          <div style="font-weight:800;font-size:11px;">${p.name}</div>
          <div style="font-size:9px;color:#555;">‚≠ê ${p.rating} ‚Ä¢ ${pr.icon} ${pr.name}</div>
          <div style="font-size:8px;color:${p.online?'#00ff88':'#333'};margin-top:2px;">${p.online?'üü¢ –í —Å–µ—Ç–∏':'‚ö´ –ë—ã–ª '+p.timeAgo+' –Ω–∞–∑–∞–¥'}</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:10px;color:${diffCol};font-weight:700;">${diffStr}</div>
          <div style="font-size:8px;color:#444;">—Ä–µ–π—Ç–∏–Ω–≥</div>
          <button onclick="sendChallenge('${p.name}',${p.rating},'${p.icon}')" style="margin-top:4px;background:linear-gradient(135deg,rgba(0,229,255,0.25),rgba(0,100,200,0.2));border:1.5px solid rgba(0,229,255,0.4);border-radius:8px;padding:5px 10px;color:#00e5ff;font-size:10px;font-weight:700;cursor:pointer;">‚öîÔ∏è –í—ã–∑–æ–≤</button>
        </div>
      </div>`;
    }).join('')}</div>`;
  } else if(_pvpTab === 'challenges'){
    const incoming = _activeChallenges.filter(c=>c.type==='incoming');
    const outgoing = _activeChallenges.filter(c=>c.type==='outgoing');
    bodyHtml = `<div>`;
    if(incoming.length > 0){
      bodyHtml += `<div style="font-size:11px;color:#ff3d7f;font-weight:800;margin-bottom:6px;">üîî –í—Ö–æ–¥—è—â–∏–µ –≤—ã–∑–æ–≤—ã (${incoming.length})</div>`;
      bodyHtml += incoming.map(c=>`<div style="background:rgba(255,61,127,0.08);border:1.5px solid rgba(255,61,127,0.3);border-radius:12px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:10px;animation:glw1 2s infinite;">
        <div style="font-size:26px;">${c.icon}</div>
        <div style="flex:1;">
          <div style="font-weight:800;font-size:11px;">${c.name}</div>
          <div style="font-size:9px;color:#888;">‚≠ê ${c.rating} ‚Ä¢ –±—Ä–æ—Å–∞–µ—Ç —Ç–µ–±–µ –≤—ã–∑–æ–≤!</div>
          <div style="font-size:8px;color:#555;">${c.timeAgo}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:5px;">
          <button onclick="acceptChallenge('${c.id}')" style="background:linear-gradient(135deg,#00ff88,#00cc66);border:none;border-radius:8px;padding:6px 12px;color:#000;font-weight:900;font-size:10px;cursor:pointer;">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
          <button onclick="declineChallenge('${c.id}')" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:6px 12px;color:#666;font-size:10px;cursor:pointer;">‚ùå –û—Ç–∫–∞–∑</button>
        </div>
      </div>`).join('');
    }
    if(outgoing.length > 0){
      bodyHtml += `<div style="font-size:11px;color:#00e5ff;font-weight:800;margin-bottom:6px;margin-top:8px;">‚è≥ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã</div>`;
      bodyHtml += outgoing.map(c=>`<div style="background:rgba(0,229,255,0.05);border:1.5px solid rgba(0,229,255,0.15);border-radius:12px;padding:10px;margin-bottom:7px;display:flex;align-items:center;gap:10px;">
        <div style="font-size:24px;">${c.icon}</div>
        <div style="flex:1;">
          <div style="font-weight:800;font-size:11px;">${c.name}</div>
          <div style="font-size:9px;color:#555;">‚≠ê ${c.rating} ‚Ä¢ –æ–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞...</div>
        </div>
        <div style="width:20px;height:20px;border:2px solid var(--cyan);border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite;"></div>
      </div>`).join('');
    }
    if(incoming.length === 0 && outgoing.length === 0){
      bodyHtml += `<div style="text-align:center;padding:30px 20px;">
        <div style="font-size:48px;margin-bottom:12px;">‚öîÔ∏è</div>
        <div style="font-size:13px;color:#555;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤</div>
        <div style="font-size:10px;color:#333;margin-top:6px;">–ü–µ—Ä–µ–∫–ª—é—á–∏—Å—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É ¬´–ò–≥—Ä–æ–∫–∏¬ª —á—Ç–æ–±—ã –±—Ä–æ—Å–∏—Ç—å –≤—ã–∑–æ–≤!</div>
      </div>`;
    }
    bodyHtml += `</div>`;
  }
  cont.innerHTML = tabHtml + bodyHtml;
}

function sendChallenge(name, rating, icon){
  const existing = _activeChallenges.find(c=>c.name===name && c.type==='outgoing');
  if(existing){ notify('‚ö†Ô∏è –í—ã–∑–æ–≤ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!'); return; }
  const id = 'ch_out_' + Date.now();
  _activeChallenges.push({id, name, rating, icon, type:'outgoing', timeAgo:'–¢–æ–ª—å–∫–æ —á—Ç–æ'});
  if(!gs.challengesSent) gs.challengesSent = 0;
  gs.challengesSent++;
  markDirty(); save();
  SND.pvpFound();
  notify('‚öîÔ∏è –í—ã–∑–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω '+name+'!');
  checkQuestsProgress();
  // –ß–µ—Ä–µ–∑ 5-15 —Å–µ–∫ –æ–Ω–∏ "–ø—Ä–∏–Ω–∏–º–∞—é—Ç" –≤—ã–∑–æ–≤
  setTimeout(()=>{
    const idx = _activeChallenges.findIndex(c=>c.id===id);
    if(idx >= 0){
      _activeChallenges.splice(idx, 1);
      notify('üåê '+name+' –ø—Ä–∏–Ω—è–ª –≤—ã–∑–æ–≤! –ù–∞—á–∏–Ω–∞–µ–º –±–æ–π!');
      SND.pvpFound();
      setTimeout(()=>startPVPFight({name, rating, icon}), 1200);
    }
  }, 4000 + Math.random()*8000);
  if(_pvpTab === 'challenges') renderPVPScreen('challenges');
  else renderPVPScreen(_pvpTab);
}
window.sendChallenge = sendChallenge;

function acceptChallenge(id){
  const c = _activeChallenges.find(x=>x.id===id);
  if(!c) return;
  _activeChallenges = _activeChallenges.filter(x=>x.id!==id);
  if(!gs.challengeAccepted) gs.challengeAccepted = 0;
  gs.challengeAccepted++;
  markDirty(); save();
  checkQuestsProgress();
  notify('‚úÖ –ü—Ä–∏–Ω—è–ª –≤—ã–∑–æ–≤ –æ—Ç '+c.name+'! –ë–æ–π!');
  SND.pvpFound();
  setTimeout(()=>startPVPFight(c), 800);
}
window.acceptChallenge = acceptChallenge;

function declineChallenge(id){
  _activeChallenges = _activeChallenges.filter(x=>x.id!==id);
  SND.click();
  notify('‚ùå –í—ã–∑–æ–≤ –æ—Ç–∫–ª–æ–Ω—ë–Ω');
  renderPVPScreen('challenges');
}
window.declineChallenge = declineChallenge;

function simulateIncomingChallenge(){
  const p = RUSTORE_PLAYERS[Math.floor(Math.random()*RUSTORE_PLAYERS.length)];
  const existing = _activeChallenges.find(c=>c.name===p.name && c.type==='incoming');
  if(existing){ gs._challengeSimTimer = setTimeout(simulateIncomingChallenge, 20000); return; }
  const id = 'ch_in_' + Date.now();
  _activeChallenges.push({id, name:p.name, rating:p.rating, icon:p.icon, type:'incoming', timeAgo:'–¢–æ–ª—å–∫–æ —á—Ç–æ'});
  SND.pvpFound();
  notify('üîî '+p.name+' –±—Ä–æ—Å–∞–µ—Ç —Ç–µ–±–µ –≤—ã–∑–æ–≤ –Ω–∞ –∞—Ä–µ–Ω–µ!');
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 30 —Å–µ–∫ –µ—Å–ª–∏ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∏
  setTimeout(()=>{
    _activeChallenges = _activeChallenges.filter(x=>x.id!==id);
    if(_pvpTab === 'challenges') renderPVPScreen('challenges');
  }, 30000);
  gs._challengeSimTimer = setTimeout(simulateIncomingChallenge, 25000 + Math.random()*30000);
  if(document.getElementById('pvpScreen').classList.contains('open')){
    renderPVPScreen(_pvpTab);
  }
}

function checkQuestsProgress(){
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–≤–µ—Å—Ç—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
  QUESTS.forEach(q=>{
    if(!gs.questsDone) gs.questsDone = [];
    if(gs.questsDone.includes(q.id)) return;
    let val = 0;
    if(q.stat==='challengeAccepted') val = gs.challengeAccepted||0;
    else if(q.stat==='challengesSent') val = gs.challengesSent||0;
    else if(q.stat==='pvpWins') val = gs.pvpWins||0;
    else if(q.stat==='pvpRating') val = gs.pvpRating||1000;
    if(val >= q.target){
      // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á—Ç–æ –∫–≤–µ—Å—Ç –≥–æ—Ç–æ–≤ –∫ —Å–¥–∞—á–µ
      notify('üéØ –ö–≤–µ—Å—Ç "'+q.name+'" –≥–æ—Ç–æ–≤! –ò–¥–∏ –≤ –ö–≤–µ—Å—Ç—ã!');
    }
  });
}

function renderLeaderboard(){
  renderPVPScreen('leaderboard');
}

function startPVPSearch(){
  const searching=document.getElementById('pvpSearching');
  searching.style.cssText='display:flex;position:absolute;inset:0;background:rgba(0,5,16,0.95);flex-direction:column;align-items:center;justify-content:center;gap:16px;';
  document.getElementById('pvpSearchTxt').textContent='–ü–û–ò–°–ö –°–û–ü–ï–†–ù–ò–ö–ê...';
  document.getElementById('pvpEnemyCard').innerHTML='<div class="pvp-player-icon">‚ùì</div><div class="pvp-player-name">–ü–æ–∏—Å–∫...</div><div class="pvp-player-rating">‚≠ê ???</div>';
  SND.click();
  pvpSearchTimer=setTimeout(()=>{
    const r=gs.pvpRating||1000;
    // –ò—â–µ–º —Å—Ä–µ–¥–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ + –ø—Ä–µ—Å–µ—Ç
    const allCandidates = [...PVP_LEADERBOARD_PRESET, ...RUSTORE_PLAYERS].filter(p=>Math.abs(p.rating-r)<600);
    const opp=allCandidates[Math.floor(Math.random()*allCandidates.length)]||RUSTORE_PLAYERS[6];
    document.getElementById('pvpEnemyCard').innerHTML='<div class="pvp-player-icon">'+opp.icon+'</div><div class="pvp-player-name">'+opp.name+'</div><div class="pvp-player-rating">‚≠ê '+opp.rating+'</div>';
    document.getElementById('pvpSearchTxt').textContent='–°–û–ü–ï–†–ù–ò–ö –ù–ê–ô–î–ï–ù!';
    SND.pvpFound();
    pvpSearchTimer=setTimeout(()=>{
      closePVP();
      startPVPFight(opp);
    },1500);
  },1500+Math.random()*2000);
}

function cancelPVPSearch(){
  if(pvpSearchTimer){clearTimeout(pvpSearchTimer);pvpSearchTimer=null;}
  const searching=document.getElementById('pvpSearching');
  if(searching)searching.style.display='none';
}

function startPVPFight(opp){
  const accBpvp=getAccBonus();
  const pMaxHp=100+gs.gearBonus+Math.floor(gs.strength/2)+accBpvp.hpBonus;
  const eAtk=Math.max(5,Math.floor(opp.rating/40));
  const eMaxHp=Math.max(80,Math.floor(opp.rating/8));
  const ch=CHARACTERS.find(c=>c.id===gs.charId)||CHARACTERS[0];
  fightState={
    pHp:pMaxHp,pMaxHp,
    eHp:eMaxHp,eMaxHp,
    enemy:{name:opp.icon+' '+opp.name,hp:eMaxHp,atk:eAtk,def:Math.floor(eAtk*0.3),reward:Math.floor(opp.rating*0.1)},
    over:false,locked:false,defending:null,
    isPVP:true,pvpOpp:opp
  };
  document.getElementById('fightLocName').textContent='üåê –ê—Ä–µ–Ω–∞ –≤—ã–∑–æ–≤–æ–≤';
  document.getElementById('pName').textContent=ch.icon+' '+ch.name;
  document.getElementById('eName').textContent=opp.icon+' '+opp.name;
  updateFightHUD();
  buildFightBtns();
  document.getElementById('fightLog').innerHTML='';
  fightLog('üåê –í—ã–∑–æ–≤! '+opp.icon+' '+opp.name+' –ø—Ä–∏–Ω—è–ª –≤—ã–∑–æ–≤!');
  document.getElementById('fightScreen').classList.add('open');
  pAnimState='idle'; pAnimT=0; eAnimState='idle'; eHitT=0;
  openFightRingRenderer();
  SND.pvpFound();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GUILD SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openGuild(){
  const cont=document.getElementById('guildContent');
  if(gs.guildName){renderGuildMain(cont);}else{renderGuildJoin(cont);}
  document.getElementById('guildScreen').classList.add('open');
  SND.click();
}
function closeGuild(){document.getElementById('guildScreen').classList.remove('open');}

function renderGuildJoin(cont){
  cont.innerHTML='<div style="padding:16px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:14px;padding-top:40px;"><div style="font-size:54px;">‚öîÔ∏è</div><div style="font-family:\'Russo One\',sans-serif;font-size:18px;color:#00ff88;">–¢—ã –Ω–µ –≤ –≥–∏–ª—å–¥–∏–∏</div><div style="font-size:12px;color:#555;max-width:280px;">–í—Å—Ç—É–ø–∏ –≤ –≥–∏–ª—å–¥–∏—é —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –±–æ–Ω—É—Å—ã –∏ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –≤–æ–π–Ω–∞—Ö!</div><div style="display:flex;gap:10px;flex-direction:column;width:100%;max-width:280px;"><button class="guild-btn gb-green" onclick="joinGuild(\'–ë—Ä–∞—Ç—Å—Ç–≤–æ –¢–æ–ª—Å—Ç—è–∫–æ–≤\')">‚öîÔ∏è –í—Å—Ç—É–ø–∏—Ç—å –≤ ¬´–ë—Ä–∞—Ç—Å—Ç–≤–æ –¢–æ–ª—Å—Ç—è–∫–æ–≤¬ª</button><button class="guild-btn gb-green" style="background:linear-gradient(135deg,#0891b2,#0e7490);" onclick="joinGuild(\'–ñ–µ–ª–µ–∑–Ω—ã–π –ö—É–ª–∞–∫\')">üí™ –í—Å—Ç—É–ø–∏—Ç—å –≤ ¬´–ñ–µ–ª–µ–∑–Ω—ã–π –ö—É–ª–∞–∫¬ª</button><button class="guild-btn gb-green" style="background:linear-gradient(135deg,#7c3aed,#5b21b6);" onclick="joinGuild(\'–ü—É—Ä–ø—É—Ä–Ω—ã–µ –í–æ–∏–Ω—ã\')">üîÆ –í—Å—Ç—É–ø–∏—Ç—å –≤ ¬´–ü—É—Ä–ø—É—Ä–Ω—ã–µ –í–æ–∏–Ω—ã¬ª</button><div style="color:#333;font-size:11px;margin-top:4px;">‚Äî –∏–ª–∏ ‚Äî</div><button class="guild-btn" style="background:linear-gradient(135deg,#ffd700,#ff8f00);color:#000;" onclick="createGuild()">‚ú® –°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –≥–∏–ª—å–¥–∏—é</button></div></div>';
}

function joinGuild(name){
  gs.guildName=name;gs.guildId=name.toLowerCase().replace(/\s+/g,'_');gs.guildMember=1;
  gs.coins+=100;markDirty();save();
  SND.guild();
  notify('‚öîÔ∏è –í—Å—Ç—É–ø–∏–ª –≤ ¬´'+name+'¬ª! +100üí∞');
  updateHUD();checkAchievements();
  renderGuildMain(document.getElementById('guildContent'));
}

function createGuild(){
  const ch=CHARACTERS.find(c=>c.id===gs.charId)||CHARACTERS[0];
  joinGuild('–ì–∏–ª—å–¥–∏—è '+ch.name);
}

function renderGuildMain(cont){
  if(!gs.guildName){renderGuildJoin(cont);return;}
  const ch=CHARACTERS.find(c=>c.id===gs.charId)||CHARACTERS[0];
  cont.innerHTML='<div class="guild-card"><div class="guild-icon">‚öîÔ∏è</div><div class="guild-name">'+gs.guildName+'</div><div class="guild-desc">–ê–∫—Ç–∏–≤–Ω–∞—è –≥–∏–ª—å–¥–∏—è ‚Ä¢ –í–æ–π–Ω–∞ –≥–∏–ª—å–¥–∏–π –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é</div><div class="guild-stats"><div class="guild-stat"><div class="guild-stat-val">'+(GUILD_MEMBERS_PRESET.length+1)+'</div><div class="guild-stat-lbl">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div></div><div class="guild-stat"><div class="guild-stat-val">‚≠ê'+Math.floor((gs.pvpRating||1200)/100)*100+'</div><div class="guild-stat-lbl">–†–µ–π—Ç–∏–Ω–≥</div></div><div class="guild-stat"><div class="guild-stat-val">üèÜ'+gs.wins+'</div><div class="guild-stat-lbl">–ü–æ–±–µ–¥—ã</div></div></div><div style="margin-top:12px;background:rgba(0,255,136,0.07);border:1px solid rgba(0,255,136,0.2);border-radius:10px;padding:10px;font-size:11px;color:#00ff88;">üéÅ –ë–æ–Ω—É—Å –≥–∏–ª—å–¥–∏–∏: +10% –º–æ–Ω–µ—Ç —Å –∫–∞–∂–¥–æ–π –ø–æ–±–µ–¥—ã</div></div><div style="padding:0 14px 8px;font-family:\'Russo One\',sans-serif;font-size:13px;color:#00ff88;">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div><div class="guild-members"><div class="guild-member" style="border-color:rgba(0,255,136,0.4);background:rgba(0,255,136,0.07);"><div class="gm-icon">'+ch.icon+'</div><div class="gm-info"><div class="gm-name">–¢–´ '+(gs.rebirth>0?'[–†–±.'+gs.rebirth+']':'')+'</div><div class="gm-stats">‚öñÔ∏è'+gs.weight+'–∫–≥ ‚Ä¢ üí™'+gs.strength+' ‚Ä¢ üèÜ'+gs.wins+'</div></div><div class="gm-rank">–£—á–∞—Å—Ç–Ω–∏–∫</div><div style="width:8px;height:8px;border-radius:50%;background:#00ff88;margin-left:4px;"></div></div>'+GUILD_MEMBERS_PRESET.map(m=>'<div class="guild-member"><div class="gm-icon">'+m.icon+'</div><div class="gm-info"><div class="gm-name">'+m.name+'</div><div class="gm-stats">‚öñÔ∏è'+m.weight+'–∫–≥ ‚Ä¢ üí™'+m.strength+' ‚Ä¢ üèÜ'+m.wins+'</div></div><div class="gm-rank">'+m.rank+'</div><div style="width:8px;height:8px;border-radius:50%;background:'+(m.online?'#00ff88':'#333')+';margin-left:4px;"></div></div>').join('')+'</div><div class="guild-actions"><button class="guild-btn gb-green" onclick="SND.click();notify(\'üèÜ –í–æ–π–Ω–∞ –≥–∏–ª—å–¥–∏–π –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ!\')">‚öîÔ∏è –í–æ–π–Ω–∞ –≥–∏–ª—å–¥–∏–π</button><button class="guild-btn gb-red" onclick="leaveGuild()">üö™ –í—ã–π—Ç–∏</button></div>';
}

function leaveGuild(){
  gs.guildName=null;gs.guildId=null;gs.guildMember=0;
  markDirty();save();
  SND.click();
  renderGuildJoin(document.getElementById('guildContent'));
  notify('–¢—ã –ø–æ–∫–∏–Ω—É–ª –≥–∏–ª—å–¥–∏—é');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACHIEVEMENTS PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAchievements(){
  const lst=document.getElementById('achList');lst.innerHTML='';
  ACHIEVEMENTS.forEach(ach=>{
    const done=gs.achDone.includes(ach.id);
    let val=0;
    if(ach.stat==='trainCount')val=gs.trainCount;
    else if(ach.stat==='wins')val=gs.wins;
    else if(ach.stat==='rebirth')val=gs.rebirth;
    else if(ach.stat==='weightLoss')val=230-gs.weight;
    else if(ach.stat==='pvpWins')val=gs.pvpWins||0;
    else if(ach.stat==='guildMember')val=gs.guildMember||0;
    else if(ach.stat==='coins')val=gs.coins;
    else if(ach.stat==='strength')val=gs.strength;
    const pct=Math.min(100,Math.floor(val/ach.target*100));
    const el=document.createElement('div');el.className='ach-card'+(done?' done':'');
    el.innerHTML='<div class="ach-icon">'+ach.icon+'</div><div class="ach-info"><div class="ach-name">'+ach.name+'</div><div class="ach-desc">'+ach.desc+'</div><div class="ach-bar-wrap"><div class="ach-bar-fill" style="width:'+pct+'%"></div></div><div class="ach-prog">'+Math.min(val,ach.target)+'/'+ach.target+(done?' ‚úÖ':'')+'</div></div><div class="ach-badge">+'+ach.reward+'üí∞</div>';
    lst.appendChild(el);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REBIRTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openRebirth(){
  const nr=gs.rebirth+1;
  document.getElementById('rbBadge').textContent='–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ #'+nr+'/30';
  const rank=REBIRTH_RANKS.slice().reverse().find(r=>nr>=r.min)||REBIRTH_RANKS[0];
  document.getElementById('rbSub').textContent='–†–∞–Ω–≥: '+rank.icon+' '+rank.name+' ‚Äî –í—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:';
  const grid=document.getElementById('charGrid');grid.innerHTML='';
  const availableChars=CHARACTERS.filter(ch=>{
    if(['boris','vasya','fedya','kolya','petya','misha','stepa','grisha','dima','maksim'].includes(ch.id))return true;
    if(ch.id==='ivan'||ch.id==='olga')return gs.rebirth>=4;
    if(ch.id==='igor')return gs.rebirth>=7;
    if(ch.id==='sasha')return gs.rebirth>=9;
    if(ch.id==='nina')return gs.rebirth>=11;
    if(ch.id==='artem')return gs.rebirth>=14;
    if(ch.id==='lena')return gs.rebirth>=17;
    if(ch.id==='kira')return gs.rebirth>=19;
    if(ch.id==='zeus')return gs.rebirth>=24;
    if(ch.id==='titan')return gs.rebirth>=27;
    return false;
  });
  availableChars.forEach(ch=>{
    const el=document.createElement('div');el.className='char-card';
    el.innerHTML='<div class="cc-icon">'+ch.icon+'</div><div class="cc-name">'+ch.name+'</div><div class="cc-bonus">'+ch.bonus+'</div>';
    el.onclick=()=>doRebirth(ch.id);
    grid.appendChild(el);
  });
  document.getElementById('rebirthScreen').classList.add('open');
}

function doRebirth(charId){
  const nr=gs.rebirth+1;
  gs.rebirth=nr;gs.charId=charId;gs.locationId=Math.min(Math.floor(nr/3),9);
  gs.weight=230;gs.maxWeight=230;gs.wins=0;
  gs.strength=Math.floor(gs.strength*0.5+25);
  gs.energy=gs.maxEnergy;
  gs.fightBonus=0;gs.defBonus=0;gs.critBonus=0;gs.healBonus=0;
  gs.infiniteEnergy=false;gs.enemyHPMod=1;
  const ch=CHARACTERS.find(c=>c.id===charId)||CHARACTERS[0];
  ch.fn(gs);
  buildScene(gs.locationId);
  document.getElementById('locBadge').textContent='üìç '+LOCATIONS[gs.locationId].name;
  updateHUD();markDirty();save();
  SND.rebirth();
  document.getElementById('rebirthScreen').classList.remove('open');
  const rank=getRank();
  notify('üî• –ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ #'+nr+'! '+ch.name+'! –†–∞–Ω–≥: '+rank.icon+' '+rank.name+'!');
  anim.action='win';setTimeout(()=>anim.action='idle',3000);
  checkAchievements();
  if(nr>=30)setTimeout(()=>notify('‚ú® –í–´ ‚Äî –ê–ë–°–û–õ–Æ–¢–ù–´–ô –ß–ï–ú–ü–ò–û–ù! 30 –ü–ï–†–ï–†–û–ñ–î–ï–ù–ò–ô!'),2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANELS, HUD, STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLoc(){
  const lst=document.getElementById('locList');lst.innerHTML='';
  LOCATIONS.forEach((loc,i)=>{
    const unlocked=i<=Math.floor(gs.rebirth/3),current=i===gs.locationId;
    const el=document.createElement('div');
    el.className='loc-item'+(current?' current':!unlocked?' locked':'');
    el.innerHTML='<div class="loc-row"><div class="loc-icon-big">'+loc.icon+'</div><div><div class="loc-name">'+loc.name+(current?' ‚Üê –ó–î–ï–°–¨':'')+'</div><div class="loc-desc">'+loc.desc+'</div><div class="loc-gyms">üèãÔ∏è '+loc.gyms.map(k=>GYM[k].title.split(' ')[0]).join(' ')+'</div><div class="loc-status" style="color:'+(unlocked?'#00ff88':'#333')+'">'+(unlocked?'üîì –û—Ç–∫—Ä—ã—Ç–∞':'üîí –†–±.'+(i*3))+'</div></div></div>';
    if(unlocked&&!current){el.onclick=()=>{gs.locationId=i;buildScene(i);document.getElementById('locBadge').textContent='üìç '+LOCATIONS[i].name;SND.click();notify(loc.icon+' '+loc.name+'!');save();closeAll();};}
    lst.appendChild(el);
  });
}

function renderStats(){
  const pct=((gs.maxWeight-gs.weight)/(gs.maxWeight-gs.minWeight)*100).toFixed(1);
  const ch=CHARACTERS.find(c=>c.id===gs.charId)||CHARACTERS[0];
  const rank=getRank();
  const totalSecs=getPlayTime();
  const hh=Math.floor(totalSecs/3600),mm=Math.floor((totalSecs%3600)/60);
  const timeStr=hh>0?(hh+'—á '+mm+'–º'):(mm+'–º');
  const pvpRank=getPVPRank(gs.pvpRating||1200);
  document.getElementById('statsContent').innerHTML='<div style="background:rgba(255,255,255,0.05);border-radius:14px;padding:14px;text-align:center;margin-bottom:10px;"><div style="font-size:34px;">'+ch.icon+'</div><div style="font-family:\'Russo One\',sans-serif;font-size:15px;margin-top:3px;">'+ch.name+'</div><div style="font-size:11px;color:#a78bfa;margin-top:2px;">'+ch.bonus+'</div><div style="font-size:12px;color:var(--gold);margin-top:4px;">'+rank.icon+' –†–∞–Ω–≥: '+rank.name+'</div></div><div style="margin-bottom:10px;"><div style="font-size:11px;color:#9b00ff;margin-bottom:4px;">üéØ –¶–µ–ª—å: '+gs.minWeight+'–∫–≥</div><div class="prog-bg"><div class="prog-fill" style="width:'+pct+'%"></div></div><div style="font-size:11px;color:#00ff88;margin-top:3px;">'+pct+'% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚Ä¢ '+(230-gs.weight).toFixed(1)+'–∫–≥ —Å–±—Ä–æ—à–µ–Ω–æ</div></div><div class="stat-grid" style="margin-bottom:10px;">'+[['‚öñÔ∏è',gs.weight.toFixed(1)+'–∫–≥','–í–µ—Å'],['üí™',gs.strength,'–°–∏–ª–∞'],['üèÜ',gs.wins+'/30','–ü–æ–±–µ–¥—ã'],['üî•',gs.rebirth+'/30','–ü–µ—Ä–µ—Ä–æ–∂–¥.'],['üèãÔ∏è',gs.trainCount,'–¢—Ä–µ–Ω–∏—Ä.'],['üí∞',gs.coins,'–ú–æ–Ω–µ—Ç—ã'],['‚è±Ô∏è',timeStr,'–í—Ä–µ–º—è']].map(([ic,v,l])=>'<div class="stat-card"><div class="stat-icon">'+ic+'</div><div class="stat-val">'+v+'</div><div class="stat-nm">'+l+'</div></div>').join('')+'</div>';
}

function updateHUD(){
  if(!gs)return;
  // –ó–∞—â–∏—Ç–∞ –æ—Ç NaN
  if(!gs.maxEnergy||isNaN(gs.maxEnergy))gs.maxEnergy=100;
  if(isNaN(gs.energy))gs.energy=gs.maxEnergy;
  gs.energy=Math.max(0,Math.min(gs.energy,gs.maxEnergy));
  const wp=(gs.weight-gs.minWeight)/(gs.maxWeight-gs.minWeight);
  document.getElementById('weightFill').style.width=(wp*100)+'%';
  document.getElementById('weightVal').textContent=gs.weight.toFixed(1)+'–∫–≥';
  document.getElementById('energyFill').style.width=(gs.energy/gs.maxEnergy*100)+'%';
  document.getElementById('energyVal').textContent=Math.round(gs.energy)+'/'+gs.maxEnergy;
  document.getElementById('coinsVal').textContent=gs.coins;
  document.getElementById('strVal').textContent=gs.strength;
  document.getElementById('winsVal').textContent=gs.wins;
  document.getElementById('rbVal').textContent=gs.rebirth;
  const ch=CHARACTERS.find(c=>c.id===gs.charId)||CHARACTERS[0];
  document.getElementById('charNameTag').textContent=ch.icon+' '+ch.name+' ‚Ä¢ '+gs.weight.toFixed(1)+'–∫–≥';
  const rank=getRank();
  document.getElementById('rbLevelSpan').textContent=gs.rebirth;
  document.getElementById('rankNameSpan').textContent=rank.icon+' '+rank.name;
}

function renderTrain(){
  const loc=LOCATIONS[gs.locationId];
  document.getElementById('trainTitle').textContent=loc.icon+' '+loc.name;
  const lst=document.getElementById('trainList');lst.innerHTML='';
  loc.gyms.forEach(key=>{
    const cfg=GYM[key];const el=document.createElement('div');el.className='train-item';
    el.innerHTML='<div class="train-icon">'+cfg.title.split(' ')[0]+'</div><div class="train-info"><div class="train-name">'+cfg.title.slice(3)+'</div><div class="train-desc">'+cfg.desc+'</div><div class="train-stats"><span class="ts e">‚ö°-'+cfg.e+'</span><span class="ts w">‚öñÔ∏è-'+cfg.w+'–∫–≥</span><span class="ts c">+'+cfg.c+'üí∞</span><span class="ts s">+'+cfg.s+'üí™</span></div></div>';
    el.onclick=()=>startMG(key);lst.appendChild(el);
  });
}

function openPanel(id){
  SND.click();
  closeAll();
  if(id==='shopPanel')renderShop();
  if(id==='statsPanel')renderStats();
  if(id==='trainPanel')renderTrain();
  if(id==='locPanel')renderLoc();
  if(id==='achPanel')renderAchievements();
  document.getElementById(id).classList.add('open');
  document.getElementById('overlay').classList.add('open');
}

function closeAll(){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('open'));
  document.getElementById('miniGame').classList.remove('open');
  document.getElementById('overlay').classList.remove('open');
  if(mgS.active&&!mgS.done){anim.action='idle';mgS.active=false;}
}

let _notifT;
function notify(msg){
  const n=document.getElementById('notif');n.textContent=msg;n.style.opacity='1';
  clearTimeout(_notifT);_notifT=setTimeout(()=>n.style.opacity='0',2800);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('startBtn').addEventListener('click',()=>{
  getACtx();
  _musicEnabled = gs.musicEnabled !== false;
  setTimeout(startBgMusic, 300);
  load();
  if(!gs._baseTime)gs._baseTime=gs.totalPlayTime||0;
  if(!gs.ownedClothes.includes('shorts'))gs.ownedClothes.push('shorts');
  if(!gs.ownedClothes.includes('barefoot'))gs.ownedClothes.push('barefoot');
  if(!gs.ownedRingSkins)gs.ownedRingSkins=['classic'];
  if(!gs.activeRingSkin)gs.activeRingSkin='classic';
  gs.sessionStart=Date.now();
  buildScene(gs.locationId);
  const loc=LOCATIONS[gs.locationId];
  const rank=getRank();
  document.getElementById('locBadge').textContent='üìç '+loc.name;
  document.getElementById('rbLevelSpan').textContent=gs.rebirth;
  document.getElementById('rankNameSpan').textContent=rank.icon+' '+rank.name;
  updateHUD();save();
  document.getElementById('startScreen').style.display='none';
  document.getElementById('ui').style.display='block';
  setTimeout(()=>notify('üê∑ –¢–∞–ø–∞–π –ø–æ —ç–∫—Ä–∞–Ω—É –≤–æ –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏!'),800);
  setTimeout(checkDailyReward,1500);
  setTimeout(checkTimeRewards,3000);
});

// ‚ïê‚ïê‚ïê ANDROID BACK BUTTON ‚ïê‚ïê‚ïê
document.addEventListener('keydown', e=>{
  if(e.key==='Escape'||e.keyCode===27){
    const fight=document.getElementById('fightScreen');
    if(fight&&fight.classList.contains('open')){closeFight();return;}
    const panels=document.querySelectorAll('.panel.open');
    if(panels.length>0){closeAll();return;}
    if(typeof closeAll==='function')closeAll();
  }
});
// –î–ª—è Capacitor/Cordova Android back button
document.addEventListener('backbutton', e=>{
  e.preventDefault();
  const fight=document.getElementById('fightScreen');
  if(fight&&fight.classList.contains('open')){closeFight();return;}
  const panels=document.querySelectorAll('.panel.open');
  if(panels.length>0){closeAll();return;}
  save();
}, false);

// ‚ïê‚ïê‚ïê SHOP ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ‚ïê‚ïê‚ïê
function switchTab(name){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  const tabEl=document.getElementById('tab-'+name);
  if(tabEl)tabEl.classList.add('active');
  const btnEl=document.querySelector(`.tab-btn[onclick*="'${name}'"]`);
  if(btnEl)btnEl.classList.add('active');
  // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–∫–∏
  if(name==='drinks')_renderDrinks();
  else if(name==='clothes')_renderClothes('top');
  else if(name==='shoes')_renderClothes('shoe');
  else if(name==='acc')_renderClothes('acc');
  else if(name==='gear')_renderGear();
  else if(name==='ringskins')_renderRingSkins();
}
function _renderDrinks(){
  const g=document.getElementById('drinksGrid');if(!g)return;
  g.innerHTML=DRINKS.map(d=>{
    const owned=(gs.ownedDrinks||[]).includes(d.id);
    const canBuy=gs.coins>=d.price;
    return`<div class="shop-item${!canBuy&&!owned?' cantbuy':''}" onclick="buyDrink('${d.id}')">
      <div class="si">${d.icon}</div><div class="sn">${d.name}</div>
      <div class="sp">${d.price===0?'–ë–µ—Å–ø–ª–∞—Ç–Ω–æ':'üí∞'+d.price}</div>
      <div class="se">${d.fx}</div></div>`;
  }).join('');
}
function _renderClothes(cat){
  const gridId=cat==='top'?'clothesGrid':cat==='shoe'?'shoesGrid':'accGrid';
  const g=document.getElementById(gridId);if(!g)return;
  const items=CLOTHES.filter(c=>c.cat===cat);
  const active=cat==='top'?gs.activeClothes:cat==='shoe'?gs.activeShoes:gs.activeAcc;
  g.innerHTML=items.map(item=>{
    const owned=(gs.ownedClothes||[]).includes(item.id);
    const isEq=active===item.id;
    const canBuy=gs.coins>=item.price;
    return`<div class="shop-item${owned?' owned':''}${!owned&&!canBuy?' cantbuy':''}" onclick="buyOrEquip('${item.id}','${cat}')">
      ${isEq?'<div class="badge-eq">–í–ö–õ</div>':''}
      ${owned&&!isEq?'<div class="badge-owned">–ï–°–¢–¨</div>':''}
      <div class="si">${item.icon}</div><div class="sn">${item.name}</div>
      <div class="sp">${owned?'–ù–∞–¥–µ—Ç—å':'üí∞'+item.price}</div>
      <div class="se">${item.fx}</div></div>`;
  }).join('');
}
function _renderGear(){
  const g=document.getElementById('gearGrid');if(!g)return;
  g.innerHTML=GEAR.map(item=>{
    const owned=(gs.ownedGear||[]).includes(item.id);
    const canBuy=gs.coins>=item.price;
    return`<div class="shop-item${owned?' owned':''}${!owned&&!canBuy?' cantbuy':''}" onclick="buyGear('${item.id}')">
      ${owned?'<div class="badge-owned">–ö–£–ü–õ–ï–ù–û</div>':''}
      <div class="si">${item.icon}</div><div class="sn">${item.name}</div>
      <div class="sp">${owned?'–ö—É–ø–ª–µ–Ω–æ':'üí∞'+item.price}</div>
      <div class="se">${item.fx}</div></div>`;
  }).join('');
}
function _renderRingSkins(){
  const g=document.getElementById('tab-ringskins');if(!g)return;
  if(!document.getElementById('ringSkinGrid')){
    g.innerHTML='<div class="shop-grid" id="ringSkinGrid"></div>';
  }
  const rg=document.getElementById('ringSkinGrid');
  rg.innerHTML=RING_SKINS.map(skin=>{
    const owned=(gs.ownedRingSkins||[]).includes(skin.id);
    const active=gs.activeRingSkin===skin.id;
    const canBuy=gs.coins>=skin.price;
    return`<div class="ring-skin-card${active?' active':''}${!owned&&!canBuy?' locked':''}" onclick="buyRingSkin('${skin.id}')">
      ${active?'<div class="rs-active-badge">–ê–ö–¢</div>':''}
      <div class="rs-preview">${skin.icon}</div>
      <div class="rs-name">${skin.name}</div>
      <div class="rs-cost">${owned?'–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å':'üí∞'+skin.price}</div>
      <div style="font-size:9px;color:#555;margin-top:2px;">${skin.desc}</div>
    </div>`;
  }).join('');
}
window.buyDrink=function(id){
  const d=DRINKS.find(x=>x.id===id);
  if(!d||!gs)return;
  if(gs.coins<d.price){notify('‚ùå –ú–∞–ª–æ –º–æ–Ω–µ—Ç!');return;}
  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –î–û –≤—ã–∑–æ–≤–∞ fn
  if(!gs.maxEnergy||isNaN(gs.maxEnergy)||gs.maxEnergy<1)gs.maxEnergy=100;
  if(isNaN(gs.energy)||gs.energy<0)gs.energy=0;
  if(gs.energy>gs.maxEnergy)gs.energy=gs.maxEnergy;
  const eBefore=gs.energy;
  gs.coins-=d.price;
  d.fn(gs); // –≤—ã–∑—ã–≤–∞–µ–º fn –∏–∑ DRINKS ‚Äî —Ç–∞–º –≤—Å—ë –ø—Ä–æ–ø–∏—Å–∞–Ω–æ
  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ü–û–°–õ–ï fn
  if(!gs.maxEnergy||isNaN(gs.maxEnergy)||gs.maxEnergy<1)gs.maxEnergy=100;
  if(isNaN(gs.energy)||gs.energy<0)gs.energy=0;
  if(gs.energy>gs.maxEnergy)gs.energy=gs.maxEnergy;
  updateHUD();markDirty();save();SND.eat();
  const gained=Math.round(gs.energy-eBefore);
  notify(gained>0?('‚ö° '+d.name+': +'+gained+' —ç–Ω–µ—Ä–≥–∏–∏!'):'‚úÖ '+d.name+' –ø—Ä–∏–º–µ–Ω—ë–Ω!');
  _renderDrinks();
};
window.buyOrEquip=function(id,cat){
  const item=CLOTHES.find(c=>c.id===id);if(!item)return;
  if(!(gs.ownedClothes||[]).includes(id)){
    if(gs.coins<item.price){notify('‚ùå –ú–∞–ª–æ –º–æ–Ω–µ—Ç!');return;}
    gs.coins-=item.price;
    if(!gs.ownedClothes)gs.ownedClothes=[];
    gs.ownedClothes.push(id);
    SND.buy();notify('‚úÖ –ö—É–ø–ª–µ–Ω–æ: '+item.name);
  } else {
    notify('üëï –ù–∞–¥–µ–ª: '+item.name);
  }
  if(cat==='top')gs.activeClothes=id;
  else if(cat==='shoe')gs.activeShoes=id;
  else gs.activeAcc=id;
  SND.equip();
  updateHUD();markDirty();save();_renderClothes(cat);
};
window.buyGear=function(id){
  const item=GEAR.find(g=>g.id===id);if(!item)return;
  if((gs.ownedGear||[]).includes(id)){notify('‚úÖ –£–∂–µ –∫—É–ø–ª–µ–Ω–æ!');return;}
  if(gs.coins<item.price){notify('‚ùå –ú–∞–ª–æ –º–æ–Ω–µ—Ç!');return;}
  gs.coins-=item.price;
  if(!gs.ownedGear)gs.ownedGear=[];
  gs.ownedGear.push(id);
  if(id==='armor')gs.gearBonus=(gs.gearBonus||0)+50;
  else if(id==='belt')gs.gearBonus=(gs.gearBonus||0)+20;
  else if(id==='helmet')gs.gearBonus=(gs.gearBonus||0)+30;
  updateHUD();markDirty();save();SND.buy();notify('‚úÖ –ö—É–ø–ª–µ–Ω–æ: '+item.name);_renderGear();
};
window.buyRingSkin=function(id){
  const skin=RING_SKINS.find(s=>s.id===id);if(!skin)return;
  if(!(gs.ownedRingSkins||[]).includes(id)){
    if(gs.coins<skin.price){notify('‚ùå –ú–∞–ª–æ –º–æ–Ω–µ—Ç!');return;}
    gs.coins-=skin.price;
    if(!gs.ownedRingSkins)gs.ownedRingSkins=[];
    gs.ownedRingSkins.push(id);
    SND.buy();
  }
  gs.activeRingSkin=id;
  updateHUD();markDirty();save();notify('ü•ä –°–∫–∏–Ω —Ä–∏–Ω–≥–∞: '+skin.name);_renderRingSkins();
};

// ‚ïê‚ïê‚ïê FIGHT ‚Äî –±–æ–π ‚ïê‚ïê‚ïê
function fightLog(msg){
  const el=document.getElementById('fightLog');
  if(!el)return;
  el.innerHTML+='<div>'+msg+'</div>';
  el.scrollTop=el.scrollHeight;
}
function closeFight(){
  if(fightAnimId)cancelAnimationFrame(fightAnimId);
  fightAnimId=null;
  document.getElementById('fightScreen').style.display='none';
  document.getElementById('fightScreen').classList.remove('open');
  fightState=null;
  pAnimState='idle';
  anim.action='idle';
}
function doFightAction(type){
  if(!fightState||fightState.over||fightState.locked)return;
  const accB=getAccBonus();
  const str=gs.strength||10;
  let dmg=0,eDmg=0,msg='';
  const atkMult=1+(accB.atkBonus/100);
  const defMult=1-(accB.defBonus/200);
  const enemy=fightState.enemy;
  if(type==='punch'){
    dmg=Math.round((5+Math.random()*str*0.4)*atkMult);
    eDmg=Math.round((enemy.atk||8)*defMult*(0.7+Math.random()*0.6));
    msg='üëä –£–¥–∞—Ä! -'+dmg+'HP –≤—Ä–∞–≥—É, –≤—Ä–∞–≥ –±—å—ë—Ç -'+eDmg+'HP';
    SND.punch();pAnimState='punch';eHitT=0.3;
  }else if(type==='kick'){
    dmg=Math.round((8+Math.random()*str*0.5)*atkMult);
    eDmg=Math.round((enemy.atk||8)*defMult*(0.8+Math.random()*0.5));
    msg='ü¶∂ –ü–∏–Ω–æ–∫! -'+dmg+'HP';
    SND.kick();pAnimState='kick';eHitT=0.4;
  }else if(type==='special'){
    dmg=Math.round((12+Math.random()*str*0.6)*atkMult);
    eDmg=Math.round((enemy.atk||8)*defMult*(0.5+Math.random()*0.4));
    msg='‚ö° –°–ø–µ—Ü—É–¥–∞—Ä! -'+dmg+'HP!';
    SND.special();pAnimState='special';eHitT=0.5;
  }else if(type==='spinKick'){
    const spinHit=Math.random()<0.3;
    if(spinHit){
      dmg=Math.round((str*0.8+Math.random()*str*0.8)*1.8*atkMult);
      msg='üåÄ –í–µ—Ä—Ç—É—à–∫–∞ x1.8! -'+dmg+'HP!';
    }else{
      dmg=Math.round((str*0.8+Math.random()*str*0.8)*0.7*atkMult);
      msg='üåÄ –í–µ—Ä—Ç—É—à–∫–∞ –ø—Ä–æ–º–∞—Ö–Ω—É–ª–∞—Å—å... -'+dmg+'HP (x0.7)';
    }
    eDmg=Math.round((enemy.atk||8)*defMult*0.6);
    SND.spinKick();pAnimState='spin';eHitT=0.6;
  }else if(type==='defend'){
    eDmg=0;dmg=0;
    fightState.defending=3;
    msg='üõ°Ô∏è –ë–ª–æ–∫! –°–ª–µ–¥—É—é—â–∏–π —É–¥–∞—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!';
    SND.defend();pAnimState='defend';
  }else if(type==='heal'){
    const hp=Math.round(15+str*0.2);
    fightState.pHp=Math.min(fightState.pHp+hp,fightState.pMaxHp);
    eDmg=Math.round((enemy.atk||8)*defMult);
    msg='üíä –ê–ø—Ç–µ—á–∫–∞ +'+hp+'HP! –í—Ä–∞–≥ –±—å—ë—Ç -'+eDmg+'HP';
    SND.heal();pAnimState='heal';
  }
  if(fightState.defending&&fightState.defending>0&&type!=='defend'&&type!=='heal'){
    eDmg=0;fightState.defending--;
    if(fightState.defending<=0)fightState.defending=null;
  }
  fightState.eHp=Math.max(0,fightState.eHp-dmg);
  fightState.pHp=Math.max(0,fightState.pHp-eDmg);
  updateFightHUD();
  fightLog(msg);
  setTimeout(()=>{pAnimState='idle';},500);
  if(fightState.eHp<=0){
    fightState.over=true;
    fightLog('üèÜ –ü–û–ë–ï–î–ê! +'+enemy.reward+'üí∞');
    gs.coins+=enemy.reward||50;
    gs.wins++;
    // –ü–í–ü —Ä–µ–π—Ç–∏–Ω–≥ –º–µ–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –ø–æ–±–µ–¥–µ –≤ –ü–í–ü-–±–æ—é
    if(fightState.isPVP && fightState.pvpOpp){
      const opp = fightState.pvpOpp;
      const kFactor = 32;
      const expected = 1/(1+Math.pow(10,(opp.rating-(gs.pvpRating||1000))/400));
      const gain = Math.round(kFactor*(1-expected));
      gs.pvpRating = (gs.pvpRating||1000) + gain;
      gs.pvpWins = (gs.pvpWins||0) + 1;
      fightLog('üåê –†–µ–π—Ç–∏–Ω–≥: +'+(gain>0?'+':'')+gain+' ‚Üí '+gs.pvpRating);
      checkQuestsProgress();
    }
    SND.win();
    updateHUD();markDirty();save();
    checkAchievements();
    setTimeout(closeFight,2000);
    return;
  }
  if(fightState.pHp<=0){
    fightState.over=true;
    // –ü–í–ü —Ä–µ–π—Ç–∏–Ω–≥ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –ø–æ—Ä–∞–∂–µ–Ω–∏–∏
    if(fightState.isPVP && fightState.pvpOpp){
      const opp = fightState.pvpOpp;
      const kFactor = 32;
      const expected = 1/(1+Math.pow(10,(opp.rating-(gs.pvpRating||1000))/400));
      const loss = Math.round(kFactor*expected);
      gs.pvpRating = Math.max(100,(gs.pvpRating||1000) - loss);
      gs.pvpLosses = (gs.pvpLosses||0) + 1;
      fightLog('üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ... –†–µ–π—Ç–∏–Ω–≥: -'+loss+' ‚Üí '+gs.pvpRating);
    } else {
      fightLog('üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ... –¢—Ä–µ–Ω–∏—Ä—É–π—Å—è –±–æ–ª—å—à–µ!');
    }
    SND.lose();
    markDirty();save();
    setTimeout(closeFight,2000);
  }
}
window.doFightAction=doFightAction;
window.fightLog=fightLog;
window.closeFight=closeFight;

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ onclick="" –≤ HTML
window.openPanel = openPanel;
window.openFight = openFight;
window.openPVP = openPVP;
window.openGuild = openGuild;
window.closeAll = closeAll;
window.closeFight = closeFight;
window.closePVP = closePVP;
window.closeGuild = closeGuild;
window.rest = rest;
window.switchTab = switchTab;
window.startPVPSearch = startPVPSearch;
window.cancelPVPSearch = cancelPVPSearch;
window.joinGuild = joinGuild;
window.createGuild = createGuild;
window.leaveGuild = leaveGuild;
window.stopTraining = stopTraining;
window._mgDoTap = _mgDoTap;

// ‚îÄ‚îÄ –¢–ê–ü–ê–ï–ú –ü–û –¢–û–õ–°–¢–Ø–ö–£ –ù–ê –ì–õ–ê–í–ù–û–ú –≠–ö–†–ê–ù–ï ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _hitCount=0,_hitTimer=null;
const HIT_REACTS=['üòñ','üò£','ü§ï','üòµ','üí•','‚≠ê','üò§','ü•ä','üí¢','üò´'];
const HIT_COINS=[0,0,0,0,0,5,0,0,0,10]; // –∫–∞–∂–¥—ã–µ 5 —Ç–∞–ø–æ–≤ –º–æ–Ω–µ—Ç–∫–∏
window.startCharHit = function(){
  // –∑–≤—É–∫
  try{getACtx();beep(200+Math.random()*100,0.12,'sawtooth',0.2);}catch(e){}
  _hitCount++;
  const emoji=document.getElementById('startCharEmoji');
  const effect=document.getElementById('startHitEffect');
  const counter=document.getElementById('startHitCount');
  if(!emoji)return;
  // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞—Ä–∞
  emoji.classList.remove('hit');
  void emoji.offsetWidth;
  emoji.classList.add('hit');
  setTimeout(()=>emoji.classList.remove('hit'),350);
  // –†–µ–∞–∫—Ü–∏—è
  const react=HIT_REACTS[_hitCount%HIT_REACTS.length];
  emoji.textContent=react==='üòµ'||react==='üí•'?'üòµ':'üê∑';
  setTimeout(()=>emoji.textContent='üê∑',400);
  // –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π
  const effects=['üí¢','‚≠ê','üí´','‚ú®','üí•'];
  effect.textContent=effects[Math.floor(Math.random()*effects.length)];
  effect.style.opacity='1';
  effect.style.transform='translateY(-'+(20+Math.random()*20)+'px)';
  setTimeout(()=>{effect.style.opacity='0';effect.style.transform='translateY(0)';},500);
  // –°—á—ë—Ç—á–∏–∫
  counter.textContent='–£–¥–∞—Ä–æ–≤: '+_hitCount+(HIT_COINS[_hitCount%10]?' +'+HIT_COINS[_hitCount%10]+'üí∞':'');
  counter.style.color=_hitCount>20?'var(--gold)':_hitCount>10?'var(--pink)':'#666';
  if(_hitTimer)clearTimeout(_hitTimer);
  _hitTimer=setTimeout(()=>{_hitCount=0;if(counter)counter.textContent='';},3000);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ì–õ–û–ë–ê–õ–¨–ù–´–ô –§–ò–ö–° –°–û–ë–´–¢–ò–ô –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–•
// –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É: –∫–Ω–æ–ø–∫–∏ –≤ –±–æ—é, –≥–∏–ª—å–¥–∏–∏ –∏ –ü–í–ü –Ω–µ –Ω–∞–∂–∏–º–∞—é—Ç—Å—è
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function fixMobileEvents(){
  const interactiveSelectors = [
    '#fightScreen','#pvpScreen','#guildScreen',
    '#rebirthScreen','#dailyPopup','#timeToast',
    '#bottomNav','#overlay','.panel','#miniGame'
  ];
  
  function applyFix(){
    interactiveSelectors.forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>{
        el.style.pointerEvents='all';
        el.style.touchAction='manipulation';
        el.querySelectorAll('button,a,[onclick]').forEach(btn=>{
          btn.style.pointerEvents='all';
          btn.style.touchAction='manipulation';
        });
      });
    });
  }

  document.addEventListener('DOMContentLoaded', applyFix);
  applyFix();

  const observer = new MutationObserver(function(mutations){
    mutations.forEach(function(m){
      if(m.type==='attributes' && (m.attributeName==='class'||m.attributeName==='style')){
        applyFix();
      }
    });
  });
  
  // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ —ç–∫—Ä–∞–Ω–∞–º–∏ –±–æ—è, –ü–í–ü –∏ –≥–∏–ª—å–¥–∏–∏
  ['fightScreen','pvpScreen','guildScreen','rebirthScreen','dailyPopup'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) observer.observe(el,{attributes:true});
  });
})();


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// v4.0 NEW FEATURES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ SETTINGS (–∑–≤—É–∫ –≤–∫–ª/–≤—ã–∫–ª) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openSettings = function(){
  closeAll();
  renderSettings();
  document.getElementById('settingsPanel').classList.add('open');
  document.getElementById('overlay').classList.add('open');
};
window.toggleSound = function(){
  gs.soundEnabled = !gs.soundEnabled;
  if(typeof markDirty==='function') markDirty();
  if(typeof save==='function') save();
  if(typeof renderSettings==='function') renderSettings();
};
window.toggleMusic = function(){
  _musicEnabled = !_musicEnabled;
  gs.musicEnabled = _musicEnabled;
  if(_musicEnabled){ startBgMusic(); }else{ stopBgMusic(); }
  if(typeof markDirty==='function') markDirty();
  if(typeof save==='function') save();
  renderSettings();
};
function renderSettings(){
  const c = document.getElementById('settingsContent');
  if(!c) return;
  const on = gs.soundEnabled !== false;
  const music = _musicEnabled !== false;
  c.innerHTML = `
    <div style="background:var(--card);border:1.5px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-weight:900;font-size:14px;margin-bottom:3px;">üîä –ó–≤—É–∫–∏</div>
          <div style="font-size:10px;color:#666;">–ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</div>
        </div>
        <button onclick="toggleSound()" style="background:${on?'linear-gradient(135deg,var(--green),#00cc66)':'rgba(255,255,255,0.08)'};border:2px solid ${on?'var(--green)':'var(--border)'};border-radius:99px;padding:8px 20px;color:${on?'#000':'#666'};font-weight:900;font-size:13px;cursor:pointer;">${on?'–í–ö–õ ‚úì':'–í–´–ö–õ'}</button>
      </div>
    </div>
    <div style="background:var(--card);border:1.5px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-weight:900;font-size:14px;margin-bottom:3px;">üéµ –ú—É–∑—ã–∫–∞</div>
          <div style="font-size:10px;color:#666;">–§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞</div>
        </div>
        <button onclick="toggleMusic()" style="background:${music?'linear-gradient(135deg,#a855f7,#ec4899)':'rgba(255,255,255,0.08)'};border:2px solid ${music?'#a855f7':'var(--border)'};border-radius:99px;padding:8px 20px;color:${music?'#fff':'#666'};font-weight:900;font-size:13px;cursor:pointer;">${music?'–í–ö–õ ‚úì':'–í–´–ö–õ'}</button>
      </div>
    </div>
    <div style="background:var(--card);border:1.5px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;">
      <div style="font-weight:900;font-size:13px;margin-bottom:8px;">üì± –û –∏–≥—Ä–µ</div>
      <div style="font-size:11px;color:#666;line-height:1.8;">
        üéÆ –¢–û–õ–°–¢–Ø–ö 4.0 ‚Äî –ü—É—Ç—å –∫ –ø–æ–±–µ–¥–µ!<br>
        üì¶ –í–µ—Ä—Å–∏—è: 4.0.1 (10002)<br>
        üë®‚Äçüíª –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: My Company<br>
        üè™ RuStore Edition<br>
        üîí –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ<br>
        üì° –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
      </div>
      <button onclick="if(confirm('–°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥?')){gs.pvpRating=1200;gs.pvpWins=0;gs.pvpLosses=0;updateHUD();save();closeAll();notify('–†–µ–π—Ç–∏–Ω–≥ —Å–±—Ä–æ—à–µ–Ω');}" style="margin-top:8px;width:100%;background:rgba(0,229,255,0.1);border:1px solid rgba(0,229,255,0.3);border-radius:10px;padding:8px;color:#00e5ff;font-size:11px;font-weight:700;cursor:pointer;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥</button>
    </div>
    <div style="background:rgba(255,61,127,0.08);border:1.5px solid rgba(255,61,127,0.2);border-radius:14px;padding:14px;">
      <div style="font-weight:900;font-size:13px;color:var(--pink);margin-bottom:6px;">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
      <div style="font-size:10px;color:#666;margin-bottom:10px;">–£–¥–∞–ª–∏—Ç –≤—Å—ë —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!</div>
      <button onclick="if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')){localStorage.clear();location.reload();}" style="background:rgba(255,61,127,0.2);border:1.5px solid var(--pink);border-radius:10px;padding:10px 18px;color:var(--pink);font-weight:900;font-size:12px;cursor:pointer;width:100%;">‚ö†Ô∏è –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
    </div>
  `;
}

// ‚îÄ‚îÄ FOOD SYSTEM (—Å–∏—Å—Ç–µ–º–∞ –ø–∏—Ç–∞–Ω–∏—è) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FOODS = [
  {id:'apple',  icon:'üçé',name:'–Ø–±–ª–æ–∫–æ',        price:15,  effect:'‚ö° +15 —ç–Ω–µ—Ä–≥–∏–∏',       fn:g=>{g.energy=Math.min(g.energy+15, g.maxEnergy||100);}},
  {id:'banana', icon:'üçå',name:'–ë–∞–Ω–∞–Ω',          price:25,  effect:'‚ö° +25 —ç–Ω–µ—Ä–≥–∏–∏',       fn:g=>{g.energy=Math.min(g.energy+25, g.maxEnergy||100);}},
  {id:'energy', icon:'‚ö°',name:'–≠–Ω–µ—Ä–≥–æ—Ç–æ–Ω–∏–∫',    price:50,  effect:'üîã –ü–æ–ª–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è!',   fn:g=>{g.energy=g.maxEnergy||100;}},
  {id:'salad',  icon:'ü•ó',name:'–°–∞–ª–∞—Ç',          price:40,  effect:'‚öñÔ∏è -3–∫–≥ –≤–µ—Å–∞',        fn:g=>{g.weight=Math.max(g.weight-3,g.minWeight||60);}},
  {id:'chicken',icon:'üçó',name:'–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ',   price:80,  effect:'üí™ +6 —Å–∏–ª—ã ‚ö° +30',    fn:g=>{g.strength+=6;g.energy=Math.min(g.energy+30,g.maxEnergy||100);}},
  {id:'steak',  icon:'ü•©',name:'–°—Ç–µ–π–∫',          price:130, effect:'üí™ +8 —Å–∏–ª—ã ‚ö° +40',    fn:g=>{g.strength+=8;g.energy=Math.min(g.energy+40,g.maxEnergy||100);}},
  {id:'burger', icon:'üçî',name:'–ë—É—Ä–≥–µ—Ä',         price:50,  effect:'‚öñÔ∏è +2–∫–≥ ‚ö° +20',      fn:g=>{g.weight=Math.min(g.weight+2,g.maxWeight||230);g.energy=Math.min(g.energy+20,g.maxEnergy||100);}},
  {id:'sushi',  icon:'üç±',name:'–°—É—à–∏-—Å–µ—Ç',       price:200, effect:'üí™ +10 ‚ö° +50 ‚öñÔ∏è-1–∫–≥', fn:g=>{g.strength+=10;g.energy=Math.min(g.energy+50,g.maxEnergy||100);g.weight=Math.max(g.weight-1,g.minWeight||60);}},
];
window.openFood = function(){
  closeAll();
  renderFood();
  document.getElementById('foodPanel').classList.add('open');
  document.getElementById('overlay').classList.add('open');
};
function renderFood(){
  const c = document.getElementById('foodList');
  if(!c) return;
  c.innerHTML = FOODS.map(f=>`
    <div style="background:var(--card);border:1.5px solid var(--border);border-radius:14px;padding:13px;margin-bottom:10px;display:flex;align-items:center;gap:12px;">
      <div style="font-size:32px;width:42px;text-align:center;">${f.icon}</div>
      <div style="flex:1;">
        <div style="font-weight:900;font-size:13px;margin-bottom:2px;">${f.name}</div>
        <div style="font-size:10px;color:#888;margin-bottom:5px;">${f.effect}</div>
        <div style="font-size:11px;color:var(--gold);">üí∞ ${f.price} –º–æ–Ω–µ—Ç</div>
      </div>
      <button onclick="buyFood('${f.id}')" style="background:linear-gradient(135deg,var(--pink),var(--purple));border:none;border-radius:12px;padding:10px 16px;color:#fff;font-weight:900;font-size:12px;cursor:pointer;">–ö—É–ø–∏—Ç—å</button>
    </div>
  `).join('');
}
window.buyFood = function(id){
  const f = FOODS.find(x=>x.id===id);
  if(!f || !gs) return;
  if(gs.coins < f.price){ notify('‚ùå –ú–∞–ª–æ –º–æ–Ω–µ—Ç!'); return; }
  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —ç–Ω–µ—Ä–≥–∏—é –î–û –≤—ã–∑–æ–≤–∞ fn
  if(!gs.maxEnergy || isNaN(gs.maxEnergy) || gs.maxEnergy < 1) gs.maxEnergy = 100;
  if(isNaN(gs.energy) || gs.energy < 0) gs.energy = 0;
  if(gs.energy > gs.maxEnergy) gs.energy = gs.maxEnergy;
  const eBefore = gs.energy;
  gs.coins -= f.price;
  f.fn(gs);
  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–æ—Å–ª–µ fn
  if(!gs.maxEnergy || isNaN(gs.maxEnergy) || gs.maxEnergy < 1) gs.maxEnergy = 100;
  if(isNaN(gs.energy) || gs.energy < 0) gs.energy = 0;
  if(gs.energy > gs.maxEnergy) gs.energy = gs.maxEnergy;
  SND.eat();
  updateHUD();
  markDirty(); save();
  renderFood();
  const gained = Math.round(gs.energy - eBefore);
  notify(gained > 0 ? f.icon+' '+f.name+'! ‚ö°+'+gained+' —ç–Ω–µ—Ä–≥–∏–∏!' : f.icon+' '+f.name+'! '+f.effect);
};

// ‚îÄ‚îÄ QUESTS (—Å–∏—Å—Ç–µ–º–∞ –∫–≤–µ—Å—Ç–æ–≤) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const QUESTS = [
  // === –¢–†–ï–ù–ò–†–û–í–ö–ò ===
  {id:'q_train5',   name:'–†–∞–∑–º–∏–Ω–∫–∞',       desc:'–°–¥–µ–ª–∞–π 5 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',            target:5,   stat:'trainCount', reward:100,  icon:'üéØ', cat:'train'},
  {id:'q_train10',  name:'–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏',    desc:'–°–¥–µ–ª–∞–π 10 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',           target:10,  stat:'trainCount', reward:200,  icon:'üí™', cat:'train'},
  {id:'q_train30',  name:'–§–∞–Ω–∞—Ç –∑–∞–ª–∞',     desc:'–°–¥–µ–ª–∞–π 30 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',           target:30,  stat:'trainCount', reward:400,  icon:'üèãÔ∏è', cat:'train'},
  {id:'q_train50',  name:'–£–ø–æ—Ä–Ω—ã–π',        desc:'–°–¥–µ–ª–∞–π 50 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',           target:50,  stat:'trainCount', reward:500,  icon:'üî•', cat:'train'},
  {id:'q_train100', name:'–ñ–µ–ª–µ–∑–Ω–∞—è –≤–æ–ª—è',  desc:'–°–¥–µ–ª–∞–π 100 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',          target:100, stat:'trainCount', reward:1000, icon:'‚ö°', cat:'train'},
  {id:'q_train200', name:'–ú–æ–Ω—Å—Ç—Ä –∑–∞–ª–∞',    desc:'–°–¥–µ–ª–∞–π 200 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',          target:200, stat:'trainCount', reward:2000, icon:'ü¶æ', cat:'train'},
  // === –ë–û–ò ===
  {id:'q_win1',     name:'–î–µ–±—é—Ç',          desc:'–í—ã–∏–≥—Ä–∞–π –ø–µ—Ä–≤—ã–π –±–æ–π',             target:1,   stat:'wins',       reward:150,  icon:'ü•ä', cat:'fight'},
  {id:'q_win5',     name:'–ü–æ–±–µ–¥–∏—Ç–µ–ª—å',     desc:'–í—ã–∏–≥—Ä–∞–π 5 –±–æ—ë–≤',                 target:5,   stat:'wins',       reward:300,  icon:'üèÜ', cat:'fight'},
  {id:'q_win10',    name:'–í–µ—Ç–µ—Ä–∞–Ω',        desc:'–í—ã–∏–≥—Ä–∞–π 10 –±–æ—ë–≤',                target:10,  stat:'wins',       reward:500,  icon:'üéñÔ∏è', cat:'fight'},
  {id:'q_win20',    name:'–ë–æ–µ—Ü',           desc:'–í—ã–∏–≥—Ä–∞–π 20 –±–æ—ë–≤',                target:20,  stat:'wins',       reward:800,  icon:'üí•', cat:'fight'},
  {id:'q_win30',    name:'–ß–µ–º–ø–∏–æ–Ω –∞—Ä–µ–Ω—ã',  desc:'–ü–æ–±–µ–¥–∏ –≤—Å–µ—Ö 30 —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤',      target:30,  stat:'wins',       reward:2000, icon:'üëë', cat:'fight'},
  // === –í–ï–° ===
  {id:'q_weight150',name:'–ù–∞—á–∞–ª–æ –ø—É—Ç–∏',    desc:'–°–±—Ä–æ—Å—å –≤–µ—Å –¥–æ 150 –∫–≥',           target:80,  stat:'weightDown', reward:200,  icon:'‚öñÔ∏è', cat:'weight'},
  {id:'q_weight100',name:'–ù–∞ –ø—É—Ç–∏ –∫ —Ü–µ–ª–∏', desc:'–°–±—Ä–æ—Å—å –≤–µ—Å –¥–æ 100 –∫–≥',           target:130, stat:'weightDown', reward:400,  icon:'üìâ', cat:'weight'},
  {id:'q_weight80', name:'–ü–æ—á—Ç–∏ –∞—Ç–ª–µ—Ç',    desc:'–°–±—Ä–æ—Å—å –≤–µ—Å –¥–æ 80 –∫–≥',            target:150, stat:'weightDown', reward:700,  icon:'üèÉ', cat:'weight'},
  {id:'q_weight60', name:'–ò–¥–µ–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞',desc:'–î–æ—Å—Ç–∏–≥–Ω–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –≤–µ—Å–∞',     target:170, stat:'weightDown', reward:1500, icon:'üåü', cat:'weight'},
  // === –ú–û–ù–ï–¢–´ ===
  {id:'q_coins200', name:'–ö–æ–ø–∏–ª–∫–∞',        desc:'–ù–∞–∫–æ–ø–∏ 200 –º–æ–Ω–µ—Ç',               target:200, stat:'coins',      reward:100,  icon:'üíµ', cat:'coins'},
  {id:'q_coins500', name:'–ë–æ–≥–∞—Ç–µ–π',        desc:'–ù–∞–∫–æ–ø–∏ 500 –º–æ–Ω–µ—Ç',               target:500, stat:'coins',      reward:200,  icon:'üí∞', cat:'coins'},
  {id:'q_coins2000',name:'–ò–Ω–≤–µ—Å—Ç–æ—Ä',       desc:'–ù–∞–∫–æ–ø–∏ 2000 –º–æ–Ω–µ—Ç',              target:2000,stat:'coins',      reward:500,  icon:'ü§ë', cat:'coins'},
  // === –ü–ï–†–ï–†–û–ñ–î–ï–ù–ò–Ø ===
  {id:'q_rebirth1', name:'–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ',   desc:'–ü–µ—Ä–µ—Ä–æ–¥–∏—Å—å 1 —Ä–∞–∑',               target:1,   stat:'rebirth',    reward:1000, icon:'üîÑ', cat:'rebirth'},
  {id:'q_rebirth5', name:'–ú–Ω–æ–≥–æ–∂–∏–∑–Ω–µ–Ω–Ω—ã–π', desc:'–ü–µ—Ä–µ—Ä–æ–¥–∏—Å—å 5 —Ä–∞–∑',               target:5,   stat:'rebirth',    reward:3000, icon:'‚ôæÔ∏è', cat:'rebirth'},
];
window.openQuests = function(){
  closeAll();
  renderQuests('fight');
  document.getElementById('questsPanel').classList.add('open');
  document.getElementById('overlay').classList.add('open');
};
let _questTab = 'fight';
function renderQuests(tab){
  if(tab) _questTab = tab;
  const c = document.getElementById('questsList');
  if(!c || typeof gs==='undefined') return;
  const done = gs.questsDone || [];
  const cats = [
    {id:'fight',  label:'–ë–æ–∏ ü•ä', col:'#ff3d7f'},
    {id:'train',  label:'–ó–∞–ª üèãÔ∏è', col:'#a855f7'},
    {id:'weight', label:'–í–µ—Å ‚öñÔ∏è', col:'#00ff88'},
    {id:'coins',  label:'üí∞', col:'#ffd700'},
    {id:'rebirth',label:'–†–± üîÑ', col:'#ff6b00'},
    {id:'all',    label:'–í—Å–µ', col:'#888'},
  ];
  const tabHtml = `<div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px;">
    ${cats.map(cat=>`<button onclick="renderQuests('${cat.id}')" style="padding:5px 10px;background:${_questTab===cat.id?'linear-gradient(135deg,'+cat.col+'44,'+cat.col+'22)':'rgba(255,255,255,0.05)'};border:1.5px solid ${_questTab===cat.id?cat.col:'rgba(255,255,255,0.1)'};border-radius:99px;color:${_questTab===cat.id?cat.col:'#555'};font-size:10px;font-weight:700;cursor:pointer;">${cat.label}</button>`).join('')}
  </div>`;
  const filtered = _questTab==='all' ? QUESTS : QUESTS.filter(q=>q.cat===_questTab);
  const total = filtered.length;
  const doneCount = filtered.filter(q=>done.includes(q.id)).length;
  const questsHtml = filtered.map(q=>{
    const isDone = done.includes(q.id);
    let val = 0;
    if(q.stat==='trainCount') val = gs.trainCount||0;
    else if(q.stat==='wins') val = gs.wins||0;
    else if(q.stat==='rebirth') val = gs.rebirth||0;
    else if(q.stat==='pvpWins') val = gs.pvpWins||0;
    else if(q.stat==='pvpRating') val = gs.pvpRating||1000;
    else if(q.stat==='coins') val = gs.coins||0;
    else if(q.stat==='weightDown') val = Math.max(0, (gs.maxWeight||230) - (gs.weight||230));
    else if(q.stat==='challengeAccepted') val = gs.challengeAccepted||0;
    else if(q.stat==='challengesSent') val = gs.challengesSent||0;
    const prog = Math.min(val, q.target);
    const pct = Math.round(prog/q.target*100);
    const canClaim = !isDone && prog >= q.target;
    const barColor = q.cat==='pvp' ? 'linear-gradient(90deg,#00e5ff,#0066ff)' :
      q.cat==='fight' ? 'linear-gradient(90deg,var(--pink),var(--red))' :
      q.cat==='train' ? 'linear-gradient(90deg,var(--purple),#a855f7)' :
      'linear-gradient(90deg,var(--green),#00cc66)';
    return `
      <div style="background:${isDone?'rgba(0,255,136,0.05)':'rgba(255,255,255,0.03)'};border:1.5px solid ${isDone?'rgba(0,255,136,0.25)':canClaim?'rgba(255,215,0,0.5)':'rgba(255,255,255,0.08)'};border-radius:12px;padding:11px;margin-bottom:8px;${canClaim?'box-shadow:0 0 12px rgba(255,215,0,0.15);':''}">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
          <div style="font-size:22px;">${q.icon}</div>
          <div style="flex:1;">
            <div style="font-weight:900;font-size:12px;">${q.name}${isDone?' ‚úì':''}</div>
            <div style="font-size:9px;color:#555;">${q.desc}</div>
          </div>
          <div style="font-size:11px;color:var(--gold);font-weight:700;">+${q.reward}üí∞</div>
        </div>
        <div style="background:rgba(255,255,255,0.06);border-radius:99px;height:5px;overflow:hidden;margin-bottom:5px;">
          <div style="width:${pct}%;height:100%;background:${barColor};border-radius:99px;transition:width 0.3s;"></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-size:9px;color:#444;">${prog}/${q.target}</div>
          ${canClaim?`<button onclick="claimQuest('${q.id}')" style="background:linear-gradient(135deg,var(--gold),#ff8c00);border:none;border-radius:8px;padding:5px 12px;color:#000;font-weight:900;font-size:10px;cursor:pointer;animation:glw1 1.5s infinite;">üéÅ –ó–∞–±—Ä–∞—Ç—å!</button>`:''}
          ${isDone?`<div style="font-size:9px;color:var(--green);">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>`:''}
        </div>
      </div>
    `;
  }).join('');
  c.innerHTML = tabHtml +
    `<div style="font-size:10px;color:#444;margin-bottom:6px;">‚úÖ ${doneCount}/${total} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>` +
    questsHtml;
}
window.claimQuest = function(id){
  const q = QUESTS.find(x=>x.id===id);
  if(!q || typeof gs==='undefined') return;
  if(!gs.questsDone) gs.questsDone = [];
  if(gs.questsDone.includes(id)) return;
  gs.questsDone.push(id);
  gs.coins += q.reward;
  if(typeof updateHUD==='function') updateHUD();
  if(typeof markDirty==='function') markDirty();
  if(typeof save==='function') save();
  renderQuests(_questTab);
  if(typeof notify==='function') notify('üéâ –ö–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω! +'+q.reward+' –º–æ–Ω–µ—Ç!');
  checkAchievements();
};

// ‚îÄ‚îÄ WEEKLY TOURNAMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openTournament = function(){
  closeAll();
  renderTournament();
  document.getElementById('tournamentPanel').classList.add('open');
  document.getElementById('overlay').classList.add('open');
};
function renderTournament(){
  const c = document.getElementById('tournamentContent');
  if(!c || typeof gs==='undefined') return;
  const now = Date.now();
  const weekMs = 7*24*60*60*1000;
  const weekStart = Math.floor(now/weekMs)*weekMs;
  const weekEnd = weekStart + weekMs;
  const timeLeft = weekEnd - now;
  const days = Math.floor(timeLeft/(24*3600*1000));
  const hrs = Math.floor((timeLeft%(24*3600*1000))/3600000);
  const lastClaim = gs.tournamentClaimed || 0;
  const alreadyClaimed = lastClaim >= weekStart;
  const rating = gs.pvpRating || 1000;
  let tier, tierColor, tierReward;
  if(rating>=1600){tier='üèÜ –õ–µ–≥–µ–Ω–¥–∞';tierColor='var(--gold)';tierReward=2000;}
  else if(rating>=1400){tier='üíé –ú–∞—Å—Ç–µ—Ä';tierColor='#00e5ff';tierReward=1000;}
  else if(rating>=1200){tier='ü•á –ó–æ–ª–æ—Ç–æ';tierColor='var(--gold)';tierReward=500;}
  else if(rating>=1050){tier='ü•à –°–µ—Ä–µ–±—Ä–æ';tierColor='#aaa';tierReward=250;}
  else{tier='ü•â –ë—Ä–æ–Ω–∑–∞';tierColor='#cd7f32';tierReward=100;}

  c.innerHTML = `
    <div style="text-align:center;margin-bottom:16px;">
      <div style="font-size:48px;margin-bottom:6px;">üèÜ</div>
      <div style="font-family:'Russo One',sans-serif;font-size:18px;color:var(--gold);">–ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–´–ô –¢–£–†–ù–ò–†</div>
      <div style="font-size:11px;color:#555;margin-top:4px;">–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é</div>
    </div>
    <div style="background:var(--card);border:1.5px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px;text-align:center;">
      <div style="font-size:10px;color:#555;margin-bottom:4px;">–û—Å—Ç–∞–ª–æ—Å—å –¥–æ –∫–æ–Ω—Ü–∞</div>
      <div style="font-family:'Russo One',sans-serif;font-size:20px;color:var(--cyan);">${days}–¥ ${hrs}—á</div>
    </div>
    <div style="background:var(--card);border:2px solid ${tierColor};border-radius:14px;padding:16px;margin-bottom:12px;">
      <div style="font-size:11px;color:#666;margin-bottom:4px;">–í–∞—à —Ä–∞–Ω–≥</div>
      <div style="font-size:22px;font-weight:900;color:${tierColor};margin-bottom:4px;">${tier}</div>
      <div style="font-size:11px;color:#888;">–†–µ–π—Ç–∏–Ω–≥: ${rating} | –ù–∞–≥—Ä–∞–¥–∞: üí∞${tierReward}</div>
    </div>
    <div style="background:rgba(255,215,0,0.07);border:1.5px solid rgba(255,215,0,0.2);border-radius:14px;padding:14px;margin-bottom:12px;">
      <div style="font-weight:900;margin-bottom:8px;">üìä –¢–∞–±–ª–∏—Ü–∞ –ª–∏–≥</div>
      <div style="font-size:11px;color:#888;line-height:2;">
        üèÜ –õ–µ–≥–µ–Ω–¥–∞  (1600+) ‚Üí üí∞2000<br>
        üíé –ú–∞—Å—Ç–µ—Ä   (1400+) ‚Üí üí∞1000<br>
        ü•á –ó–æ–ª–æ—Ç–æ   (1200+) ‚Üí üí∞500<br>
        ü•à –°–µ—Ä–µ–±—Ä–æ  (1050+) ‚Üí üí∞250<br>
        ü•â –ë—Ä–æ–Ω–∑–∞   (0+)    ‚Üí üí∞100
      </div>
    </div>
    ${!alreadyClaimed?`<button onclick="claimTournament()" style="width:100%;background:linear-gradient(135deg,var(--gold),#ff8c00);border:none;border-radius:14px;padding:16px;color:#000;font-family:'Russo One',sans-serif;font-size:16px;cursor:pointer;">üéÅ –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É!</button>`
    :`<div style="text-align:center;padding:14px;background:rgba(0,255,136,0.07);border:1.5px solid rgba(0,255,136,0.2);border-radius:14px;color:var(--green);font-weight:900;">‚úÖ –£–∂–µ –ø–æ–ª—É—á–µ–Ω–æ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ!</div>`}
  `;
}
window.claimTournament = function(){
  if(typeof gs==='undefined') return;
  const now = Date.now();
  gs.tournamentClaimed = now;
  const rating = gs.pvpRating||1000;
  let reward = 100;
  if(rating>=1600) reward=2000;
  else if(rating>=1400) reward=1000;
  else if(rating>=1200) reward=500;
  else if(rating>=1050) reward=250;
  gs.coins += reward;
  if(typeof updateHUD==='function') updateHUD();
  if(typeof markDirty==='function') markDirty();
  if(typeof save==='function') save();
  renderTournament();
  if(typeof notify==='function') notify('üèÜ –ù–∞–≥—Ä–∞–¥–∞ —Ç—É—Ä–Ω–∏—Ä–∞! +'+reward+' –º–æ–Ω–µ—Ç!');
};



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –≠–ö–°–ü–û–†–¢ –§–£–ù–ö–¶–ò–ô (–¥–ª—è onclick –≤ HTML)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openPanel=openPanel;
window.openFight=openFight;
window.openPVP=openPVP;
window.openGuild=openGuild;
window.closeAll=closeAll;
window.closeFight=closeFight;
window.closePVP=closePVP;
window.closeGuild=closeGuild;
window.rest=rest;
window.switchTab=switchTab;
window.startMG=startMG;
window.stopTraining=stopTraining;
window.startPVPSearch=startPVPSearch;
window.cancelPVPSearch=cancelPVPSearch;
window.joinGuild=joinGuild;
window.createGuild=createGuild;
window.leaveGuild=leaveGuild;
window.claimDaily=claimDaily_inner;
window.closeDailyPopup=closeDailyPopup_inner;
window.collectTimeReward=collectTimeReward_inner;



</script>
</body>
</html>